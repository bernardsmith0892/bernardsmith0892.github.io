<!DOCTYPE html>



<html lang="en-US" 
  
    mode="dark"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Hack-A-Sat 2: tree in the forest" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="tree in the forest (Rapid Unplanned Disassembly) Upon connecting to the challenge and providing our ticket, we’re presented with a simple message. 1 Starting up Service on udp:18.222.149.188:12752 We can connect to this server using nc -u 18.222.149.188 12752 and see what the challenge looks like. After experimenting with a bit of random input, we can quickly see that the server is expecting 8 bytes of input. 1 2 3 4 5 6 7 8 9 $ nc -u 18.222.149.188 12752 555555 Invalid length of command header, expected 8 but got 7 5555555 Command header acknowledge: version:13621 type:13621 id:171259189 Invalid id:171259189 55555555 Command header acknowledge: version:13621 type:13621 id:892679477 Invalid id:892679477 The challenge page provides us with the source code (parser.c) for this server, which easily illuminates what’s going on. The server is expecting us to provide a command_header struct composed of three values: A 16-bit integer for the version of the command. Not used within the program. A 16-bit integer for the type of the command. Not used within the program. A 32-bit integer for the ID of the command. This is the only value used by the program. Valid IDs are defined within the command_id_type enum. Looking through the possible IDs, the most interesting one is COMMAND_GETKEYS with an ID of 9. This command is what will order the server to print out the flag. However, the server has locked down this functionality on startup using a variable lock_state initialized to LOCKED - a value of 1. Until we can set this variable to 0, the server will refuse to print out the flag. After analyzing the source code for this server, we discover the vulnerable portion of this code on line 134, which is: 1 2 // Log the message in the command log command_log[header-&gt;id]++; Under normal operations, this array is simply used to track how many times a certain command ID has been received. For instance, to see how many times COMMAND_GETKEYS has been issued, we would access command_log[9]. What makes this exploitable is that C and C++ do not perform bounds-checking by default when accessing an array. In addition, we have full control over what ID is sent to this line of code. So by providing a value outside the bounds of this array, such as negative values, we can modify any memory throughout the program. Our goal is to determine how many bytes before or after command_log is lock_state located. By knowing this, we will be able to determine the correct ID to use in order to modify the lock_state value. To assist in our analysis, we can compile the provided source code using g++ and debug it using gdb. But before doing this, we uncomment lines 157 and 158 to display the memory addresses for lock_state and command_log when we run the program. 1 2 3 4 5 6 7 $ g++ parser.c $ ./a.out Address of lock_state: 0x56070625c130 Address of command_log: 0x56070625c138 Trying to bind to socket. Bound to socket. Looking at this, we can see that lock_state is only 8 bytes behind command_log. So by sending an ID value of -8, we will be able to increment the lock_state variable by 1 on every command. The issue right now is that we can only increase the value of lock_state. Since lock_state starts at 1, we will need to overflow this byte in order to reach our desired value of 0. Thankfully, command_log is defined as an array of char values, so its max value is only 255. One thing to note is that until now, we’ve only been directly typing input for the server into a nc session. However, since the server only looks at the underlying bytes it receives, it’ll interpret our “-8” as 0x382d0000. So to send a properly formatted payload, we will need to create a simple Python script to construct our message at the byte-level and send it to the server. This is a very simple task using pwntools. 1 2 3 4 5 6 from pwn import * io = remote(&#39;0.0.0.0&#39;, 54321, typ=&#39;udp&#39;) io.send( p16(1) + p16(1) + p32(-8, sign=&#39;signed&#39;) ) print(io.recvline()) print(io.recvline()) Using this script, we can validate the exploitation method by examining the server’s memory with gdb. In the following demo, we send the malicious command_header a few times to demonstrate how we’re able to increment the lock_state variable. The next demo shows how the value overflows after 255 commands. Finally, we can send our GETKEYS command and retrieve the flag from the server. The following demo shows us running the final exploit script (forest.py):" />
<meta property="og:description" content="tree in the forest (Rapid Unplanned Disassembly) Upon connecting to the challenge and providing our ticket, we’re presented with a simple message. 1 Starting up Service on udp:18.222.149.188:12752 We can connect to this server using nc -u 18.222.149.188 12752 and see what the challenge looks like. After experimenting with a bit of random input, we can quickly see that the server is expecting 8 bytes of input. 1 2 3 4 5 6 7 8 9 $ nc -u 18.222.149.188 12752 555555 Invalid length of command header, expected 8 but got 7 5555555 Command header acknowledge: version:13621 type:13621 id:171259189 Invalid id:171259189 55555555 Command header acknowledge: version:13621 type:13621 id:892679477 Invalid id:892679477 The challenge page provides us with the source code (parser.c) for this server, which easily illuminates what’s going on. The server is expecting us to provide a command_header struct composed of three values: A 16-bit integer for the version of the command. Not used within the program. A 16-bit integer for the type of the command. Not used within the program. A 32-bit integer for the ID of the command. This is the only value used by the program. Valid IDs are defined within the command_id_type enum. Looking through the possible IDs, the most interesting one is COMMAND_GETKEYS with an ID of 9. This command is what will order the server to print out the flag. However, the server has locked down this functionality on startup using a variable lock_state initialized to LOCKED - a value of 1. Until we can set this variable to 0, the server will refuse to print out the flag. After analyzing the source code for this server, we discover the vulnerable portion of this code on line 134, which is: 1 2 // Log the message in the command log command_log[header-&gt;id]++; Under normal operations, this array is simply used to track how many times a certain command ID has been received. For instance, to see how many times COMMAND_GETKEYS has been issued, we would access command_log[9]. What makes this exploitable is that C and C++ do not perform bounds-checking by default when accessing an array. In addition, we have full control over what ID is sent to this line of code. So by providing a value outside the bounds of this array, such as negative values, we can modify any memory throughout the program. Our goal is to determine how many bytes before or after command_log is lock_state located. By knowing this, we will be able to determine the correct ID to use in order to modify the lock_state value. To assist in our analysis, we can compile the provided source code using g++ and debug it using gdb. But before doing this, we uncomment lines 157 and 158 to display the memory addresses for lock_state and command_log when we run the program. 1 2 3 4 5 6 7 $ g++ parser.c $ ./a.out Address of lock_state: 0x56070625c130 Address of command_log: 0x56070625c138 Trying to bind to socket. Bound to socket. Looking at this, we can see that lock_state is only 8 bytes behind command_log. So by sending an ID value of -8, we will be able to increment the lock_state variable by 1 on every command. The issue right now is that we can only increase the value of lock_state. Since lock_state starts at 1, we will need to overflow this byte in order to reach our desired value of 0. Thankfully, command_log is defined as an array of char values, so its max value is only 255. One thing to note is that until now, we’ve only been directly typing input for the server into a nc session. However, since the server only looks at the underlying bytes it receives, it’ll interpret our “-8” as 0x382d0000. So to send a properly formatted payload, we will need to create a simple Python script to construct our message at the byte-level and send it to the server. This is a very simple task using pwntools. 1 2 3 4 5 6 from pwn import * io = remote(&#39;0.0.0.0&#39;, 54321, typ=&#39;udp&#39;) io.send( p16(1) + p16(1) + p32(-8, sign=&#39;signed&#39;) ) print(io.recvline()) print(io.recvline()) Using this script, we can validate the exploitation method by examining the server’s memory with gdb. In the following demo, we send the malicious command_header a few times to demonstrate how we’re able to increment the lock_state variable. The next demo shows how the value overflows after 255 commands. Finally, we can send our GETKEYS command and retrieve the flag from the server. The following demo shows us running the final exploit script (forest.py):" />
<link rel="canonical" href="https://bernardsmith0892.github.io/posts/hackasat2-forest/" />
<meta property="og:url" content="https://bernardsmith0892.github.io/posts/hackasat2-forest/" />
<meta property="og:site_name" content="Bernard Smith" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-29T22:00:00-10:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hack-A-Sat 2: tree in the forest" />
<meta name="twitter:site" content="@BernardSmith892" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"description":"tree in the forest (Rapid Unplanned Disassembly) Upon connecting to the challenge and providing our ticket, we’re presented with a simple message. 1 Starting up Service on udp:18.222.149.188:12752 We can connect to this server using nc -u 18.222.149.188 12752 and see what the challenge looks like. After experimenting with a bit of random input, we can quickly see that the server is expecting 8 bytes of input. 1 2 3 4 5 6 7 8 9 $ nc -u 18.222.149.188 12752 555555 Invalid length of command header, expected 8 but got 7 5555555 Command header acknowledge: version:13621 type:13621 id:171259189 Invalid id:171259189 55555555 Command header acknowledge: version:13621 type:13621 id:892679477 Invalid id:892679477 The challenge page provides us with the source code (parser.c) for this server, which easily illuminates what’s going on. The server is expecting us to provide a command_header struct composed of three values: A 16-bit integer for the version of the command. Not used within the program. A 16-bit integer for the type of the command. Not used within the program. A 32-bit integer for the ID of the command. This is the only value used by the program. Valid IDs are defined within the command_id_type enum. Looking through the possible IDs, the most interesting one is COMMAND_GETKEYS with an ID of 9. This command is what will order the server to print out the flag. However, the server has locked down this functionality on startup using a variable lock_state initialized to LOCKED - a value of 1. Until we can set this variable to 0, the server will refuse to print out the flag. After analyzing the source code for this server, we discover the vulnerable portion of this code on line 134, which is: 1 2 // Log the message in the command log command_log[header-&gt;id]++; Under normal operations, this array is simply used to track how many times a certain command ID has been received. For instance, to see how many times COMMAND_GETKEYS has been issued, we would access command_log[9]. What makes this exploitable is that C and C++ do not perform bounds-checking by default when accessing an array. In addition, we have full control over what ID is sent to this line of code. So by providing a value outside the bounds of this array, such as negative values, we can modify any memory throughout the program. Our goal is to determine how many bytes before or after command_log is lock_state located. By knowing this, we will be able to determine the correct ID to use in order to modify the lock_state value. To assist in our analysis, we can compile the provided source code using g++ and debug it using gdb. But before doing this, we uncomment lines 157 and 158 to display the memory addresses for lock_state and command_log when we run the program. 1 2 3 4 5 6 7 $ g++ parser.c $ ./a.out Address of lock_state: 0x56070625c130 Address of command_log: 0x56070625c138 Trying to bind to socket. Bound to socket. Looking at this, we can see that lock_state is only 8 bytes behind command_log. So by sending an ID value of -8, we will be able to increment the lock_state variable by 1 on every command. The issue right now is that we can only increase the value of lock_state. Since lock_state starts at 1, we will need to overflow this byte in order to reach our desired value of 0. Thankfully, command_log is defined as an array of char values, so its max value is only 255. One thing to note is that until now, we’ve only been directly typing input for the server into a nc session. However, since the server only looks at the underlying bytes it receives, it’ll interpret our “-8” as 0x382d0000. So to send a properly formatted payload, we will need to create a simple Python script to construct our message at the byte-level and send it to the server. This is a very simple task using pwntools. 1 2 3 4 5 6 from pwn import * io = remote(&#39;0.0.0.0&#39;, 54321, typ=&#39;udp&#39;) io.send( p16(1) + p16(1) + p32(-8, sign=&#39;signed&#39;) ) print(io.recvline()) print(io.recvline()) Using this script, we can validate the exploitation method by examining the server’s memory with gdb. In the following demo, we send the malicious command_header a few times to demonstrate how we’re able to increment the lock_state variable. The next demo shows how the value overflows after 255 commands. Finally, we can send our GETKEYS command and retrieve the flag from the server. The following demo shows us running the final exploit script (forest.py):","@type":"BlogPosting","headline":"Hack-A-Sat 2: tree in the forest","dateModified":"2021-06-29T22:00:00-10:00","datePublished":"2021-06-29T22:00:00-10:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bernardsmith0892.github.io/posts/hackasat2-forest/"},"url":"https://bernardsmith0892.github.io/posts/hackasat2-forest/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <title>Hack-A-Sat 2: tree in the forest | Bernard Smith
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Bernard Smith">
<meta name="application-name" content="Bernard Smith">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScripts -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  <script defer
    src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>

  <!--
  JS selector for site.
-->


  



  <!-- image lazy-loading & popup -->
  <script async
    src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>






</head>


  <body data-spy="scroll" data-target="#toc">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">

  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        <img src="/assets/imgs/avatar.jpg" alt="avatar" onerror="this.style.display='none'">
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Bernard Smith</a>
    </div>

    <div class="site-subtitle font-italic">Security and commo-related posts</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">
    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i>
        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i>
        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/projects/" class="nav-link">
        <i class="fa-fw fas fa-code ml-xl-3 mr-xl-3 unloaded"></i>
        <span>PROJECTS</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center">

    
      

      
      <a href="https://github.com/bernardsmith0892" aria-label="github"
        
        target="_blank" rel="noopener">
        <i class="fab fa-github-alt"></i>
      </a>
      

    
      

      
      <a href="https://twitter.com/BernardSmith892" aria-label="twitter"
        
        target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
      

    
      

      
      <a href="https://linkedin.com/in/bernard-smith-27324257/" aria-label="linkedin"
        
        target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['mail','brndjsmith.net'].join('@')" aria-label="email"
        
        target="_blank" rel="noopener">
        <i class="fas fa-envelope"></i>
      </a>
      

    

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          

        

      

        
        <span>
          
          
          <a href="/">
            Posts
          </a>
        </span>

        

      

        
          <span>Hack-A-Sat 2: tree in the forest</span>

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->


<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->


<!-- Add attribute 'hide-bullet' to the checkbox list -->




<!-- return -->
<div class="row">

  <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">

    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

      <h1 data-toc-skip>Hack-A-Sat 2: tree in the forest</h1>

      <div class="post-meta text-muted d-flex flex-column">
        <!-- Published date and author -->
        <div>
          <span class="semi-bold">
            Bernard Smith
          </span>
          <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago "
  
    data-toggle="tooltip"
    data-placement="bottom"
    title="Tue, 29 Jun 2021, 22:00 HST"
  

  
  prep="on" >

  
  

  
    29 Jun
  

  <i class="unloaded">2021-06-29T22:00:00-10:00</i>

</span>

        </div>

        <div>
          <!-- lastmod -->
          

          <!-- read time -->
          <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->


<!-- words per minute  -->







<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom" title="760 words">4 min</span>


          <!-- page views -->
          

        </div>

      </div> <!-- .post-meta -->

      <div class="post-content">

        

        <h1 id="tree-in-the-forest-rapid-unplanned-disassembly">tree in the forest (Rapid Unplanned Disassembly)</h1>

<p>Upon connecting to the challenge and providing our ticket, we’re presented with a simple message.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Starting up Service on udp:18.222.149.188:12752
</pre></td></tr></tbody></table></code></div></div>

<p>We can connect to this server using <code class="language-plaintext highlighter-rouge">nc -u 18.222.149.188 12752</code> and see what the challenge looks like. After experimenting with a bit of random input, we can quickly see that the server is expecting <em>8 bytes</em> of input.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>$ nc -u 18.222.149.188 12752
555555
Invalid length of command header, expected 8 but got 7
5555555
Command header acknowledge: version:13621 type:13621 id:171259189
Invalid id:171259189
55555555
Command header acknowledge: version:13621 type:13621 id:892679477
Invalid id:892679477
</pre></td></tr></tbody></table></code></div></div>

<p>The challenge page provides us with the source code (<a href="https://bernardsmith0892.github.io/assets/files/parser.c"><code class="language-plaintext highlighter-rouge">parser.c</code></a>) for this server, which easily illuminates what’s going on. The server is expecting us to provide a <code class="language-plaintext highlighter-rouge">command_header</code> struct composed of three values:</p>

<ul>
  <li>A 16-bit integer for the version of the command. Not used within the program.</li>
  <li>A 16-bit integer for the type of the command.  Not used within the program.</li>
  <li>A 32-bit integer for the ID of the command. This is the only value used by the program. Valid IDs are defined within the <code class="language-plaintext highlighter-rouge">command_id_type</code> enum.</li>
</ul>

<p>Looking through the possible IDs, the most interesting one is <code class="language-plaintext highlighter-rouge">COMMAND_GETKEYS</code> with an ID of 9. This command is what will order the server to print out the flag. However, the server has locked down this functionality on startup using a variable <code class="language-plaintext highlighter-rouge">lock_state</code> initialized to <code class="language-plaintext highlighter-rouge">LOCKED</code> - a value of 1. Until we can set this variable to 0, the server will refuse to print out the flag.</p>

<p>After analyzing the source code for this server, we discover the vulnerable portion of this code on line 134, which is:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// Log the message in the command log</span>
<span class="n">command_log</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Under normal operations, this array is simply used to track how many times a certain command ID has been received. For instance, to see how many times <code class="language-plaintext highlighter-rouge">COMMAND_GETKEYS</code> has been issued, we would access <code class="language-plaintext highlighter-rouge">command_log[9]</code>. What makes this exploitable is that <strong>C</strong> and <strong>C++</strong> do not perform bounds-checking by default when accessing an array. In addition, we have full control over what ID is sent to this line of code. So by providing a value outside the bounds of this array, such as negative values, we can modify any memory throughout the program.</p>

<p>Our goal is to determine how many bytes before or after <code class="language-plaintext highlighter-rouge">command_log</code> is <code class="language-plaintext highlighter-rouge">lock_state</code> located. By knowing this, we will be able to determine the correct ID to use in order to modify the <code class="language-plaintext highlighter-rouge">lock_state</code> value. To assist in our analysis, we can compile the provided source code using <code class="language-plaintext highlighter-rouge">g++</code> and debug it using <code class="language-plaintext highlighter-rouge">gdb</code>. But before doing this, we uncomment lines 157 and 158 to display the memory addresses for <code class="language-plaintext highlighter-rouge">lock_state</code> and <code class="language-plaintext highlighter-rouge">command_log</code> when we run the program.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>$ g++ parser.c

$ ./a.out
Address of lock_state:       0x56070625c130
Address of command_log: 0x56070625c138
Trying to bind to socket.
Bound to socket.
</pre></td></tr></tbody></table></code></div></div>

<p>Looking at this, we can see that <code class="language-plaintext highlighter-rouge">lock_state</code> is only 8 bytes behind <code class="language-plaintext highlighter-rouge">command_log</code>. So by sending an ID value of -8, we will be able to increment the <code class="language-plaintext highlighter-rouge">lock_state</code> variable by 1 on every command. The issue right now is that we can only <em>increase</em> the value of <code class="language-plaintext highlighter-rouge">lock_state</code>. Since <code class="language-plaintext highlighter-rouge">lock_state</code> starts at 1, we will need to <em>overflow</em> this byte in order to reach our desired value of 0. Thankfully, <code class="language-plaintext highlighter-rouge">command_log</code> is defined as an array of <code class="language-plaintext highlighter-rouge">char</code> values, so its max value is only 255.</p>

<p>One thing to note is that until now, we’ve only been directly typing input for the server into a <code class="language-plaintext highlighter-rouge">nc</code> session. However, since the server only looks at the underlying bytes it receives, it’ll interpret our “-8” as <code class="language-plaintext highlighter-rouge">0x382d0000</code>. So to send a properly formatted payload, we will need to create a simple Python script to construct our message at the byte-level and send it to the server. This is a very simple task using <code class="language-plaintext highlighter-rouge">pwntools</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="mi">54321</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s">'udp'</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="n">send</span><span class="p">(</span> <span class="n">p16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s">'signed'</span><span class="p">)</span> <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Using this script, we can validate the exploitation method by examining the server’s memory with <code class="language-plaintext highlighter-rouge">gdb</code>. In the following demo, we send the malicious <code class="language-plaintext highlighter-rouge">command_header</code> a few times to demonstrate how we’re able to increment the <code class="language-plaintext highlighter-rouge">lock_state</code> variable.</p>

<script id="asciicast-cnSjOv7IP0MIXkBp7hoyh11VU" src="https://asciinema.org/a/cnSjOv7IP0MIXkBp7hoyh11VU.js" async=""></script>

<p>The next demo shows how the value overflows after 255 commands.</p>

<script id="asciicast-2AfnwYOQjo8awlTQpwTXMaTRn" src="https://asciinema.org/a/2AfnwYOQjo8awlTQpwTXMaTRn.js" async=""></script>

<p>Finally, we can send our <code class="language-plaintext highlighter-rouge">GETKEYS</code> command and retrieve the flag from the server. The following demo shows us running the final exploit script (<a href="https://bernardsmith0892.github.io/assets/files/forest.py"><code class="language-plaintext highlighter-rouge">forest.py</code></a>):</p>

<script id="asciicast-3NviNO3HUdzmcZoNWw4MhhO8w" src="https://asciinema.org/a/3NviNO3HUdzmcZoNWw4MhhO8w.js" async=""></script>



      </div>

      <div class="post-tail-wrapper text-muted">

        <!-- categories -->
        
        <div class="post-meta mb-3">
          <i class="far fa-folder-open fa-fw mr-1"></i>
          
            <a href='/categories/ctf/'>CTF</a>,
            <a href='/categories/hackasat2/'>HackASat2</a>
        </div>
        

        <!-- tags -->
        
        <div class="post-tags">
          <i class="fa fa-tags fa-fw mr-1"></i>
          
          <a href="/tags/reverse-engineering/"
            class="post-tag no-text-decoration" >reverse_engineering</a>
          
          </div>
        

        <div class="post-tail-bottom
          d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
          
          <div class="license-wrapper">
            This post is licensed under
            <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>
            by the author.
          </div>
          

          <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=Hack-A-Sat 2: tree in the forest - Bernard Smith&url=https://bernardsmith0892.github.io/posts/hackasat2-forest/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=Hack-A-Sat 2: tree in the forest - Bernard Smith&u=https://bernardsmith0892.github.io/posts/hackasat2-forest/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://bernardsmith0892.github.io/posts/hackasat2-forest/" data-toggle="tooltip" data-placement="top"
          title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin">
          <i class="fa-fw fab fa-linkedin"></i>
        </a>
    

    <i class="fa-fw fas fa-link small" onclick="copyLink()"
        data-toggle="tooltip" data-placement="top" title="Copy link"></i>

  </span>
</div>


        </div><!-- .post-tail-bottom -->

      </div><!-- div.post-tail -->

    </div> <!-- .post -->


  </div> <!-- #post-wrapper -->

  

  

  <!--
  The Pannel on right side (Desktop views)
-->

<div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

  <div class="access">

  














  

  















  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



  
    <div id="access-tags">
      <span>Trending Tags</span>
      <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

      
        
        <a class="post-tag" href="/tags/cryptography/">cryptography</a>
      
        
        <a class="post-tag" href="/tags/reverse-engineering/">reverse_engineering</a>
      

      </div>
    </div>
  
  </div> <!-- .access -->

  

</div> <!-- #panel-wrapper -->


</div> <!-- .row -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/posts/acictf4-rotateme/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    13 May 2020
  

  <i class="unloaded">2020-05-13T00:00:00-10:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>All-Army CyberStakes 4 - Cryptography (Rotate Me)</h3>
            <div class="text-muted small">
              <p>
                





                Rotate Me (5 Points)

This one is a very simple problem, especially considering it’s only worth 5 points. We start with a text file that contains enciphered text, which already seems to be in the e...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/acictf4-rsa/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    14 May 2020
  

  <i class="unloaded">2020-05-14T01:00:00-10:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>All-Army CyberStakes 4 - Cryptography (Really Senseless Admins)</h3>
            <div class="text-muted small">
              <p>
                





                Really Senseless Admins (35 Points)

Here, we are provided with two files: flag.enc, containing a very large decimal number, and params.txt, containing three decimal numbers, p, q, and e. Based on ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/posts/acictf4-otp/">
          <div class="card-body">
            <!--
  Date format snippet
  See: /assets/js/_utils/timeage.js
-->





<span class="timeago small"
  

  
   >

  
  

  
    15 May 2020
  

  <i class="unloaded">2020-05-15T02:00:00-10:00</i>

</span>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>All-Army CyberStakes 4 - Cryptography (Over Time: Paid)</h3>
            <div class="text-muted small">
              <p>
                





                Over Time: Paid (50 Points)

This is where the challegnes start getting more difficult. This problem starts with two files again: document.encrypted, which contains 15 lines of hex, and source.py, ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->



    <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/posts/acictf4-headpiece-silver/" class="btn btn-outline-primary"
    prompt="Older">
    <p>All-Army CyberStakes 4 - Cryptography (Headpiece Silver)</p>
  </a>
  

  
  <span class="btn btn-outline-primary disabled"
    prompt="Newer">
    <p>-</p>
  </span>
  

</div>


    

    </div> <!-- #post-extend-wrapper -->

  </div> <!-- .col-* -->

</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center">
    <div class="footer-left">
      <p class="mb-0">
        © 2021
        <a href="https://twitter.com/BernardSmith892">Bernard Smith</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        Powered by
        <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
        with
        <a href="https://github.com/cotes2020/jekyll-theme-chirpy"
          target="_blank" rel="noopener">Chirpy</a>
        theme.
      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      <h4 class="text-muted mb-4">Trending Tags</h4>

      















  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        



      
        
        <a class="post-tag" href="/tags/cryptography/">cryptography</a>
      
        
        <a class="post-tag" href="/tags/reverse-engineering/">reverse_engineering</a>
      

    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="https://bernardsmith0892.github.io{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


  </body>

</html>

