



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>Appendices - SANS 2018 Holiday Hack Challenge Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#a-google-ventilation-maze" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="SANS 2018 Holiday Hack Challenge Guide" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                SANS 2018 Holiday Hack Challenge Guide
              </span>
              <span class="md-header-nav__topic">
                Appendices
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="SANS 2018 Holiday Hack Challenge Guide" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    SANS 2018 Holiday Hack Challenge Guide
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../main/" title="Main Objectives" class="md-nav__link">
      Main Objectives
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../terminals/" title="Terminal Exercises" class="md-nav__link">
      Terminal Exercises
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Appendices
      </label>
    
    <a href="./" title="Appendices" class="md-nav__link md-nav__link--active">
      Appendices
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a-google-ventilation-maze" title="A. Google Ventilation Maze" class="md-nav__link">
    A. Google Ventilation Maze
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#b-wannacookie-malware-analysis" title="B. Wannacookie Malware Analysis" class="md-nav__link">
    B. Wannacookie Malware Analysis
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a-google-ventilation-maze" title="A. Google Ventilation Maze" class="md-nav__link">
    A. Google Ventilation Maze
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#b-wannacookie-malware-analysis" title="B. Wannacookie Malware Analysis" class="md-nav__link">
    B. Wannacookie Malware Analysis
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Appendices</h1>
                
                <h3 id="a-google-ventilation-maze">A. Google Ventilation Maze<a class="headerlink" href="#a-google-ventilation-maze" title="Permanent link">&para;</a></h3>
<p>Previously, we found two ventilation maps during Challenge 4. By using these maps, we can navigate within the building's vents in order to access the Santa's Secret Room without hacking the badge scanner in Challenge 6. We can access the vents through the grate next to Google's booth in the entrance-way on the first floor.</p>
<p><img alt="Location" src="../vent/vent-location.png" /></p>
<p>After clicking on the vent, we are greeted with an instructional screen and a 3D-maze.</p>
<p><img alt="Maze Instructions" src="../vent/vent-maze.png" /></p>
<p>By using these maps, we can navigate our way through both floors in order to reach Santa's Secret Room.</p>
<p><img alt="Map 1F" src="../vent/ventilation_diagram_1F.jpg" /></p>
<p><img alt="Map 2F" src="../vent/ventilation_diagram_2F.jpg" /></p>
<p>Despite having a map, it becomes very easy to lose our heading and our current location. However, we can use <em>Chrome's DevTools</em> to see both of these in order to ensure we don't get lost. Each movement sends a POST request to https://vents.kringlecastle.com/move, which replies back with several files that the client browser uses to draw the current location and heading. By examining the response file named <code>move</code>, we can find our heading, X and Y location, and current floor as values in the file.</p>
<p><img alt="DevTools" src="../vent/vent-devtools.png" /></p>
<p>Starting from the bottom right of the first floor, the proper route of each floor is:</p>
<p><img alt="Solution 1F" src="../vent/ventilation_diagram_1F-solved.jpg" /></p>
<p><img alt="Solution  2F" src="../vent/ventilation_diagram_2F-solved.jpg" /></p>
<h3 id="b-wannacookie-malware-analysis">B. Wannacookie Malware Analysis<a class="headerlink" href="#b-wannacookie-malware-analysis" title="Permanent link">&para;</a></h3>
<p><em>Wannacookie</em> is a highly-targeted form of ransomware aimed at two specific targets: Computers on the <code>KRINGLECASTLE</code> domain, and <code>.elfdb</code> files. This makes the malware fairly harmless to any other system. However, it uses a novel form of command and control (CnC) to transfer binary data through domain name system (DNS) requests, which still makes this an interesting piece of malware to analyze.</p>
<p>Provided is a high-level walkthrough of <em>Wannacookie's</em> infection and destruction process. The detailed analysis follows this chart.</p>
<p><img alt="Wannacookie Flowchart" src="../wannacookie/wc-flowchart.svg" /></p>
<p>To fully analyze the behavior of <em>Wannacookie</em>, we first spin up a Windows 10 virtual machine to see the execution of the malware in a controlled environment. We will run the <em>PowerShell</em> script directly, rather than from the <code>CHOCOLATE_CHIP_COOKIE_RECIPE.docm</code> file since this VM doesn't have access to <em>Microsoft Word</em>.
There are several factors to <em>Wannacookie</em> that makes it relatively safe to analyze:</p>
<ul>
<li>It does not seek out other computers to infect, so it's not virulent.</li>
<li>It only targets files with the <code>.elfdb</code> extension, which is designed solely for the purpose of the <em>SANS Holiday Hack Challenge 2018</em> and not used for real-world data.</li>
</ul>
<p>Our first attempt to run <em>Wannacookie</em> fails since we are not on a <code>KRINGLECASTLE</code> domain. In order to allow us to see its full execution, we remove the safety switch.</p>
<p><img alt="Running" src="../wannacookie/wc-running.png" /></p>
<p>During the malware's execution, it retrieves data over the DNS in a novel way. It first makes a request to the DNS CnC server with a hex-encoded string as the subdomain. If it's requesting a file, then the server responds with a length value within the TXT record. Due to the limitations of DNS records, the server can only reply with 254-char, or 127-byte, chunks. Thus, the malware uses the initial length value to know how many requests it needs to make to retrieve the full file. After retrieving the length value, the malware makes several DNS requests, in sequence, with the format of: <code>&lt;chunk_number&gt;.&lt;requested_file&gt;.erohetfanu.com</code>. The <code>chunk_number</code> increments from 0 to one less than the specified length from before. For each request, the server replies with a portion of the file as a hex string within the TXT record. Upon completing all DNS requests, the malware has downloaded the full file from the CnC server.</p>
<p><img alt="A DNS Download" src="../wannacookie/wc-dnsdownload.png" /></p>
<p>The script takes the following actions:</p>
<ol>
<li>
<p>Performs the killswitch check. The malware generates a domain to lookup through several novel techniques that attempt to obfuscate its methods and the resulting domain name.</p>
<ul>
<li>It first retreives a hex string from the TXT record of <code>6B696C6C737769746368.erohetfanu.com</code> (the hex subdomain translating to <code>killswitch</code>), which is an encrypted value that contains the killswitch domain name: <code>66667272727869657268667865666B73</code></li>
<li>Another variable, <code>$S1</code>, contains a hex string of gzip data that the malware translates all the way to the hex-values of its unzipped contents; an XOR key for the previous value: <code>1f0f0202171d020c0b09075604070a0a</code></li>
<li>Finally, the script performs an XOR operation between the two values to decrypt the domain name used as a killswitch: <code>yippeekiyaa.aaay</code></li>
<li>The script attempts to resolve this domain name and if successful, halts further operation.</li>
</ul>
</li>
<li>
<p>Checks if the target is within the <code>KRINGLECASTLE</code> domain and has TCP port 8080 open on localhost. If either of these are not true, then the script exits.</p>
</li>
<li>
<p>Retrieves the CnC server's public key via DNS. This request is formatted as:</p>
<ul>
<li><code>7365727665722E637274.erohetfanu.com</code>. The subdomain is hex, which translates to <code>server.crt</code>. The server replys in the TXT record with how many subsequent requests the script should make.</li>
</ul>
</li>
<li>
<p>Generates a random, 256-bit encryption key along with a SHA1 hash of a hex version of that key.</p>
</li>
<li>
<p>Encrypts the key with the server's public key and sends it to the CnC server over DNS. After asymmetric encryption, the key ends up being 2048-bits long. After the first submission, the CnC server sends back a random, 20-byte ID number for that key, known by the program as a "Cookie ID".</p>
<ul>
<li>Based upon limits of DNS requests, the script breaks up the encrypted key into 128-bit (32 char) chunks and sends each chunk sequentially.</li>
<li>The DNS requests are formatted like:<ul>
<li>First chunk as <code>chunk.6B6579666F72626F746964.erohetfanu.com</code>. Where the hex translates to <code>keyforbotid</code>. In return, the server provides the 20-byte "Cookie ID" within the TXT record.</li>
<li>All subsequent chunks as <code>cookie_id.chunk.6B6579666F72626F746964.erohetfanu.com</code>. The server replys with a blank TXT record for these requests.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Afterwards, it creates a timestamp of the current time in order to serve a deadline for the victim with the ransom note.</p>
</li>
<li>
<p>It then gathers a list of files with the <code>.elfdb</code> file extension within the Desktop, Documents, Videos, Pictures, and Music folders for that user, additionally ignoring files with <code>.wannacookie</code> as an extension.</p>
</li>
<li>
<p>Using that file list, the script encrypts each file using the generated key in AES CBC mode, while also generating the IV for that file.</p>
<ul>
<li>The IV's length is stored within the first four bytes (a 32-bit integer) of the encrypted file, with the actual IV following it, in order to allow the script to later decrypt it with only the key.</li>
</ul>
</li>
<li>
<p>After completing the encryption process, it retrieves an HTML file from the CnC server via DNS and starts a local HTTP server on port 8080. This server provides the ransom note to the victim and instructions on how to pay and decrypt their files.</p>
</li>
</ol>
<p>We notice the file's execution taking an exceptionally long amount of time, this is due to the malware downloading <code>source.min.html</code> over DNS from <code>erohetfanu.com</code>, and then having to translate it to ASCII. After completing the decoding process, the script starts an HTTP server on port 8080.</p>
<p><img alt="Ransom" src="../wannacookie/wc-ransomnote.png" /></p>
<p>The ransom note application checks for payment upon every refresh via the <code>cookie_is_paid</code> resource. This causes the application to send a DNS request to the CnC server in the format of <code>cookie_id.72616e736f6d697370616964.erohetfanu.com</code>. The CnC server replies with a hex string in the TXT record that translates to <code>False</code>. By analyzing the script, we see that the server would reply with a 32 character hex-string if it believes its been paid, which is most likely the encryption key.</p>
<p>The decrypt function uses the previously calculated SHA-1 hash to check if the victim enters the correct key. If it validates the key, then it gathers all <code>.wannacookie</code> files and performs the decryption process. Since we recorded the network traffic during the exploitation process and have the server's private key in hand, we can simply decrypt the submitted key and perform the decryption process, without checking for payment with the CnC server.</p>
<p><img alt="Key Send Traffic" src="../wannacookie/wc-encryptedkeysend.png" /></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ cat VM_encrypted_key.txt
008f9236b701c97fcdbd159d1c189a9841e85a73c8a8a7e69dae459e50ec0101a71
f00c9cf0bc59c04065085da7d5fa2e1f748fe9ff8fc77fe09510f0e8496c062fe20
e30b4e614000e9e2befe126b4fcea88adc602c05041a4c74344eb7bedd46f4ccbca
beb1fc54b8fb1ab519b35a2348ee4c7368db8561eb0488894975466e7b2415617a4
4175b9a1745cfed6b2dfebc2c5eec4ada3b3a78910384be7d074dd5f08ea87a6f9e
4107df89b1d1fdd9da7b7110d0c29ff443e7e7259e3ac6e3755f635690f8c71529f
67998d0aa3d159ce9d14789022c55de0e3991cee7c2fb103dc01db82d4b4516b6ac
4b96bb37809477f2d509823612a6cdc853471816fde

bernard@Bernard-PC:~/NetsecStudy/sans2018$ cat VM_encrypted_key.txt | xxd -r -p &gt; VM_encrypted_key.key

bernard@Bernard-PC:~/NetsecStudy/sans2018$ openssl rsautl -decrypt -oaep -in VM_encrypted_key.key -out VM_key.key -inkey server.key

bernard@Bernard-PC:~/NetsecStudy/sans2018$ ls -lah VM_key.key
-rwxrwxrwx 1 bernard bernard 16 Dec 28 15:42 VM_key.key

bernard@Bernard-PC:~/NetsecStudy/sans2018$ xxd -p VM_key.key
c5a6236a762ecfbf935b428d43eae4c7
</code></pre>

<p>Now, by submitting <code>c5a6236a762ecfbf935b428d43eae4c7</code> as the decrypt key into the <em>Wannacookie</em> application, we can initiate the decryption process and recover our file.</p>
<p><img alt="Input Key" src="../wannacookie/wc-keydecryption.png" /></p>
<p><img alt="Decryption" src="../wannacookie/wc-decrypted.png" /></p>
<p>After completing the decryption process, the script ends and shuts down the HTTP server.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../terminals/" title="Terminal Exercises" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Terminal Exercises
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/bernardsmith0892/" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/BernardSmith892" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/bernard-smith-27324257/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>